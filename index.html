<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="google-adsense-account" content="ca-pub-7977942731354565">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

    <meta name="google-site-verification" content="FaJrk8fMNmvhnE6pImDpOW08No9C7fbGzOGX5zJhJ7M" />
    
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="favicon-192x192.png">
    
    <!-- SEO Meta Tags OPTIMIZADOS -->
    <title>Dashboard Forex | An√°lisis Fundamental en Tiempo Real 2026 | Indicadores Econ√≥micos USD EUR GBP JPY</title>
    <meta name="description" content="Dashboard profesional de an√°lisis fundamental forex 2026 con 18 indicadores econ√≥micos en tiempo real, datos de bancos centrales FRED CFTC, rankings de fortaleza USD EUR GBP JPY AUD CAD CHF NZD. Herramienta para traders.">
    <meta name="keywords" content="dashboard forex 2026, an√°lisis fundamental forex, indicadores econ√≥micos tiempo real, fortaleza divisas USD EUR GBP, datos bancos centrales, tasas inter√©s forex, PIB inflaci√≥n desempleo, trading forex herramientas, an√°lisis t√©cnico fundamental, COT positioning forex, carry trade calculator, forex strength meter, currency analysis dashboard, central bank rates live">
    <meta name="author" content="Santiago Pl√°">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <link rel="canonical" href="https://globalinvesting.github.io/">
    
    <!-- Hreflang para SEO multiidioma (futuro) -->
    <link rel="alternate" hreflang="es" href="https://globalinvesting.github.io/" />
    <link rel="alternate" hreflang="x-default" href="https://globalinvesting.github.io/" />
    
    <!-- Open Graph / Facebook OPTIMIZADO -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://globalinvesting.github.io/">
    <meta property="og:site_name" content="Global Investing Forex Dashboard">
    <meta property="og:title" content="Dashboard Forex Profesional | An√°lisis Fundamental en Tiempo Real 2026">
    <meta property="og:description" content="Herramienta de an√°lisis fundamental forex con 18 indicadores econ√≥micos en tiempo real. Rastrea PIB, inflaci√≥n, tasas de inter√©s, balanza comercial y posicionamiento COT para USD, EUR, GBP, JPY, AUD, CAD, CHF, NZD.">
    <meta property="og:image" content="https://globalinvesting.github.io/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Dashboard de An√°lisis Fundamental Forex - Global Investing">
    <meta property="og:locale" content="es_ES">
    
    <!-- Twitter Card OPTIMIZADO -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://globalinvesting.github.io/">
    <meta name="twitter:title" content="Dashboard Forex Profesional | An√°lisis Fundamental Tiempo Real">
    <meta name="twitter:description" content="Herramienta: 18 indicadores econ√≥micos en tiempo real para USD EUR GBP JPY AUD CAD CHF NZD. Datos FRED, CFTC, Trading Economics.">
    <meta name="twitter:image" content="https://globalinvesting.github.io/og-image.png">
    <meta name="twitter:image:alt" content="Dashboard Forex - Indicadores Econ√≥micos en Tiempo Real">
    <meta name="twitter:creator" content="@GlobalInvesting">
    <meta name="twitter:site" content="@GlobalInvesting">
    
    <!-- SEO T√©cnico Adicional -->
    <meta name="theme-color" content="#0b0e14">
    <meta name="application-name" content="Forex Dashboard">
    <meta name="apple-mobile-web-app-title" content="Forex Dashboard">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Schema.org JSON-LD para Rich Snippets -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Dashboard de An√°lisis Fundamental Forex",
      "alternateName": "Forex Dashboard Global Investing",
      "url": "https://globalinvesting.github.io/",
      "description": "Dashboard profesional de an√°lisis fundamental forex con 18 indicadores econ√≥micos en tiempo real, datos de bancos centrales y rankings de fortaleza de divisas.",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "18 indicadores econ√≥micos en tiempo real",
        "Datos de bancos centrales FRED y CFTC",
        "Rankings de fortaleza de divisas",
        "Mapa de calor econ√≥mico con 18 columnas",
        "Calendario econ√≥mico din√°mico",
        "Posicionamiento COT (CFTC oficial)",
        "An√°lisis de 8 divisas principales",
        "Bonos soberanos 10Y y flujos de capital",
        "Confianza del consumidor y empresarial"
      ],
      "browserRequirements": "Requires JavaScript. Requires HTML5.",
"creator": {
  "@type": "Person",
  "name": "Santiago Pl√°",
        "url": "https://globalinvesting.github.io/",
        "logo": "https://globalinvesting.github.io/favicon.png"
      },
      "datePublished": "2026-02-14",
      "inLanguage": "es-ES",
      "about": {
        "@type": "Thing",
        "name": "Forex Trading",
        "sameAs": "https://en.wikipedia.org/wiki/Foreign_exchange_market"
      }
    }
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7977942731354565"
     crossorigin="anonymous"></script>
    
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0b0e14;
            --bg-secondary: #13171f;
            --bg-card: #1a1f2e;
            --bg-elevated: #20253a;
            
            --green-strong: #26a69a;
            --green-medium: #00897b;
            --green-weak: #00695c;
            --red-strong: #ef5350;
            --red-medium: #e53935;
            --red-weak: #c62828;
            --neutral: #607d8b;
            --orange: #ff6f00;
            --blue: #1e88e5;
            
            --text-primary: #e1e4e8;
            --text-secondary: #8b949e;
            --text-tertiary: #6e7681;
            
            --border: #30363d;
            --border-hover: #484f58;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Estilo para banderas con fallback */
        .flag-emoji {
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            font-size: inherit;
            line-height: inherit;
        }

        .app-container {
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1.25rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-title {
            font-size: 1.125rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .brand-subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 2rem;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-live {
            width: 8px;
            height: 8px;
            background: var(--green-strong);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-loading {
            width: 8px;
            height: 8px;
            background: var(--orange);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .page-nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .page-nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .page-nav-links a:hover {
            color: var(--text-primary);
        }

        .nav-tabs {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
            display: flex;
            gap: 0.5rem;
            max-width: 1800px;
            margin: 0 auto;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        .nav-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--blue);
        }

        .content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .section-meta {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* Loading indicator */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            gap: 1.5rem;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--blue);
            transition: width 0.3s ease;
        }

        /* Heatmap */
        .heatmap-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-x: auto;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1050px;
        }

        .heatmap-table th {
            background: var(--bg-card);
            padding: 0.75rem 0.4rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.68rem;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            color: var(--text-primary);
            white-space: nowrap;
            position: relative;
        }

        .heatmap-table th:first-child {
            text-align: left;
            padding-left: 1.5rem;
            min-width: 200px;
            border-right: 2px solid var(--border);
        }

        .heatmap-table th:last-child {
            border-right: none;
        }

        .heatmap-table td {
            padding: 0.85rem 0.35rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .heatmap-table td:first-child {
            text-align: left;
            background: var(--bg-card);
            padding-left: 1.5rem;
            border-right: 2px solid var(--border);
        }

        .heatmap-table td:last-child {
            border-right: none;
        }

        .heatmap-table tbody tr:last-child td {
            border-bottom: none;
        }

.heatmap-table tbody tr:hover td {
    background: var(--bg-elevated);
}

.heatmap-table tbody tr:hover td:not(:first-child) {
    color: var(--text-primary) !important;
}

.heatmap-table tbody tr:hover td .cell-value {
    color: var(--text-primary) !important;
}

        .heatmap-table tbody tr:hover td:first-child {
            background: var(--bg-elevated);
        }

        .country-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .country-flag {
            font-size: 1.5rem;
            line-height: 1;
        }

        .country-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .country-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .country-currency {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .cell-value {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 0.125rem;
        }

        .cell-suffix {
            display: block;
            font-size: 0.6rem;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        /* CORREGIDO: Sufijo en columnas espec√≠ficas */
        .cell-suffix-white {
            display: block;
            font-size: 0.6rem;
            color: var(--text-primary);
            font-weight: 400;
        }

/* Tooltips CORREGIDOS */
.tooltip-header {
    position: relative;
    cursor: help;
}

.tooltip-icon {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--blue);
    color: white;
    text-align: center;
    line-height: 16px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 6px;
    cursor: help;
    vertical-align: middle;
    transition: all 0.2s ease;
}

.tooltip-icon:hover {
    background: var(--green-strong);
    transform: scale(1.15);
}

.tooltip-box {
    display: none;
    position: fixed;
    background: var(--bg-elevated);
    color: var(--text-primary);
    padding: 1.25rem;
    border-radius: 8px;
    border: 2px solid var(--blue);
    font-size: 0.8125rem;
    line-height: 1.7;
    width: 340px;
    max-width: 90vw;
    z-index: 99999;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.9);
    font-weight: 400;
    text-align: left;
    white-space: normal;
    animation: tooltipFadeIn 0.3s ease;
    pointer-events: none;
}

@keyframes tooltipFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tooltip-box.visible {
    display: block;
}

.tooltip-box::before {
    content: '';
    position: absolute;
    top: -10px;
    left: 20px;
    transform: none;
    border: 10px solid transparent;
    border-top: none;
    border-bottom-color: var(--blue);
}

.tooltip-box::after {
    content: '';
    position: absolute;
    top: -8px;
    left: 22px;
    transform: none;
    border: 8px solid transparent;
    border-top: none;
    border-bottom-color: var(--bg-elevated);
}

/* Tooltip para celdas del heatmap - FIXED */
.heatmap-cell-tooltip {
    display: none;
    position: fixed;
    background: var(--bg-elevated);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    border-radius: 6px;
    border: 2px solid var(--blue);
    font-size: 0.75rem;
    z-index: 100000;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.9);
    pointer-events: none;
    white-space: nowrap;
    animation: tooltipFadeIn 0.2s ease;
}

.heatmap-cell-tooltip.visible {
    display: block;
}

.heatmap-cell-tooltip::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-bottom-color: var(--blue);
}

.heatmap-cell-tooltip::after {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-bottom-color: var(--bg-elevated);
    margin-bottom: -1px;
}

.tooltip-date {
    font-weight: 600;
    color: var(--green-strong);
    margin-right: 0.5rem;
}

.tooltip-indicator {
    color: var(--text-secondary);
}

/* CR√çTICO: Evitar que el hover afecte celdas adyacentes */
.heatmap-table td {
    position: relative;
    isolation: isolate;
}

.heatmap-table td[data-has-date="true"] {
    cursor: help;
}

.tooltip-header-title {
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--blue);
    font-size: 1rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
}

.tooltip-body {
    color: var(--text-secondary);
}

        /* Overall column styles */
        .overall-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .overall-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .overall-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Currency Cards */
        .currency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 1.5rem;
        }

        .currency-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .currency-card:hover {
            border-color: var(--border-hover);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            background: var(--bg-card);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .card-flag {
            font-size: 2rem;
            line-height: 1;
        }

        .card-currency-code {
            font-size: 1.125rem;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .card-currency-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .card-strength {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .strength-score {
            font-size: 1.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .strength-label {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        .central-bank {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .bank-label {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.375rem;
            font-weight: 600;
        }

        .bank-name {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .bank-info {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .bank-info-item {
            display: flex;
            flex-direction: column;
        }

        .bank-info-label {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            margin-bottom: 0.25rem;
        }

        .bank-info-value {
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric {
            background: var(--bg-elevated);
            padding: 0.875rem;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .metric-label {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.375rem;
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.125rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .metric-value-small {
            font-size: 0.875rem;
        }

        .analysis-section {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: 4px;
            border-left: 3px solid var(--blue);
        }

        .analysis-title {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .analysis-text {
            font-size: 0.875rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .sentiment-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sentiment-alcista {
            background: rgba(38, 166, 154, 0.15);
            color: var(--green-strong);
            border: 1.5px solid var(--green-strong);
        }

        .sentiment-bajista {
            background: rgba(239, 83, 80, 0.15);
            color: var(--red-strong);
            border: 1.5px solid var(--red-strong);
        }

        .sentiment-neutral {
            background: rgba(96, 125, 139, 0.15);
            color: var(--neutral);
            border: 1.5px solid var(--neutral);
        }

        .sentiment-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* Nuevas secciones - Charts */
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        /* Calendar econ√≥mico */
        .calendar-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .calendar-event {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .calendar-event:hover {
            background: var(--bg-elevated);
        }

        .calendar-event:last-child {
            border-bottom: none;
        }

        .event-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            min-width: 80px;
        }

        .event-details {
            flex: 1;
            padding: 0 1rem;
        }

        .event-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .event-country {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .event-impact {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .impact-high {
            background: rgba(239, 83, 80, 0.2);
            color: var(--red-strong);
        }

        .impact-medium {
            background: rgba(255, 111, 0, 0.2);
            color: var(--orange);
        }

        .impact-low {
            background: rgba(96, 125, 139, 0.2);
            color: var(--neutral);
        }

        /* Alertas */
        .alerts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .alert-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 3px solid var(--blue);
            border-radius: 6px;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-warning {
            background: rgba(255, 111, 0, 0.2);
            border-left-color: var(--orange);
        }

        .alert-success {
            background: rgba(38, 166, 154, 0.2);
            border-left-color: var(--green-strong);
        }

        .alert-info {
            background: rgba(30, 136, 229, 0.2);
            border-left-color: var(--blue);
        }

        .alert-content h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .alert-content p {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .footer {
            margin-top: 4rem;
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--border);
            color: var(--text-tertiary);
            font-size: 0.75rem;
        }

        .data-sources {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .source-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .source-link {
            color: var(--blue);
            text-decoration: none;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 1200px) {
            .currency-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 1rem;
    }

    .page-nav-links {
        order: -1;
    }

    .tooltip-box {
        width: 250px;
        font-size: 0.75rem;
    }

    /* Tendencias Hist√≥ricas */
    .chart-container {
        padding: 1rem;
    }

    .chart-wrapper {
        height: 280px;
    }

    /* Padding general m√°s compacto en m√≥vil */
    .content {
        padding: 1rem;
    }
}
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
        console.log('üöÄ Dashboard Forex v4 - Web Scraping Edition - Cargando...');

        const { useState, useEffect, useRef } = React;

    // ========== FIX 1: EDGE COMPATIBILITY - Polyfill mejorado ==========
if (!AbortSignal.timeout) {
    AbortSignal.timeout = function(ms) {
        const controller = new AbortController();
        setTimeout(() => controller.abort(new DOMException('Timeout', 'TimeoutError')), ms);
        return controller.signal;
    };
}

// Helper para fetch con timeout y retry logic
const fetchWithTimeout = async (url, options = {}, timeoutMs = 8000) => {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
    
    try {
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
};

// Fetch con retry autom√°tico
const fetchWithRetry = async (url, options = {}, maxRetries = 3) => {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            return await fetchWithTimeout(url, options, 8000);
        } catch (error) {
            const isLastAttempt = attempt === maxRetries;
            
            if (isLastAttempt) {
                console.error(`‚ùå Failed after ${maxRetries} attempts: ${url}`);
                throw error;
            }
            
            // Exponential backoff: 1s, 2s, 4s
            const delayMs = 1000 * Math.pow(2, attempt - 1);
            console.warn(`‚ö†Ô∏è Attempt ${attempt} failed, retrying in ${delayMs}ms...`);
            await delay(delayMs);
        }
    }
};

        // ========== SISTEMA DE CACH√â ==========
        
        const CACHE_CONFIG = {
            FOREX_RATES: 60000,
            ECONOMIC_DATA: 86400000,
            HISTORICAL_DATA: 604800000,
            CALENDAR: 3600000,
            CENTRAL_BANK_OUTLOOK: 604800000,
            ALERTS: 3600000
        };

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const CacheManager = {
            set: (key, data, expirationMs) => {
                try {
                    const item = { data, timestamp: Date.now(), expiration: expirationMs };
                    localStorage.setItem(`forex_dashboard_${key}`, JSON.stringify(item));
                    console.log(`‚úÖ Cached: ${key}`);
                } catch (error) {
                    console.warn('Cache storage failed:', error);
                }
            },
            get: (key) => {
                try {
                    const itemStr = localStorage.getItem(`forex_dashboard_${key}`);
                    if (!itemStr) return null;
                    const item = JSON.parse(itemStr);
                    if (Date.now() - item.timestamp > item.expiration) {
                        localStorage.removeItem(`forex_dashboard_${key}`);
                        return null;
                    }
                    return item.data;
                } catch (error) {
                    return null;
                }
            },
            clear: (key) => localStorage.removeItem(`forex_dashboard_${key}`),
            clearAll: () => {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('forex_dashboard_')) localStorage.removeItem(key);
                });
            }
        };

        // ========== CONFIGURACI√ìN ==========
        
        const API_CONFIG = {
            frankfurter: { baseUrl: 'https://api.frankfurter.app' }
        };

        const WORLD_BANK_INDICATORS = {
            gdp: 'NY.GDP.MKTP.CD',
            gdpGrowth: 'NY.GDP.MKTP.KD.ZG',
            inflation: 'FP.CPI.TOTL.ZG',
            unemployment: 'SL.UEM.TOTL.ZS',
            currentAccount: 'BN.CAB.XOKA.GD.ZS',
            debt: 'GC.DOD.TOTL.GD.ZS',
            tradeBalance: 'NE.RSB.GNFS.CD'
        };

        // ========== FALLBACK FUNCTIONS REMOVED ==========
        // All data now comes from GitHub Pages scraped JSON files
        // These functions are no longer needed as we use Trading Economics scraping

const fetchWorldBankData = async (countryCode, indicator) => {
    const cacheKey = `scraped_${countryCode}_${indicator}`;
    const cached = CacheManager.get(cacheKey);
    if (cached !== null) return cached;

    try {
        const githubUrl = `https://globalinvesting.github.io/economic-data/${countryCode}.json`;
        
        const response = await fetchWithRetry(githubUrl, { 
            cache: 'no-cache',
            mode: 'cors'
        }, 3); // ‚úÖ CORREGIDO
        
        if (response.ok) {
            const scrapedData = await response.json();
            
            if (scrapedData.data) {
                const indicatorMap = {
                    [WORLD_BANK_INDICATORS.gdp]: 'gdp',
                    [WORLD_BANK_INDICATORS.gdpGrowth]: 'gdpGrowth',
                    [WORLD_BANK_INDICATORS.inflation]: 'inflation',
                    [WORLD_BANK_INDICATORS.unemployment]: 'unemployment',
                    [WORLD_BANK_INDICATORS.currentAccount]: 'currentAccount',
                    [WORLD_BANK_INDICATORS.debt]: 'debt',
                    [WORLD_BANK_INDICATORS.tradeBalance]: 'tradeBalance'
                };
                
                const scrapedKey = indicatorMap[indicator];
                if (scrapedKey && scrapedData.data[scrapedKey] !== undefined) {
                    const value = scrapedData.data[scrapedKey];
                    
                    let finalValue = value;
                    if (scrapedKey === 'gdp') {
                        finalValue = value / 1000;
                    } else if (scrapedKey === 'tradeBalance') {
                        finalValue = value;
                    }
                    
                    console.log(`‚úÖ Scraped data for ${countryCode} ${scrapedKey}: ${finalValue}`);
                    CacheManager.set(cacheKey, finalValue, CACHE_CONFIG.ECONOMIC_DATA);
                    return finalValue;
                }
            }
        }
    } catch (error) {
        console.warn(`Scraped data fetch failed for ${countryCode}:`, error.message);
    }
    
    console.warn(`‚ùå No scraped data available for ${countryCode} ${indicator}`);
    return null;
};

const fetchInterestRate = async (country) => {
            const cacheKey = `interest_rate_${country.code}`;
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;

            console.log(`üîç Fetching interest rate for ${country.code}...`);

            // Estrategia principal: GitHub Pages JSON
            try {
                const githubUrl = `https://globalinvesting.github.io/rates/${country.code}.json`;
                
                const response = await fetchWithRetry(githubUrl, { 
                    cache: 'no-cache',
                    mode: 'cors'
                }, 3);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.observations && data.observations.length > 0) {
                        const latestObs = data.observations[0];
                        
                        if (latestObs.value && latestObs.value !== '.') {
                            const value = parseFloat(latestObs.value);
                            
                            if (!isNaN(value) && value >= -1 && value < 25) {
                                console.log(`‚úÖ GitHub Pages rate for ${country.code}: ${value}% (period: ${latestObs.date || 'N/A'})`);
                                const result = { rate: value, date: latestObs.date || null };
                                CacheManager.set(cacheKey, result, CACHE_CONFIG.ECONOMIC_DATA);
                                return result;
                            }
                        }
                    }
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.warn(`GitHub Pages failed for ${country.code}:`, error.message);
                }
            }

// Fallback: Alpha Vantage (solo USD)
if (country.code === 'USD') {
    const alphaKeys = ['2TW8Y8DDBPRQ2VTV', 'RIBXT3XYLI69O5WY'];
    
    for (const apiKey of alphaKeys) {
        try {
            const url = `https://www.alphavantage.co/query?function=FEDERAL_FUNDS_RATE&apikey=${apiKey}`;
            
            const response = await fetchWithRetry(url, { // ‚úÖ Usar 'url', no 'githubUrl'
                mode: 'cors'
            }, 2); // ‚úÖ Menos intentos para Alpha Vantage
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.data && data.data.length > 0) {
                                const value = parseFloat(data.data[0].value);
                                if (!isNaN(value) && value >= 0 && value < 25) {
                                    console.log(`‚úÖ Alpha Vantage fallback rate for USD: ${value}%`);
                                    const result = { rate: value, date: null };
                                    CacheManager.set(cacheKey, result, CACHE_CONFIG.ECONOMIC_DATA);
                                    return result;
                                }
                            }
                        }
                    } catch (error) {
                        continue;
                    }
                }
            }

            console.error(`‚ùå All sources exhausted for ${country.code} - NO DATA AVAILABLE`);
            return null;
        };

    // ========== FETCH EXTENDED DATA (bonds, sentiment, flows) ==========
const fetchExtendedData = async (countryCode) => {
    const cacheKey = `extended_${countryCode}`;
    const cached = CacheManager.get(cacheKey);
    if (cached !== null) return cached;

    try {
        const url = `https://globalinvesting.github.io/extended-data/${countryCode}.json`;
        const response = await fetchWithRetry(url, { cache: 'no-cache', mode: 'cors' }, 3);
        if (response.ok) {
            const json = await response.json();
            if (json.data) {
                console.log(`‚úÖ Extended data for ${countryCode}:`, Object.keys(json.data).filter(k => json.data[k] !== null));
                CacheManager.set(cacheKey, json, CACHE_CONFIG.ECONOMIC_DATA);
                return json;
            }
        }
    } catch (error) {
        console.warn(`Extended data fetch failed for ${countryCode}:`, error.message);
    }
    return null;
};

        // ‚úÖ OUTLOOK 100% DIN√ÅMICO (sin hardcoding)
        const determineCentralBankOutlook = async (countryCode, economicData) => {
            const cacheKey = `outlook_${countryCode}`;
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;

            try {
                const data = economicData;
                let score = 0;

                if (data.inflation > 3.0) score += 2;
                else if (data.inflation > 2.5) score += 1;
                else if (data.inflation < 1.5) score -= 2;
                else if (data.inflation < 2.0) score -= 1;

                if (data.gdpGrowth > 2.5) score += 1;
                else if (data.gdpGrowth < 1.0) score -= 2;

                if (data.unemployment < 3.5) score += 1;
                else if (data.unemployment > 6.0) score -= 1;

                if (data.interestRate > 4.0) score += 1;
                else if (data.interestRate < 2.0) score -= 1;

                let outlook;
                if (score >= 2) outlook = 'Hawkish';
                else if (score <= -2) outlook = 'Dovish';
                else outlook = 'Neutral';

                console.log(`‚úì Dynamic outlook for ${countryCode}: ${outlook} (score: ${score})`);
                CacheManager.set(cacheKey, outlook, CACHE_CONFIG.CENTRAL_BANK_OUTLOOK);
                return outlook;
            } catch (error) {
                return 'Neutral';
            }
        };

        const fetchForexRates = async () => {
            const cacheKey = 'forex_rates';
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;

            const endpoints = [
                { url: `${API_CONFIG.frankfurter.baseUrl}/latest?from=USD`, name: 'Frankfurter' },
                { url: 'https://api.exchangerate-api.com/v4/latest/USD', name: 'ExchangeRate-API' },
                { url: 'https://open.er-api.com/v6/latest/USD', name: 'Open Exchange' },
                { url: 'https://api.exchangerate.host/latest?base=USD', name: 'Exchangerate.host' },
                { url: 'https://api.fixer.io/latest?base=USD', name: 'Fixer.io' },
                { url: 'https://api.currencyapi.com/v3/latest?base_currency=USD', name: 'CurrencyAPI' }
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.rates) {
                            console.log(`‚úì Forex rates from ${endpoint.name}`);
                            CacheManager.set(cacheKey, data.rates, CACHE_CONFIG.FOREX_RATES);
                            return data.rates;
                        }
                    }
                } catch (error) {
                    console.warn(`${endpoint.name} failed`);
                }
            }

            try {
                const ecbUrl = 'https://api.frankfurter.app/latest?from=EUR';
                const response = await fetch(ecbUrl);
                if (response.ok) {
                    const data = await response.json();
                    if (data.rates) {
                        const usdRate = 1 / data.rates.USD;
                        const rates = {};
                        Object.keys(data.rates).forEach(currency => {
                            if (currency !== 'USD') {
                                rates[currency] = data.rates[currency] * usdRate;
                            }
                        });
                        console.log('‚úì Forex rates from ECB (Frankfurter EUR base)');
                        CacheManager.set(cacheKey, rates, CACHE_CONFIG.FOREX_RATES);
                        return rates;
                    }
                }
            } catch (error) {
                console.warn('ECB fallback failed');
            }

            console.warn('‚ùå All forex rate sources failed');
            return null;
        };

        const fetchCentralBankMeetings = async (countryCode) => {
            const cacheKey = `cb_meeting_${countryCode}`;
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;

            try {
                const url = 'https://globalinvesting.github.io/meetings-data/meetings.json';
                const response = await fetchWithRetry(url, { cache: 'no-cache', mode: 'cors' }, 3);
                if (response.ok) {
                    const data = await response.json();
                    const meetingInfo = data.meetings && data.meetings[countryCode];
                    if (meetingInfo && meetingInfo.nextMeeting) {
                        console.log(`‚úÖ Meeting date for ${countryCode}: ${meetingInfo.nextMeeting} (source: cbrates.com)`);
                        CacheManager.set(cacheKey, meetingInfo.nextMeeting, CACHE_CONFIG.CENTRAL_BANK_OUTLOOK);
                        return meetingInfo.nextMeeting;
                    }
                }
            } catch (error) {
                console.warn(`Meetings fetch failed for ${countryCode}:`, error.message);
            }

            console.warn(`‚ùå No meeting data available for ${countryCode}`);
            return 'Por confirmar';
        };

        const generateDynamicEconomicCalendar = () => {
            const today = new Date();
            const events = [];
            const economicEvents = [
                { country: 'USD', event: 'IPC (Inflaci√≥n)', impact: 'high', dayOfMonth: 12, time: '14:30', flag: 'üá∫üá∏' },
                { country: 'EUR', event: 'PIB Preliminar', impact: 'high', dayOfMonth: 30, time: '11:00', flag: 'üá™üá∫', quarterly: true },
                { country: 'GBP', event: 'IPC UK', impact: 'high', dayOfMonth: 18, time: '08:00', flag: 'üá¨üáß' },
                { country: 'JPY', event: 'IPC Jap√≥n', impact: 'high', dayOfMonth: 22, time: '00:30', flag: 'üáØüáµ' },
                { country: 'AUD', event: 'Decisi√≥n Tasa RBA', impact: 'high', dayOfMonth: 4, time: '04:30', flag: 'üá¶üá∫', everyMonth: true },
                { country: 'CAD', event: 'IPC Canad√°', impact: 'high', dayOfMonth: 20, time: '14:30', flag: 'üá®üá¶' },
                { country: 'CHF', event: 'IPC Suiza', impact: 'medium', dayOfMonth: 6, time: '09:30', flag: 'üá®üá≠' },
                { country: 'NZD', event: 'PIB Trimestral', impact: 'high', dayOfMonth: 19, time: '21:45', flag: 'üá≥üáø', quarterly: true }
            ];

            for (let monthOffset = 0; monthOffset <= 1; monthOffset++) {
                const targetMonth = (today.getMonth() + monthOffset) % 12;
                const targetYear = today.getMonth() + monthOffset >= 12 ? today.getFullYear() + 1 : today.getFullYear();

                economicEvents.forEach(eventTemplate => {
                    let shouldInclude = true;
                    if (eventTemplate.quarterly && targetMonth % 3 !== 0) shouldInclude = false;
                    if (eventTemplate.everyMonth) shouldInclude = true;

                    if (shouldInclude) {
                        const eventDate = new Date(targetYear, targetMonth, eventTemplate.dayOfMonth);
                        if (eventDate >= today) {
                            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                            events.push({
                                date: `${eventTemplate.dayOfMonth} ${monthNames[targetMonth]}`,
                                time: eventTemplate.time,
                                country: eventTemplate.country,
                                event: eventTemplate.event,
                                impact: eventTemplate.impact,
                                flag: eventTemplate.flag,
                                sortDate: eventDate
                            });
                        }
                    }
                });
            }

            events.sort((a, b) => a.sortDate - b.sortDate);
            return events.slice(0, 15).map(e => {
                delete e.sortDate;
                return e;
            });
        };

const fetchEconomicCalendar = async () => {
            const cacheKey = 'economic_calendar';
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;

            // ‚úÖ Strategy 1: Real scraped calendar from GitHub Pages (TE source)
            try {
                const url = 'https://globalinvesting.github.io/calendar-data/calendar.json';
                const response = await fetchWithRetry(url, { cache: 'no-cache', mode: 'cors' }, 3);
                if (response.ok) {
                    const data = await response.json();
                    if (data.events && data.events.length > 0) {
                        console.log(`‚úÖ Real calendar loaded: ${data.events.length} events (source: ${data.source})`);
                        // Store both events array and metadata
                        const result = {
                            events: data.events,
                            lastUpdate: data.lastUpdate,
                            source: data.source,
                            impactCounts: data.impactCounts || {},
                            currencyCounts: data.currencyCounts || {},
                        };
                        CacheManager.set(cacheKey, result, CACHE_CONFIG.CALENDAR);
                        return result;
                    }
                }
            } catch (error) {
                console.warn('Real calendar fetch failed:', error.message);
            }

            // ‚úÖ Fallback: dynamic calendar generator (hardcoded schedule)
            console.warn('‚ö†Ô∏è Falling back to dynamic calendar generator');
            const dynamicCalendar = generateDynamicEconomicCalendar();
            const fallbackResult = {
                events: dynamicCalendar,
                lastUpdate: null,
                source: 'fallback-generator',
                impactCounts: {},
                currencyCounts: {},
            };
            CacheManager.set(cacheKey, fallbackResult, CACHE_CONFIG.CALENDAR);
            return fallbackResult;
        };

        const fetchHistoricalFXData = async (currencyCode) => {
            const cacheKey = `historical_fx_${currencyCode}`;
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;

            try {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 6);
                
                const formatDate = (date) => date.toISOString().split('T')[0];
                const url = `https://api.exchangerate.host/timeseries?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}&base=USD&symbols=${currencyCode}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Historical FX fetch failed');
                
                const data = await response.json();
                
                if (data.rates) {
                    const dates = Object.keys(data.rates).sort();
                    const monthlyRates = [];
                    const monthlyLabels = [];
                    
                    let lastMonth = -1;
                    for (const date of dates) {
                        const d = new Date(date);
                        const month = d.getMonth();
                        
                        if (month !== lastMonth) {
                            const rate = data.rates[date][currencyCode];
                            if (rate) {
                                monthlyRates.push(rate);
                                monthlyLabels.push(d.toLocaleDateString('es-ES', { month: 'short' }));
                                lastMonth = month;
                            }
                        }
                    }
                    
                    const result = { labels: monthlyLabels.slice(-6), rates: monthlyRates.slice(-6) };
                    CacheManager.set(cacheKey, result, CACHE_CONFIG.HISTORICAL_DATA);
                    return result;
                }
                return null;
            } catch (error) {
                console.warn(`Historical FX fetch failed for ${currencyCode}`);
                return null;
            }
        };

        const generateHistoricalData = async (currentData, setDataLoadingStatus) => {
            const cacheKey = 'historical_data';
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) return cached;

            const historical = {};
            const months = ['Sep', 'Oct', 'Nov', 'Dic', 'Ene', 'Feb'];
            
            setDataLoadingStatus({ status: 'Cargando datos hist√≥ricos...', progress: 90 });

            for (let countryIndex = 0; countryIndex < countries.length; countryIndex++) {
                const country = countries[countryIndex];
                const data = currentData[country.code] || {};
                const baseRate = data.interestRate || 3.0;
                const strengthObj = calculateStrength(country.code, data, {}, currentData);  // ‚úÖ
const baseStrength = strengthObj.score || 50;  // ‚úÖ

                if (country.code !== 'USD') {
                    try {
                        const historicalFX = await fetchHistoricalFXData(country.code);
                        if (historicalFX?.rates?.length > 0) {
                            historical[country.code] = {
                                labels: historicalFX.labels,
                                rates: historicalFX.rates.map((fxRate, i) => {
                                    const variation = (fxRate - historicalFX.rates[historicalFX.rates.length - 1]) / fxRate * 2;
                                    return Number((baseRate + variation).toFixed(2));
                                }),
                                strength: historicalFX.labels.map((_, i) => {
                                    const seed = countryIndex * 100 + i + 1000;
                                    const seededRandom = (seed) => {
                                        const x = Math.sin(seed) * 10000;
                                        return x - Math.floor(x);
                                    };
                                    const variation = (seededRandom(seed) - 0.5) * 15;
                                    const trend = (i - 3) * 2;
                                    return Number(Math.max(20, Math.min(100, baseStrength + variation + trend)).toFixed(1));
                                })
                            };
                            continue;
                        }
                    } catch (error) {
                        console.warn(`Failed to get historical data for ${country.code}`);
                    }
                }

                const seededRandom = (seed) => {
                    const x = Math.sin(seed) * 10000;
                    return x - Math.floor(x);
                };

                historical[country.code] = {
                    labels: months,
                    rates: months.map((_, i) => {
                        const seed = countryIndex * 100 + i;
                        const variation = (seededRandom(seed) - 0.5) * 0.4;
                        const trend = -(months.length - i - 1) * 0.08;
                        return Number((baseRate + variation + trend).toFixed(2));
                    }),
                    strength: months.map((_, i) => {
                        const seed = countryIndex * 100 + i + 1000;
                        const variation = (seededRandom(seed) - 0.5) * 15;
                        const trend = (i - 3) * 2;
                        return Number(Math.max(20, Math.min(100, baseStrength + variation + trend)).toFixed(1));
                    })
                };
            }

            CacheManager.set(cacheKey, historical, CACHE_CONFIG.HISTORICAL_DATA);
            return historical;
        };

const generateForexPairRecommendations = (economicData, forexRates) => {
    const cacheKey = 'forex_pair_recommendations';
    const cached = CacheManager.get(cacheKey);
    if (cached !== null) return cached;

    // Calcular fortaleza de todas las divisas
    const strengthScores = {};
    countries.forEach(country => {
        const data = economicData[country.code] || {};
        const strengthObj = calculateStrength(country.code, data, forexRates, economicData);
        strengthScores[country.code] = {
            score: strengthObj.score,
            dataQuality: strengthObj.dataQuality,
            contributions: strengthObj.contributions
        };
    });

    // Funci√≥n auxiliar para extraer top contribuciones
    const getTopContributions = (contributions, isPositive) => {
        const entries = Object.entries(contributions)
            .filter(([key, val]) => isPositive ? val > 0 : val < 0)
            .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))
            .slice(0, 3);
        
        const labels = {
            'interestRate': 'Tasa de Inter√©s',
            'currentAccount': 'Cuenta Corriente',
            'tradeBalance': 'Balanza Comercial',
            'gdpGrowth': 'Crecimiento PIB',
            'inflation': 'Inflaci√≥n',
            'unemployment': 'Desempleo',
            'safe_haven_score': 'Safe Haven',
            'carry_premium': 'Carry Premium',
            'commodity_exposure': 'Exposici√≥n Commodities',
            'debt_sustainability': 'Sostenibilidad Deuda',
            'cotPositioning': 'Posicionamiento COT'
        };
        
        return entries.map(([key, val]) => ({
            factor: labels[key] || key,
            impact: val.toFixed(1)
        }));
    };

    // Ordenar divisas por fortaleza
    const sortedCurrencies = Object.entries(strengthScores)
        .sort((a, b) => b[1].score - a[1].score);

    const recommendations = [];

    // Top 3 m√°s fuertes y 3 m√°s d√©biles
    const strongCurrencies = sortedCurrencies.slice(0, 3);
    const weakCurrencies = sortedCurrencies.slice(-3).reverse();

    // Generar combinaciones LONG (Comprar fuerte vs d√©bil)
    strongCurrencies.forEach(([strongCurr, strongData]) => {
        weakCurrencies.forEach(([weakCurr, weakData]) => {
            if (strongCurr === weakCurr) return;

            const spreadStrength = strongData.score - weakData.score;
            const pairName = `${strongCurr}/${weakCurr}`;
            
            const strongReasons = getTopContributions(strongData.contributions, true);
            const weakReasons = getTopContributions(weakData.contributions, false);

            const avgQuality = (strongData.dataQuality + weakData.dataQuality) / 2;
            const confidence = spreadStrength > 20 ? 'Alta' : spreadStrength > 12 ? 'Media' : 'Baja';

            recommendations.push({
                type: 'long',
                pair: pairName,
                direction: 'LONG',
                actionText: 'Comprar',
                strength: strongData.score,
                weakness: weakData.score,
                spread: spreadStrength,
                confidence: confidence,
                dataQuality: avgQuality,
                strongCurrency: strongCurr,
                weakCurrency: weakCurr,
                strongReasons: strongReasons,
                weakReasons: weakReasons,
                priority: spreadStrength * avgQuality
            });
        });
    });

    // Generar combinaciones SHORT (Vender d√©bil vs fuerte)
    weakCurrencies.forEach(([weakCurr, weakData]) => {
        strongCurrencies.forEach(([strongCurr, strongData]) => {
            if (weakCurr === strongCurr) return;

            const spreadStrength = strongData.score - weakData.score;
            const pairName = `${weakCurr}/${strongCurr}`;
            
            const weakReasons = getTopContributions(weakData.contributions, false);
            const strongReasons = getTopContributions(strongData.contributions, true);

            const avgQuality = (strongData.dataQuality + weakData.dataQuality) / 2;
            const confidence = spreadStrength > 20 ? 'Alta' : spreadStrength > 12 ? 'Media' : 'Baja';

            recommendations.push({
                type: 'short',
                pair: pairName,
                direction: 'SHORT',
                actionText: 'Vender',
                strength: strongData.score,
                weakness: weakData.score,
                spread: spreadStrength,
                confidence: confidence,
                dataQuality: avgQuality,
                strongCurrency: strongCurr,
                weakCurrency: weakCurr,
                weakReasons: weakReasons,
                strongReasons: strongReasons,
                priority: spreadStrength * avgQuality
            });
        });
    });

    // Ordenar por prioridad y tomar top 8
    recommendations.sort((a, b) => b.priority - a.priority);
    
    const longRecs = recommendations.filter(r => r.type === 'long').slice(0, 4);
    const shortRecs = recommendations.filter(r => r.type === 'short').slice(0, 4);
    
    const finalRecommendations = [...longRecs, ...shortRecs];

    CacheManager.set(cacheKey, finalRecommendations, CACHE_CONFIG.ALERTS);
    return finalRecommendations;
};

const loadAllEconomicData = async (setEconomicData, setDataLoadingStatus) => {
                        const cacheKey = 'all_economic_data';
            // ‚ö†Ô∏è IMPORTANTE: Actualizar DASHBOARD_VERSION cada vez que modifiques el c√≥digo
            // El formato es 'vX.Y.Z-YYYY-MM-DD' ‚Äî la fecha garantiza invalidaci√≥n autom√°tica del cach√©
            const DASHBOARD_VERSION = '4.9.6-2026-02-18'; // ‚úÖ Fix: calendario real TE (3x/d√≠a), rateMomentum scraping, filter bar calendario
            
            // ‚úÖ Verificar versi√≥n del cach√©
            const cachedVersion = localStorage.getItem('forex_dashboard_version');
            if (cachedVersion !== DASHBOARD_VERSION) {
                console.log('üîÑ Nueva versi√≥n detectada, limpiando cach√©...');
                CacheManager.clearAll();
                localStorage.setItem('forex_dashboard_version', DASHBOARD_VERSION);
            }
            
            const cached = CacheManager.get(cacheKey);
            if (cached !== null) {
                setEconomicData(cached);
                setDataLoadingStatus({ status: 'Datos cargados desde cach√©', progress: 100 });
                return cached;
            }

            const economicData = {};
            const totalSteps = countries.length * 9;
            let currentStep = 0;

            for (let i = 0; i < countries.length; i++) {
                const country = countries[i];
                economicData[country.code] = {};

                setDataLoadingStatus({ 
                    status: `Cargando datos de ${country.name}...`, 
                    progress: Math.round((currentStep++ / totalSteps) * 100) 
                });

                try {
                    const githubUrl = `https://globalinvesting.github.io/economic-data/${country.code}.json`;
const response = await fetchWithRetry(githubUrl, { 
    cache: 'no-cache',
    mode: 'cors'
}, 3);
                    
if (response.ok) {
    const scrapedData = await response.json();
    
if (scrapedData.data) {
    const data = scrapedData.data;
    const dates = scrapedData.dates || {}; // ‚Üê NUEVO: Leer fechas
    
    economicData[country.code].gdp = data.gdp ? data.gdp / 1000 : null;
    economicData[country.code].gdpDate = dates.gdp || scrapedData.lastUpdate;
    currentStep++;
    
    economicData[country.code].gdpGrowth = data.gdpGrowth || null;
    economicData[country.code].gdpGrowthDate = dates.gdpGrowth || scrapedData.lastUpdate;
    currentStep++;
    
    economicData[country.code].inflation = data.inflation || null;
    economicData[country.code].inflationDate = dates.inflation || scrapedData.lastUpdate;
    currentStep++;
    
    economicData[country.code].unemployment = data.unemployment || null;
    economicData[country.code].unemploymentDate = dates.unemployment || scrapedData.lastUpdate;
    currentStep++;
    
    economicData[country.code].currentAccount = data.currentAccount || null;
    economicData[country.code].currentAccountDate = dates.currentAccount || scrapedData.lastUpdate;
    currentStep++;
    
    economicData[country.code].debt = data.debt || null;
    economicData[country.code].debtDate = dates.debt || scrapedData.lastUpdate;
    currentStep++;
    
    economicData[country.code].tradeBalance = data.tradeBalance || null;
    economicData[country.code].tradeBalanceDate = dates.tradeBalance || scrapedData.lastUpdate;
    currentStep++;
        
setDataLoadingStatus({ 
        status: `${country.name}: Tasa de Inter√©s...`, 
        progress: Math.round((currentStep / totalSteps) * 100) 
    });
    const interestRateResult = await fetchInterestRate(country);
    if (interestRateResult && typeof interestRateResult === 'object') {
        economicData[country.code].interestRate = interestRateResult.rate;
        economicData[country.code].interestRateDate = interestRateResult.date || scrapedData.lastUpdate;
    } else if (typeof interestRateResult === 'number') {
        // Backwards compatibility: old cache may hold plain numbers
        economicData[country.code].interestRate = interestRateResult;
        economicData[country.code].interestRateDate = scrapedData.lastUpdate;
    } else {
        economicData[country.code].interestRate = null;
        economicData[country.code].interestRateDate = scrapedData.lastUpdate;
    }
    currentStep++;
    
    economicData[country.code].production = data.production || null;
    economicData[country.code].productionDate = dates.production || scrapedData.lastUpdate;
    currentStep++;

    // ‚úÖ EXTRAER TIMESTAMP DEL JSON
    economicData[country.code].lastUpdate = scrapedData.lastUpdate || new Date().toISOString();

    // ‚úÖ NUEVOS INDICADORES CON FECHAS
    economicData[country.code].retailSales = data.retailSales !== undefined ? data.retailSales : null;
    economicData[country.code].retailSalesDate = dates.retailSales || scrapedData.lastUpdate;

    economicData[country.code].wageGrowth = data.wageGrowth !== undefined ? data.wageGrowth : null;
    economicData[country.code].wageGrowthDate = dates.wageGrowth || scrapedData.lastUpdate;

    economicData[country.code].manufacturingPMI = data.manufacturingPMI !== undefined ? data.manufacturingPMI : null;
    economicData[country.code].manufacturingPMIDate = dates.manufacturingPMI || scrapedData.lastUpdate;

    // ‚îÄ‚îÄ NUEVO: Terms of Trade ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // √çndice donde 100 = per√≠odo base. Sube = exportaciones ganan valor vs importaciones.
    // Muy relevante para AUD, CAD, NZD (econom√≠as exportadoras de commodities).
    economicData[country.code].termsOfTrade = data.termsOfTrade !== undefined ? data.termsOfTrade : null;
    economicData[country.code].termsOfTradeDate = dates.termsOfTrade || scrapedData.lastUpdate;

    // COT se carga desde archivo separado despu√©s
    economicData[country.code].cotPositioning = data.cotPositioning !== undefined ? data.cotPositioning : null;

        console.log(`‚úÖ Loaded all data for ${country.code}`);
    } else {
        console.error(`‚ùå No data field in scraped file for ${country.code}`);
    }
} else {
    console.error(`‚ùå Failed to fetch scraped data for ${country.code}`);
}
                    
// CARGAR DATOS COT (archivo separado)
                    try {
                        const cotUrl = `https://globalinvesting.github.io/cot-data/${country.code}.json`;                
                        
const cotResponse = await fetchWithRetry(cotUrl, { 
    cache: 'no-cache',
    mode: 'cors'
}, 2); // Solo 2 intentos para COT (menos cr√≠tico)
                        
if (cotResponse.ok) {
    const cotData = await cotResponse.json();
    if (cotData.netPosition !== null && cotData.netPosition !== undefined) {
        economicData[country.code].cotPositioning = cotData.netPosition;
        
        // ‚úÖ Guardar la fecha espec√≠fica del reporte COT
economicData[country.code].cotPositioningDate = cotData.reportDate || cotData.lastUpdate || economicData[country.code].lastUpdate || new Date().toISOString();
        
        // ‚úÖ Actualizar timestamp si COT es m√°s reciente
        if (cotData.lastUpdate) {
            const currentTimestamp = new Date(economicData[country.code].lastUpdate || 0);
            const cotTimestamp = new Date(cotData.lastUpdate);
            
            if (cotTimestamp < currentTimestamp) {
                // Si COT es m√°s antiguo, usar ese timestamp como referencia
                economicData[country.code].lastUpdate = cotData.lastUpdate;
            }
        }
        
console.log(`‚úÖ Loaded COT for ${country.code}: ${cotData.positioning}`);
    }
}
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.warn(`No COT data for ${country.code}`);
                        }
                    }

// CARGAR DATOS EXTENDIDOS (bonds, sentiment, flows)
try {
    const extData = await fetchExtendedData(country.code);
    if (extData && extData.data) {
        const d = extData.data;
        const dt = extData.dates || {};
        const lastUpd = extData.lastUpdate;

        economicData[country.code].bond10y               = d.bond10y              ?? null;
        economicData[country.code].bond10yDate            = dt.bond10y             || lastUpd;
        economicData[country.code].consumerConfidence     = d.consumerConfidence   ?? null;
        economicData[country.code].consumerConfidenceDate = dt.consumerConfidence  || lastUpd;
        economicData[country.code].businessConfidence     = d.businessConfidence   ?? null;
        economicData[country.code].businessConfidenceDate = dt.businessConfidence  || lastUpd;
        economicData[country.code].capitalFlows           = d.capitalFlows         ?? null;
        economicData[country.code].capitalFlowsDate       = dt.capitalFlows        || lastUpd;
        economicData[country.code].fdi                    = d.fdi                  ?? null;
        economicData[country.code].fdiDate                = dt.fdi                 || lastUpd;
        economicData[country.code].inflationExpectations  = d.inflationExpectations ?? null;
        economicData[country.code].inflationExpectationsDate = dt.inflationExpectations || lastUpd;
        // rateMomentum: tasa_actual - tasa_hace_12_meses (scrapeado en update-extended-data.yml v7)
        // Positivo = BC subiendo tasas (hawkish momentum), negativo = recortando (dovish momentum)
        economicData[country.code].rateMomentum = d.rateMomentum ?? null;
        economicData[country.code].rateMomentumDate = dt.rateMomentum || lastUpd;

        console.log(`‚úÖ Extended data loaded for ${country.code}`);
    }
} catch (error) {
    console.warn(`No extended data for ${country.code}`);
}
                    
                } catch (error) {
                    console.error(`‚ùå Error loading data for ${country.code}:`, error);
                }

// CARGAR FX PERFORMANCE (momentum 1M de mercado real)
try {
    const fxPerfUrl = `https://globalinvesting.github.io/fx-performance/${country.code}.json`;
    const fxPerfResponse = await fetchWithRetry(fxPerfUrl, { cache: 'no-cache', mode: 'cors' }, 2);
    if (fxPerfResponse.ok) {
        const fxPerfData = await fxPerfResponse.json();
        if (fxPerfData.fxPerformance1M !== null && fxPerfData.fxPerformance1M !== undefined) {
            economicData[country.code].fxPerformance1M = fxPerfData.fxPerformance1M;
            economicData[country.code].fxPerformance1MDate = fxPerfData.date || new Date().toISOString();
            console.log(`‚úÖ FX perf 1M for ${country.code}: ${fxPerfData.fxPerformance1M}%`);
        }
    }
} catch (error) {
    console.warn(`No FX performance data for ${country.code}`);
}
                
                setDataLoadingStatus({ 
                    status: `${country.name} completado`, 
                    progress: Math.round((currentStep / totalSteps) * 100) 
                });
            }

            setDataLoadingStatus({ status: 'Procesando outlook de bancos centrales...', progress: 95 });
            for (let country of countries) {
                country.outlook = await determineCentralBankOutlook(country.code, economicData[country.code]);
                country.nextMeeting = await fetchCentralBankMeetings(country.code);
            }

            setDataLoadingStatus({ status: 'Datos cargados exitosamente', progress: 100 });
            CacheManager.set(cacheKey, economicData, CACHE_CONFIG.ECONOMIC_DATA);
            setEconomicData(economicData);
            return economicData;
        };

// Ejemplos:
//   R√©gimen 2022 (avg ~4.5%): threshold = max(1.0, 3.0) = 3.0%  ‚Üí CHF 1.4% califica ‚úì
//   R√©gimen 2021 (avg ~0.3%): threshold = max(1.0, ‚àí1.2) = 1.0% ‚Üí solo 0-1% califica
//   R√©gimen 2026 (avg ~3.5%): threshold = max(1.0, 2.0) = 2.0%  ‚Üí CHF/JPY califican ‚úì

const calculateStrength = (currency, data = null, forexRates = {}, allEconomicData = {}) => {
    if (!data) return { 
        score: 50, 
        confidence: { lower: 40, upper: 60 }, 
        contributions: {}, 
        dataQuality: 0 
    };
    
// ========== TRADING-ORIENTED WEIGHTS v4.9.5 ==========
// Cambios vs v4.9.4:
//  - fxPerformance1M: nuevo indicador (peso 0.07) ‚Äî momentum de mercado real
//  - rateMomentum: promovido a indicador con peso propio (0.05) ‚Äî ciclo monetario
//  - interestRate: peso reducido 0.12‚Üí0.09 para dar espacio a los nuevos
//  - bond10y: peso reducido 0.02‚Üí0.01
//  - outlookScore: peso sin cambio (0.06)
// suma real = 1.04 (normalizado autom√°ticamente por totalWeight)
const TRADING_WEIGHTS = {
    // Tier 1: External Balance & Safe Haven (0.27)
    currentAccount:        { weight: 0.12, direction: 'higher' },
    tradeBalance:          { weight: 0.09, direction: 'higher' },
    debt:                  { weight: 0.04, direction: 'lower'  },
    termsOfTrade:          { weight: 0.02, direction: 'terms_of_trade' },

    // Tier 2: Rate Differentials & Carry (0.26)
    interestRate:          { weight: 0.09, direction: 'higher' },  // reducido: fxPerf1M cubre momentum real
    inflation:             { weight: 0.08, direction: 'target' },
    outlookScore:          { weight: 0.06, direction: 'outlook_direction' },
    bond10y:               { weight: 0.01, direction: 'carry_yield' },
    rateMomentum:          { weight: 0.02, direction: 'rate_momentum' },  // NUEVO como indicador propio

    // Tier 3: Growth & Employment (0.20)
    gdpGrowth:             { weight: 0.10, direction: 'higher' },
    unemployment:          { weight: 0.06, direction: 'lower'  },
    production:            { weight: 0.04, direction: 'stable' },

    // Tier 4: Consumption & Wages (0.09)
    retailSales:           { weight: 0.04, direction: 'stable' },
    wageGrowth:            { weight: 0.03, direction: 'stable' },
    inflationExpectations: { weight: 0.02, direction: 'target' },

    // Tier 5: Market Sentiment (0.15)
    manufacturingPMI:      { weight: 0.03, direction: 'expansion'       },
    cotPositioning:        { weight: 0.04, direction: 'moderate_bullish' },
    consumerConfidence:    { weight: 0.03, direction: 'sentiment_index'  },
    businessConfidence:    { weight: 0.02, direction: 'sentiment_index'  },
    capitalFlows:          { weight: 0.03, direction: 'flows'            },

    // Tier 6: Market Momentum ‚Äî NUEVO (0.07)
    // fxPerformance1M: rendimiento real de la divisa en los √∫ltimos 30 d√≠as
    // Fuente: Frankfurter API (ECB reference rates) actualizado diariamente
    // Es el √∫nico indicador 100% forward-looking y libre de lag de publicaci√≥n
    // Captura: posicionamiento especulativo, flows institucionales, carry, risk-off
    // No se puede replicar con ning√∫n otro indicador del modelo
    fxPerformance1M:       { weight: 0.07, direction: 'fx_momentum' },
};

// ========== SCORING FUNCTIONS v4.9.5 ==========
const scoreIndicator = (value, indicator, currencyCtx, allEconomicData, scoringDataExplicit) => {
    // currencyCtx: c√≥digo de divisa (e.g. 'JPY', 'CHF') para overrides data-driven
    const config = TRADING_WEIGHTS[indicator];
    if (!config) return 0;
    let score = 0;

    // ‚îÄ‚îÄ Helpers internos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // isSafeHavenFunder: divisas cuya fortaleza estructural viene de tasas BAJAS
    // (financiadoras de carry trade). Se determina din√°micamente: si la tasa es
    // < 1.5% Y la cuenta corriente del pa√≠s es superavitaria, se activa el override.
    // No hardcodeamos 'CHF' o 'JPY' ‚Äî se detecta por los datos.
    // La l√≥gica: si alguien tiene tasa casi nula pero el mercado le compra la divisa,
    // es porque hay prima de safe haven que el modelo cl√°sico no captura.
    const isSafeHavenFunder = (
    indicator === 'interestRate' &&
    value !== null && value !== undefined &&
    value <= safeHavenThreshold &&  // P-4 v4.9.6 ‚Äî relativo al r√©gimen
    currencyCtx !== null && currencyCtx !== undefined
);

    switch (config.direction) {

        case 'higher':
            if (indicator === 'interestRate') {
if (isSafeHavenFunder) {
    // P-3 v4.9.6 ‚Äî Factor de r√©gimen de mercado via COT promedio
    let riskRegime = 'neutral';
    if (allEconomicData && typeof allEconomicData === 'object') {
        const cotValues = Object.values(allEconomicData)
            .map(d => d.cotPositioning)
            .filter(v => v !== null && v !== undefined && !isNaN(v));
        if (cotValues.length >= 3) {
            const avgCOT = cotValues.reduce((a, b) => a + b, 0) / cotValues.length;
            riskRegime = avgCOT > 5000  ? 'risk-on'
                       : avgCOT < -5000 ? 'risk-off'
                       : 'neutral';
        }
    }
    // risk-off = premium pleno | neutral = moderado | risk-on = comprimido
    const regimeFactor = riskRegime === 'risk-off' ? 1.0
                       : riskRegime === 'risk-on'  ? 0.65
                       : 0.85;
    score = (72 - (value / 1.5) * 17) * regimeFactor;
    // Resultados Feb 2026 (risk-on):
    //   CHF 0.25% ‚Üí score ‚âà 45.0  (antes: 69.2)
    //   JPY 0.50% ‚Üí score ‚âà 42.6  (antes: 65.5)
} else {
                    // L√≥gica est√°ndar para divisas no-safe-haven
                    if (value >= 4.0)      score = 100;
                    else if (value >= 2.5) score = 70 + ((value - 2.5) / 1.5) * 30;
                    else if (value >= 0.5) score = 30 + ((value - 0.5) / 2.0) * 40;
                    else                   score = (value / 0.5) * 30;
                }
            } else if (indicator === 'gdpGrowth') {
                if (value >= 2.5)      score = 100;
                else if (value >= 1.5) score = 70 + ((value - 1.5) / 1.0) * 30;
                else if (value >= 0.5) score = 40 + ((value - 0.5) / 1.0) * 30;
                else if (value >= 0)   score = (value / 0.5) * 40;
                else                   score = Math.max(0, 40 + value * 20);
            } else {
                if (indicator === 'tradeBalance') {
                    if (value > 10000)       score = 100;
                    else if (value > 2000)   score = 70 + ((value - 2000) / 8000) * 30;
                    else if (value > 0)      score = 50 + (value / 2000) * 20;
                    else if (value > -15000) score = 50 + (value / 15000) * 30;
                    else score = Math.max(0, 20 + ((value + 30000) / 15000) * 20);
                } else {
                    // currentAccount (%PIB)
                    if (value > 5)        score = 100;
                    else if (value > 0)   score = 70 + (value / 5) * 30;
                    else if (value > -3)  score = 50 + (value / 3) * 20;
                    else                  score = Math.max(0, 50 + ((value + 3) / 7) * 50);
                }
            }
            break;

        case 'lower':
            if (indicator === 'debt') {
                // Correcci√≥n para deuda japonesa/alta en econom√≠as con caracter√≠sticas
                // especiales. Data-driven: si la deuda es extrema (>150%) pero la
                // cuenta corriente es superavitaria (>2%), el riesgo soberano real
                // es mucho menor que el que sugiere la ratio bruta.
                // Esto captura la realidad de Jap√≥n (deuda ~260% pero super√°vit CC,
                // deuda 90% dom√©stica) sin hardcodear el nombre del pa√≠s.
                // scoringData.currentAccount se accede via closure de calculateStrength.
                const currentAccountVal = scoringDataExplicit?.currentAccount ?? null;
                const hasSurplus = (currentAccountVal !== null && currentAccountVal > 2.0);

                if (hasSurplus && value > 150) {
                    // Deuda alta pero con super√°vit de CA ‚Üí penalidad reducida
                    // El super√°vit implica financiaci√≥n dom√©stica y menor riesgo de
                    // rollover ‚Üí cap en 35 (no cero) incluso para deudas extremas
                    score = Math.max(35, 60 - ((value - 150) / 200) * 25);
                } else if (value < 40)       score = 100;
                else if (value < 60)  score = 80 - ((value - 40) / 20) * 20;
                else if (value < 90)  score = 60 - ((value - 60) / 30) * 20;
                else if (value < 150) score = 40 - ((value - 90) / 60) * 25;
                else                  score = Math.max(0, 15 - ((value - 150) / 100) * 15);
            } else {
                // unemployment
                if (value < 3.0)      score = 100;
                else if (value < 4.0) score = 80 + ((4.0 - value) / 1.0) * 20;
                else if (value < 6.0) score = 50 + ((6.0 - value) / 2.0) * 30;
                else                  score = Math.max(0, 50 - ((value - 6.0) / 4.0) * 50);
            }
            break;

        case 'target':
            // inflation & inflationExpectations: objetivo 1.8-2.5%
            if (value >= 1.8 && value <= 2.5) {
                score = 100;
            } else if (value > 2.5 && value <= 3.5) {
                score = 70 - ((value - 2.5) / 1.0) * 20;
            } else if (value > 3.5) {
                score = Math.max(0, 50 - ((value - 3.5) / 2.0) * 50);
            } else if (value >= 1.0) {
                score = 70 + ((value - 1.0) / 0.8) * 30;
            } else {
                score = Math.max(0, 70 - ((1.0 - value) / 1.0) * 70);
            }
            break;

        case 'expansion':
            // manufacturingPMI
            if (value > 52)      score = 80 + Math.min((value - 52) / 8, 1) * 20;
            else if (value >= 50) score = 60 + ((value - 50) / 2) * 20;
            else if (value >= 48) score = 40 + ((value - 48) / 2) * 20;
            else                  score = Math.max(0, 40 - ((48 - value) / 10) * 40);
            break;

        case 'stable':
            if (indicator === 'production') {
                if (value > 1.5)       score = 100;
                else if (value > 0.5)  score = 70 + ((value - 0.5) / 1.0) * 30;
                else if (value > 0)    score = 40 + (value / 0.5) * 30;
                else if (value > -1.0) score = 20 + ((value + 1.0) / 1.0) * 20;
                else                   score = Math.max(0, 20 + ((value + 2.0) / 1.0) * 20);
            } else if (indicator === 'retailSales') {
                if (value > 0.5)       score = 100;
                else if (value > 0)    score = 60 + (value / 0.5) * 40;
                else if (value > -0.5) score = 40 + ((value + 0.5) / 0.5) * 20;
                else                   score = Math.max(0, 40 + ((value + 1.0) / 0.5) * 40);
            } else if (indicator === 'wageGrowth') {
                if (value >= 2.5 && value <= 4.5) score = 100;
                else if (value > 4.5 && value <= 6.0) score = 70 + ((6.0 - value) / 1.5) * 30;
                else if (value > 6.0) score = Math.max(0, 70 - ((value - 6.0) / 2.0) * 70);
                else if (value >= 1.5) score = 40 + ((value - 1.5) / 1.0) * 60;
                else score = Math.max(0, 40 - ((1.5 - value) / 1.5) * 40);
            }
            break;

        case 'carry_yield':
            // bond10y: higher yield = more carry attractive
            if (value >= 4.5)      score = 90 + Math.min((value - 4.5) / 2, 1) * 10;
            else if (value >= 3.0) score = 70 + ((value - 3.0) / 1.5) * 20;
            else if (value >= 2.0) score = 50 + ((value - 2.0) / 1.0) * 20;
            else if (value >= 0.5) score = 20 + ((value - 0.5) / 1.5) * 30;
            else                   score = Math.max(0, value * 40);
            break;

        case 'sentiment_index':
            // consumerConfidence, businessConfidence: base 100
            if (value > 110)      score = 90 + Math.min((value - 110) / 20, 1) * 10;
            else if (value > 100) score = 70 + ((value - 100) / 10) * 20;
            else if (value >= 95) score = 50 + ((value - 95) / 5) * 20;
            else if (value >= 85) score = 20 + ((value - 85) / 10) * 30;
            else                  score = Math.max(0, 20 - ((85 - value) / 15) * 20);
            break;

        case 'flows':
            // capitalFlows: positive = net inflow ‚Üí currency demand
            if (value > 50000)        score = 90 + Math.min((value - 50000) / 100000, 1) * 10;
            else if (value > 10000)   score = 70 + ((value - 10000) / 40000) * 20;
            else if (value > 0)       score = 50 + (value / 10000) * 20;
            else if (value > -10000)  score = 30 + ((value + 10000) / 10000) * 20;
            else if (value > -50000)  score = 10 + ((value + 50000) / 40000) * 20;
            else                      score = Math.max(0, 10 - ((Math.abs(value) - 50000) / 100000) * 10);
            break;

        case 'terms_of_trade':
            if (value >= 110)      score = 90 + Math.min((value - 110) / 20, 1) * 10;
            else if (value >= 103) score = 70 + ((value - 103) / 7) * 20;
            else if (value >= 100) score = 55 + ((value - 100) / 3) * 15;
            else if (value >= 95)  score = 35 + ((value - 95) / 5) * 20;
            else if (value >= 85)  score = 10 + ((value - 85) / 10) * 25;
            else                   score = Math.max(0, 10 - ((85 - value) / 10) * 10);
            break;

        case 'moderate_bullish':
            // cotPositioning ‚Äî con l√≥gica contrarian para extremos
            if (value > 100000) {
                score = Math.max(20, 60 - ((value - 100000) / 50000) * 30);
            } else if (value > 30000)       score = 85 - ((value - 30000) / 70000) * 25;
            else if (value > 15000)  score = 95 - ((value - 15000) / 15000) * 10;
            else if (value > 5000)   score = 100 - ((value - 5000) / 10000) * 5;
            else if (value > 0)      score = 70 + (value / 5000) * 30;
            else if (value === 0)    score = 50;
            else if (value > -5000)  score = 30 + ((value + 5000) / 5000) * 20;
            else if (value > -15000) score = 15 + ((value + 15000) / 10000) * 15;
            else if (value > -30000) score = 5  + ((value + 30000) / 15000) * 10;
            else if (value > -100000) score = Math.max(5, 5 - ((Math.abs(value) - 30000) / 70000) * 5);
            else {
                score = Math.min(80, 20 + ((Math.abs(value) - 100000) / 50000) * 30);
            }
            break;

        case 'outlook_direction':
            if (value === 'Hawkish')      score = 90;
            else if (value === 'Neutral') score = 50;
            else if (value === 'Dovish')  score = 10;
            else score = 50;
            break;

        case 'rate_momentum':
            // rateMomentum = tasa_actual - tasa_hace_12_meses
            // Positivo = BC subiendo tasas (hawkish cycle) ‚Üí bullish
            // Negativo = BC recortando ‚Üí bearish
            // Escala calibrada para el ciclo actual:
            //   BoJ +0.5% a +1% en 2025-2026 ‚Üí fuertemente bullish
            //   Fed -1% en 2024-2025 ‚Üí fuertemente bearish
            //   ECB -1.5% en 2024-2025 ‚Üí bearish (pero se estabiliz√≥)
            if (value > 1.5)       score = 100; // Normalizaci√≥n agresiva (BoJ 2026)
            else if (value > 0.75) score = 85;
            else if (value > 0.25) score = 72;
            else if (value > 0.0)  score = 58;
            else if (value === 0)  score = 50;
            else if (value > -0.25) score = 42;
            else if (value > -0.75) score = 30;
            else if (value > -1.5) score = 18;
            else                   score = 5;  // Recortes agresivos
            break;

        case 'fx_momentum':
            // fxPerformance1M: % apreciaci√≥n de la divisa vs USD en los √∫ltimos 30 d√≠as
            // Es el indicador m√°s "real time" del modelo ‚Äî refleja positioning,
            // flujos institucionales y carry unwind en tiempo casi real.
            // Calibraci√≥n basada en distribuci√≥n hist√≥rica de rendimientos mensuales:
            //   Extremo alcista: >4% (AUD/NZD Feb 2026: +5.7%, +5.0%)
            //   Fuerte:          2-4% (CHF: +4.1%, JPY: +3.2%)
            //   Moderado:        1-2% (EUR: +2.0%, CAD: +1.9%)
            //   Neutral:         0-1%
            //   D√©bil:           -1 a 0%
            //   Muy d√©bil:       < -2% (USD: -2.2%)
            // La funci√≥n es asim√©trica: castiga p√©rdidas m√°s que premia ganancias
            // equivalentes, reflejando que reversi√≥n de tendencia tiene informaci√≥n
            // m√°s fuerte que continuaci√≥n.
            if (value > 5.0)       score = 100;
            else if (value > 3.5)  score = 88 + ((value - 3.5) / 1.5) * 12;
            else if (value > 2.0)  score = 75 + ((value - 2.0) / 1.5) * 13;
            else if (value > 1.0)  score = 63 + ((value - 1.0) / 1.0) * 12;
            else if (value > 0.0)  score = 53 + (value / 1.0) * 10;
            else if (value === 0)  score = 50;
            else if (value > -1.0) score = 38 + ((value + 1.0) / 1.0) * 12; // cae m√°s r√°pido
            else if (value > -2.5) score = 20 + ((value + 2.5) / 1.5) * 18;
            else if (value > -4.0) score = 8  + ((value + 4.0) / 1.5) * 12;
            else                   score = Math.max(0, 8 + ((value + 5.0) / 1.0) * 8);
            break;
    }

    return Math.max(0, Math.min(100, score));
};

    // ========== SCORING LOOP ==========
    let weightedScoreSum = 0;   // Suma de (score_i * weight_i)
    let totalWeight = 0;        // Suma de pesos de indicadores con datos
    const contributions = {};
    let validIndicators = 0;

    // Capturar el objeto pa√≠s para acceder al outlook y rateMomentum scrapeados.
    const countryObj = (typeof countries !== 'undefined')
        ? countries.find(c => c.code === currency)
        : null;

    // Inyectar outlookScore como indicador num√©rico desde el campo 'outlook' del pa√≠s.
    // Si el rateMomentum indica normalizaci√≥n (tasa subiendo) pero el outlook din√°mico
    // dice Dovish, hacer upgrade autom√°tico a Neutral (data-driven: el cambio importa m√°s que el nivel).
    let effectiveOutlook = (countryObj && countryObj.outlook && countryObj.outlook !== 'Calculando...')
        ? countryObj.outlook
        : null;

    if (effectiveOutlook && data.rateMomentum !== null && data.rateMomentum !== undefined) {
        // Upgrade: BC normalizando (subiendo tasas) pero nivel bajo ‚Üí Dovish injusto
        if (data.rateMomentum > 0.3 && effectiveOutlook === 'Dovish') {
            effectiveOutlook = 'Neutral';
        }
        // Downgrade: BC recortando agresivamente pero nivel alto ‚Üí Hawkish injusto
        if (data.rateMomentum < -1.0 && effectiveOutlook === 'Hawkish') {
            effectiveOutlook = 'Neutral';
        }
    }

    // P-4 v4.9.6 ‚Äî Umbral safe haven relativo al r√©gimen de tasas (DENTRO del scope correcto)
    const allRatesForSH = Object.values(allEconomicData)
        .map(d => d.interestRate)
        .filter(v => v != null && !isNaN(v));
    const avgRateForSH = allRatesForSH.length > 0
        ? allRatesForSH.reduce((a, b) => a + b, 0) / allRatesForSH.length
        : 3.0;
    const safeHavenThreshold = Math.max(1.0, avgRateForSH - 1.5);
    // R√©gimen 2026 (avg ~3.5%): threshold = 2.0% ‚Üí CHF 0.25% y JPY 0.50% califican ‚úì
    // R√©gimen 2022 (avg ~4.5%): threshold = 3.0% ‚Üí CHF 1.4% califica ‚úì
    // R√©gimen 2021 (avg ~0.3%): threshold = 1.0% ‚Üí solo tasas ~0% califican
    
// NZD businessConfidence: ANZ Business Outlook is net balance centred at 0.
// Re-map to base-100 for uniform scoring: 0‚Üí50 (neutral), +100‚Üí100, -100‚Üí0
let scoringData = { ...data };
    // fxPerformance1M: si no viene en data (p.ej. primer load antes del GitHub Action),
// se omite (el loop de scoring lo ignorar√° por ser null/undefined)
// No hay fallback: si no hay dato, el modelo funciona sin √©l (peso 0.07 se normaliza)

if (effectiveOutlook) {
    scoringData.outlookScore = effectiveOutlook;
}
    if (currency === 'NZD' && scoringData.businessConfidence !== null && scoringData.businessConfidence !== undefined) {
        scoringData.businessConfidence = Math.max(0, Math.min(100, (scoringData.businessConfidence / 100) * 50 + 50));
    }

    // JPY consumerConfidence: Japan index ronda 33-40, no base 100
// Normalizar: rango hist√≥rico 25-50 ‚Üí mapeado a 75-115 (equivalente base 100)
if (currency === 'JPY' && scoringData.consumerConfidence !== null && scoringData.consumerConfidence !== undefined) {
    if (scoringData.consumerConfidence < 60) {
        // Es la escala japonesa (25-55) ‚Üí mapear a base 100
        scoringData.consumerConfidence = ((scoringData.consumerConfidence - 25) / 30) * 40 + 85;
    }
    // Si ya es >60, asumir que vino normalizado y dejarlo
}

    Object.keys(TRADING_WEIGHTS).forEach(indicator => {
        const value = scoringData[indicator];
        if (value === null || value === undefined || isNaN(value)) {
            contributions[indicator] = 0;
            return;
        }
        const config = TRADING_WEIGHTS[indicator];
        const rawScore = scoreIndicator(value, indicator, currency, allEconomicData, scoringData); 
        const weighted    = rawScore * config.weight;
        contributions[indicator] = weighted;
        weightedScoreSum += weighted;
        totalWeight      += config.weight;
        validIndicators++;
    });

    // ========== WEIGHTED AVERAGE ‚Üí 0-100 scale ==========
    // Normalise by actual weight sum so missing data doesn't deflate the score
    const baseScore = totalWeight > 0 ? (weightedScoreSum / totalWeight) : 50;

    // ========== CONTEXTUAL ADJUSTMENTS (additive, in score points) ==========

    // 1. Safe Haven Score ‚Äî fully dynamic
    const calculateSafeHavenScore = (currency, data, allEconomicData) => {
        let safeHavenScore = 0;
        if (data.debt !== null && data.debt !== undefined) {
            if (data.debt < 40)       safeHavenScore += 30;
            else if (data.debt < 60)  safeHavenScore += 20;
            else if (data.debt < 90)  safeHavenScore += 10;
        }
        if (data.currentAccount !== null && data.currentAccount !== undefined) {
            if (data.currentAccount > 5)       safeHavenScore += 30;
            else if (data.currentAccount > 2)  safeHavenScore += 20;
            else if (data.currentAccount > 0)  safeHavenScore += 10;
            else if (data.currentAccount < -3) safeHavenScore -= 10;
        }
        if (data.inflation !== null && data.inflation !== undefined) {
            const dev = Math.abs(data.inflation - 2.0);
            if (dev < 0.5)      safeHavenScore += 20;
            else if (dev < 1.0) safeHavenScore += 15;
            else if (dev < 2.0) safeHavenScore += 10;
        }
        if (data.gdp !== null && data.gdp !== undefined) {
            if (data.gdp > 20)      safeHavenScore += 20;
            else if (data.gdp > 5)  safeHavenScore += 15;
            else if (data.gdp > 1)  safeHavenScore += 10;
            else                    safeHavenScore += 5;
        }
        const cotValues = Object.values(allEconomicData)
            .map(d => d.cotPositioning)
            .filter(v => v !== null && v !== undefined && !isNaN(v));
        const avgCOT = cotValues.length >= 3
            ? cotValues.reduce((a, b) => a + b, 0) / cotValues.length : 0;
        const regime = avgCOT < -5000 ? 'risk-off' : avgCOT > 5000 ? 'risk-on' : 'neutral';
        let multiplier = 1.0;
        if (regime === 'risk-off') multiplier = safeHavenScore > 60 ? 1.5 : 1.0;
        if (regime === 'risk-on')  multiplier = safeHavenScore > 70 ? 1.1 : 0.7;
        // Normalize to -5 / +10 score-point range
        return Math.max(-5, Math.min(10, ((safeHavenScore * multiplier) / 100) * 15 - 5));
    };

    // 2. Commodity Exposure ‚Äî dynamic
    const calculateCommodityScore = (currency, data, allEconomicData) => {
        if (!['AUD', 'CAD', 'NZD'].includes(currency)) return 0;
        let dep = 0;
        if (data.tradeBalance !== null && data.tradeBalance > 1000)
            dep = Math.min(data.tradeBalance / 10000, 1.0);
        if (data.production !== null && data.production !== undefined) {
            if (data.production > 2.0) dep += 0.3;
            else if (data.production > 0.5) dep += 0.15;
        }
        const growthRates = Object.values(allEconomicData)
            .map(d => d.gdpGrowth).filter(v => v !== null && v !== undefined && !isNaN(v));
        const globalGrowth = growthRates.length > 0
            ? growthRates.reduce((a, b) => a + b, 0) / growthRates.length : 1.5;
        if (globalGrowth > 2.5) return dep * 3;
        if (globalGrowth > 1.5) return 0;
        return -(dep * 5);
    };

    // 3. Carry Trade Premium ‚Äî dynamic
    const calculateCarryPremium = (data, allEconomicData) => {
        if (!data.interestRate) return 0;
        const allRates = Object.values(allEconomicData)
            .map(d => d.interestRate).filter(v => v !== null && v !== undefined && !isNaN(v));
        const avgRate = allRates.length > 0
            ? allRates.reduce((a, b) => a + b, 0) / allRates.length : 3.0;
        const diff = data.interestRate - avgRate;
        return diff > 1.0 ? Math.min(diff * 2, 5) : 0;
    };

    // 4. Recession Impact ‚Äî dynamic
    const calculateRecessionImpact = (data) => {
        if (data.gdpGrowth === null || data.gdpGrowth >= 0) return 0;
        const depth = Math.abs(data.gdpGrowth);
        let mult = 3.0;
        if (data.unemployment !== null) {
            if (data.unemployment > 8.0)      mult = 5.0;
            else if (data.unemployment > 6.0) mult = 4.0;
            else if (data.unemployment < 4.0) mult = 2.0;
        }
        return -(depth * mult);
    };

    // 5. Structural Deficit ‚Äî dynamic
    const calculateStructuralDeficit = (data) => {
        let score = 0;
        if (data.currentAccount !== null && data.currentAccount < -3)
            score -= (Math.abs(data.currentAccount + 3) / 3) * 5;
        if (data.tradeBalance !== null && data.tradeBalance < -30000)
            score -= (Math.abs(data.tradeBalance + 30000) / 30000) * 5;
        if (data.currentAccount !== null && data.currentAccount < -3 &&
            data.tradeBalance !== null && data.tradeBalance < -30000)
            score -= 3;
        return Math.max(score, -12);
    };

    // 6. Debt Sustainability ‚Äî dynamic
    const calculateDebtSustainability = (data) => {
        if (data.debt === null || data.debt === undefined || data.debt <= 150) return 0;
        let s = -((data.debt - 150) / 100) * 4;
        if (data.gdpGrowth !== null && data.gdpGrowth < 1.0) s -= 2;
        if (data.currentAccount !== null && data.currentAccount > 2.0) s += 2;
        return Math.max(s, -8);
    };

    // 7. Inflation Stability ‚Äî dynamic
    const calculateInflationStability = (data) => {
        if (data.inflation === null || data.inflation === undefined) return 0;
        if (data.inflation > 4.0) {
            let pen = -((data.inflation - 4.0) / 2.0) * 3;
            if (data.interestRate !== null && data.interestRate < data.inflation - 1.0) pen -= 2;
            return Math.max(pen, -6);
        }
        if (data.inflation < 0) return data.inflation * -1.5;
        return 0;
    };

    // 8b. Yield Curve Proxy ‚Äî bond10y < interestRate = curva invertida = mercado
    // descuenta recortes agresivos futuros ‚Üí bearish para la divisa.
    const calculateYieldCurveAdj = (data) => {
        if (data.bond10y === null || data.bond10y === undefined) return 0;
        if (data.interestRate === null || data.interestRate === undefined) return 0;
        const spread = data.bond10y - data.interestRate; // negativo = inversi√≥n
        if (spread < -1.5) return -6;
        if (spread < -0.5) return Math.max(-6, spread * 4); // lineal hasta -6 pts
        return 0; // spread positivo = curva normal, sin penalizaci√≥n
    };

    // 8c. COT Contrarian Hawkish ‚Äî posici√≥n bajista extrema en divisa con outlook hawkish.
    // Indica desalineamiento: el mercado est√° corto pero el BC sube tasas ‚Üí contrarian bullish.
    const calculateCotContrarianAdj = (data, countryObj) => {
        if (data.cotPositioning === null || data.cotPositioning === undefined) return 0;
        if (!countryObj || countryObj.outlook !== 'Hawkish') return 0;
        if (data.cotPositioning < -25000) {
            const extremeness = Math.min(Math.abs(data.cotPositioning) - 25000, 50000);
            return Math.min(6, (extremeness / 50000) * 6);
        }
        return 0;
    };

// 8. Low-Rate Safe Haven Premium v2 ‚Äî 100% data-driven, sin hardcoding de divisas
    // Detecta din√°micamente si una divisa es "safe haven funder" por sus datos:
    //   - Tasa baja (< avgRate - 1.5): es financiadora de carry
    //   - Cuenta corriente superavitaria (> 1%): demanda estructural de la divisa
    //   - Deuda/CA ratio favorable: la divisa tiene respaldo de balance exterior
    // Cuanto m√°s se cumplen estas condiciones, mayor el premio de safe haven.
    // Calibraci√≥n: CHF (tasa 0%, CA +10%) deber√≠a recibir +12 a +15 pts
    //              JPY (tasa 0.75%, CA +3.5%) deber√≠a recibir +8 a +10 pts
    const calculateLowRateSafeHavenAdj = (currency, data, allEconomicData) => {
        if (data.interestRate === null || data.interestRate === undefined) return 0;

        const allRates = Object.values(allEconomicData)
            .map(d => d.interestRate)
            .filter(v => v !== null && v !== undefined && !isNaN(v));
        const avgRate = allRates.length > 0
            ? allRates.reduce((a, b) => a + b, 0) / allRates.length : 3.0;

        // Solo aplica si la tasa es SIGNIFICATIVAMENTE menor al promedio
        const rateGap = avgRate - data.interestRate; // positivo = m√°s baja que el promedio
        if (rateGap < 1.0) return 0; // No es un outlier de tasa baja, no aplica

        // Factor 1: Brecha de tasa (cuanto m√°s baja vs promedio, mayor el safe haven premium)
        // Normalizado: rateGap=1.5 ‚Üí factor=0.5, rateGap=3.0+ ‚Üí factor=1.0
        const rateGapFactor = Math.min((rateGap - 1.0) / 2.0, 1.0);

        // Factor 2: Cuenta corriente (super√°vit = demanda estructural de la divisa)
        // Una divisa con CA positivo en un mundo con risk-off es comprada activamente
        let caFactor = 0;
        if (data.currentAccount !== null && data.currentAccount !== undefined) {
            if (data.currentAccount > 5)      caFactor = 1.0;
            else if (data.currentAccount > 2)  caFactor = 0.7;
            else if (data.currentAccount > 0)  caFactor = 0.4;
            else                               caFactor = 0; // d√©ficit = no safe haven
        } else {
            caFactor = 0.3; // sin dato: penalizar levemente la incertidumbre
        }

        // Factor 3: Deuda/PIB (baja deuda = credibilidad fiscal ‚Üí safe haven)
        let debtFactor = 0.5; // neutral por defecto
        if (data.debt !== null && data.debt !== undefined) {
            if (data.debt < 40)       debtFactor = 1.0;
            else if (data.debt < 60)  debtFactor = 0.85;
            else if (data.debt < 90)  debtFactor = 0.65;
            else if (data.debt < 150) debtFactor = 0.4;
            else                      debtFactor = 0.2; // deuda extrema: safe haven disminuido
        }

        // Score final: combinaci√≥n ponderada de los tres factores
        // Pesos: rateGap (50%) + CA (30%) + Debt (20%)
        const combinedFactor = (rateGapFactor * 0.50) + (caFactor * 0.30) + (debtFactor * 0.20);

        // Rango de ajuste: 0 a +15 puntos (m√°ximo institucional para safe haven premium)
        const adj = combinedFactor * 15;

        console.log(`SafeHavenAdj ${currency}: rateGap=${rateGap.toFixed(2)}, factors=(${rateGapFactor.toFixed(2)}, ${caFactor.toFixed(2)}, ${debtFactor.toFixed(2)}) ‚Üí +${adj.toFixed(1)}pts`);

        return Math.max(0, Math.min(15, adj));
    };

    // Apply contextual adjustments
    const safeHavenAdj        = calculateSafeHavenScore(currency, data, allEconomicData);
    const commodityAdj        = calculateCommodityScore(currency, data, allEconomicData);
    const carryAdj            = calculateCarryPremium(data, allEconomicData);
    const recessionAdj        = calculateRecessionImpact(data);
    const deficitAdj          = calculateStructuralDeficit(data);
    const debtAdj             = calculateDebtSustainability(data);
    const inflationStabAdj    = calculateInflationStability(data);
    const lowRateSafeHavenAdj = calculateLowRateSafeHavenAdj(currency, data, allEconomicData);
    const yieldCurveAdj       = calculateYieldCurveAdj(data);
    const cotContrarianAdj    = calculateCotContrarianAdj(data, countryObj);

    contributions['safe_haven_score']    = safeHavenAdj;
    contributions['low_rate_safe_haven'] = lowRateSafeHavenAdj;
    contributions['commodity_exposure']  = commodityAdj;
    contributions['carry_premium']       = carryAdj;
    contributions['recession_impact']    = recessionAdj;
    contributions['structural_deficit']  = deficitAdj;
    contributions['debt_sustainability'] = debtAdj;
    contributions['inflation_stability'] = inflationStabAdj;
    contributions['yield_curve_proxy']   = yieldCurveAdj;
    contributions['cot_contrarian']      = cotContrarianAdj;

    // All adjustments are in "score point" units (same scale as 0-100)
    // Cap total adjustment so it can shift the score ¬±15 points max
    const totalAdj = safeHavenAdj + commodityAdj + carryAdj +
                     recessionAdj + deficitAdj + debtAdj + inflationStabAdj +
                     lowRateSafeHavenAdj + yieldCurveAdj + cotContrarianAdj;
    const cappedAdj = Math.max(-15, Math.min(15, totalAdj));

// P-1 v4.9.6 ‚Äî Compresi√≥n de base para crear headroom en escala 20-82
// Base original (0-100) ‚Üí comprimida (20-78), dejando margen para ajustes
const compressedBase = 20 + (baseScore * 0.58);
const rawFinal = compressedBase + cappedAdj;
const normalizedScore = Math.max(20, Math.min(82, rawFinal));
// Resultados Feb 2026:
//   AUD: compressedBase‚âà67.3 + adj5.0 = 72.3 ‚Üí score ‚âà 72.3  (antes: 80 = techo)
//   CHF: compressedBase‚âà61.0 + adj9.8 = 70.8 ‚Üí score ‚âà 70.8  (antes: 80 = techo)
//   AUD rankea correctamente sobre CHF ‚úì

    // Data quality
    const dataQuality  = validIndicators / Object.keys(TRADING_WEIGHTS).length;
    const standardError = (1 - dataQuality * 0.8) * 8;
    const confidenceInterval = {
        lower: Math.max(20, normalizedScore - 1.96 * standardError),
        upper: Math.min(80, normalizedScore + 1.96 * standardError)
    };

    return {
        score: parseFloat(normalizedScore.toFixed(1)),
        confidence: {
            lower: parseFloat(confidenceInterval.lower.toFixed(1)),
            upper: parseFloat(confidenceInterval.upper.toFixed(1))
        },
        contributions: contributions,
        dataQuality: parseFloat(dataQuality.toFixed(2))
    };
};

        const clearDashboardCache = () => {
            CacheManager.clearAll();
            alert('Cach√© limpiado. Recarga la p√°gina para obtener datos actualizados.');
        };

    // ========== DATA HEALTH CHECK SYSTEM ==========
const checkDataHealth = (economicData) => {
    const issues = [];
    const warnings = [];
    
    Object.keys(economicData).forEach(curr => {
        const data = economicData[curr];
        
        // Check 1: Data age
        if (data.lastUpdate) {
            const age = Date.now() - new Date(data.lastUpdate).getTime();
            const daysOld = Math.floor(age / (24 * 60 * 60 * 1000));
            
            if (daysOld > 7) {
                issues.push(`${curr}: Datos con ${daysOld} d√≠as de antig√ºedad`);
            } else if (daysOld > 3) {
                warnings.push(`${curr}: Datos con ${daysOld} d√≠as (considerar actualizaci√≥n)`);
            }
        } else {
            issues.push(`${curr}: Sin timestamp de actualizaci√≥n`);
        }
        
        // Check 2: Missing critical indicators
        const critical = ['interestRate', 'inflation', 'gdpGrowth', 'unemployment'];
        const missing = critical.filter(ind => 
            data[ind] === null || data[ind] === undefined
        );
        if (missing.length > 0) {
            issues.push(`${curr}: Faltan indicadores cr√≠ticos: ${missing.join(', ')}`);
        }
        
        // Check 3: Out of range values
        if (data.inflation !== null && data.inflation !== undefined) {
            if (data.inflation < -5 || data.inflation > 25) {
                issues.push(`${curr}: Inflaci√≥n fuera de rango (${data.inflation}%)`);
            }
        }
        
        if (data.unemployment !== null && data.unemployment !== undefined) {
            if (data.unemployment < 0 || data.unemployment > 30) {
                issues.push(`${curr}: Desempleo fuera de rango (${data.unemployment}%)`);
            }
        }
        
        if (data.interestRate !== null && data.interestRate !== undefined) {
            if (data.interestRate < -2 || data.interestRate > 20) {
                issues.push(`${curr}: Tasa de inter√©s fuera de rango (${data.interestRate}%)`);
            }
        }
        
        // Check 4: Data completeness score
        const indicators = [
            'gdpGrowth', 'interestRate', 'inflation', 'unemployment',
            'currentAccount', 'debt', 'tradeBalance', 'production',
            'retailSales', 'wageGrowth', 'manufacturingPMI', 'cotPositioning',
            'bond10y', 'consumerConfidence', 'businessConfidence',
            'capitalFlows', 'inflationExpectations', 'termsOfTrade'
        ];
        
        const available = indicators.filter(ind => 
            data[ind] !== null && data[ind] !== undefined
        ).length;
        
        const completeness = Math.round((available / indicators.length) * 100);
        
        if (completeness < 50) {
            issues.push(`${curr}: Completitud de datos muy baja (${completeness}%)`);
        } else if (completeness < 70) {
            warnings.push(`${curr}: Completitud de datos ${completeness}%`);
        }
    });
    
    return {
        healthy: issues.length === 0,
        issues,
        warnings,
        timestamp: new Date().toISOString()
    };
};

const getOldestDataTimestamp = (economicData) => {
    let oldest = null;
    
    Object.values(economicData).forEach(data => {
        if (data.lastUpdate) {
            const date = new Date(data.lastUpdate);
            if (!oldest || date < oldest) {
                oldest = date;
            }
        }
    });
    
    return oldest;
};

const getCacheAge = (economicData) => {
    const oldest = getOldestDataTimestamp(economicData);
    if (!oldest) return 'Desconocido';
    
    const ageMs = Date.now() - oldest.getTime();
    const hours = Math.floor(ageMs / (60 * 60 * 1000));
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days}d ${hours % 24}h`;
    if (hours > 0) return `${hours}h`;
    return 'Reciente';
};

const isCacheStale = (economicData) => {
    const oldest = getOldestDataTimestamp(economicData);
    if (!oldest) return true;
    
    const ageMs = Date.now() - oldest.getTime();
    const hours = Math.floor(ageMs / (60 * 60 * 1000));
    
    return hours > 48; // Stale if older than 48 hours
};

        if (typeof window !== 'undefined') {
            window.clearForexCache = clearDashboardCache;
        }

        const countries = [
            { code: 'USD', name: 'Estados Unidos', currency: 'D√≥lar Estadounidense', flag: 'üá∫üá∏', centralBank: 'Reserva Federal', nextMeeting: 'Por definir', outlook: 'Calculando...' },
            { code: 'EUR', name: 'Eurozona', currency: 'Euro', flag: 'üá™üá∫', centralBank: 'Banco Central Europeo', nextMeeting: 'Por definir', outlook: 'Calculando...' },
            { code: 'GBP', name: 'Reino Unido', currency: 'Libra Esterlina', flag: 'üá¨üáß', centralBank: 'Banco de Inglaterra', nextMeeting: 'Por definir', outlook: 'Calculando...' },
            { code: 'JPY', name: 'Jap√≥n', currency: 'Yen Japon√©s', flag: 'üáØüáµ', centralBank: 'Banco de Jap√≥n', nextMeeting: 'Por definir', outlook: 'Calculando...' },
            { code: 'AUD', name: 'Australia', currency: 'D√≥lar Australiano', flag: 'üá¶üá∫', centralBank: 'Banco de la Reserva de Australia', nextMeeting: 'Por definir', outlook: 'Calculando...' },
            { code: 'CAD', name: 'Canad√°', currency: 'D√≥lar Canadiense', flag: 'üá®üá¶', centralBank: 'Banco de Canad√°', nextMeeting: 'Por definir', outlook: 'Calculando...' },
            { code: 'CHF', name: 'Suiza', currency: 'Franco Suizo', flag: 'üá®üá≠', centralBank: 'Banco Nacional Suizo', nextMeeting: 'Por definir', outlook: 'Calculando...' },
            { code: 'NZD', name: 'Nueva Zelanda', currency: 'D√≥lar Neozeland√©s', flag: 'üá≥üáø', centralBank: 'Banco de la Reserva de Nueva Zelanda', nextMeeting: 'Por definir', outlook: 'Calculando...' }
        ];

const indicatorTooltips = {
    gdp: "Producto Interno Bruto total en trillones USD.",
    gdpGrowth: "Tasa de crecimiento anual del PIB. >2% indica econom√≠a sana.",
    interestRate: "Tasa de pol√≠tica monetaria del banco central.",
    inflation: "Inflaci√≥n anual medida por IPC. Objetivo: ~2%.",
    unemployment: "% de fuerza laboral desempleada.",
    currentAccount: "Balance comercial + flujos de inversi√≥n como % del PIB.",
    debt: "Deuda p√∫blica como % del PIB.",
    tradeBalance: "Exportaciones - Importaciones mensuales en miles de millones USD.",
    production: "Cambio en producci√≥n industrial. Para la mayor√≠a de divisas es mensual (MoM); para NZD el dato es trimestral (QoQ) ya que Statistics New Zealand lo publica con esa frecuencia. >1.5% indica momentum industrial fuerte; >0% expansi√≥n moderada; valores negativos se√±alan contracci√≥n sectorial.",
    
    // NUEVOS INDICADORES
    retailSales: "Cambio mensual en ventas minoristas. >0.5% indica consumo robusto.",
    wageGrowth: "Crecimiento salarial anual. >3.5% presiona inflaci√≥n al alza.",
    manufacturingPMI: "√çndice de actividad manufacturera. >50 = expansi√≥n, <50 = contracci√≥n.",
    cotPositioning: "Posicionamiento neto de traders especulativos seg√∫n reporte CFTC. Valores positivos indican contratos largos netos (bullish), valores negativos indican cortos netos (bearish). >20K o <-20K pueden indicar extremos de mercado.",
    consumerConfidence: "√çndice de confianza del consumidor. Base 100. >100 = optimismo sobre la econom√≠a personal y disposici√≥n al gasto. <95 = pesimismo y contracci√≥n del consumo privado esperada. Indicador adelantado del ciclo econ√≥mico.",
    bond10y: "Rendimiento del bono soberano a 10 a√±os. Para EUR se usa el yield oficial de la Zona Euro (GEUGB10Y ‚Äî agregado publicado directamente por Trading Economics), que refleja el costo de financiamiento soberano del conjunto de la eurozona. Refleja expectativas de tasas futuras e inflaci√≥n. El diferencial de yields entre pa√≠ses es el 'yield spread' que mueve grandes flujos de capital.",
    businessConfidence: "√çndice de confianza empresarial. Base 100. >100 = expansi√≥n esperada, <100 = contracci√≥n. Predice inversi√≥n, contrataciones y actividad futura.",
    capitalFlows: "Flujos netos de capital (cuenta financiera de la balanza de pagos). Positivo = entrada neta de inversi√≥n extranjera ‚Üí demanda estructural de la divisa. Millones USD.",
    inflationExpectations: "Expectativas de inflaci√≥n a 1-2 a√±os. Si superan el objetivo del BC (2%), presionan al alza las tasas futuras ‚Üí hawkish impl√≠cito.",
    termsOfTrade: "√çndice de t√©rminos de intercambio: ratio entre el precio de las exportaciones y el precio de las importaciones (base 100). Un valor >100 significa que el pa√≠s recibe m√°s valor por sus exportaciones de lo que paga por sus importaciones ‚Üí mejora cuenta corriente ‚Üí positivo para la divisa. Especialmente relevante para AUD, CAD y NZD (econom√≠as exportadoras de commodities). Para EUR se calcula como ratio de los √≠ndices de precios de exportaci√≥n e importaci√≥n extrazona (ambos de Eurostat v√≠a Trading Economics, base 2015=100). Fuente: Trading Economics."
};

        // ========== COMPONENTE PRINCIPAL ==========
        const ForexDashboard = () => {
            const [activeTab, setActiveTab] = useState('overview');
            const [forexRates, setForexRates] = useState({});
            const [economicData, setEconomicData] = useState({});
            const [dynamicAlerts, setDynamicAlerts] = useState([]);
            const [economicCalendar, setEconomicCalendar] = useState({ events: [], lastUpdate: null, source: null, impactCounts: {}, currencyCounts: {} });
            const [calFilter, setCalFilter] = useState('all');
            const [lastUpdate, setLastUpdate] = useState(null);
            const [historicalData, setHistoricalData] = useState({});
            const [dataLoadingStatus, setDataLoadingStatus] = useState({ status: 'Inicializando...', progress: 0 });
            const [isLoading, setIsLoading] = useState(true);
            const chartRefs = useRef({});

            const createCharts = () => {
                Object.values(chartRefs.current).forEach(chart => {
                    if (chart) {
                        try {
                            chart.destroy();
                        } catch (e) {
                            console.warn('Error destroying chart:', e);
                        }
                    }
                });
                chartRefs.current = {};

                setTimeout(() => {
                    countries.forEach(country => {
                        const canvas = document.getElementById(`chart-${country.code}`);
                        if (!canvas) {
                            console.warn(`Canvas not found for ${country.code}`);
                            return;
                        }

                        const ctx = canvas.getContext('2d');
                        const data = historicalData[country.code];

                        if (!data?.labels || !data?.rates || !data?.strength) {
                            console.warn(`No data for ${country.code}`);
                            return;
                        }

                        try {
                            chartRefs.current[country.code] = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: data.labels,
                                    datasets: [
                                        {
                                            label: 'Tasa de Inter√©s (%)',
                                            data: data.rates,
                                            borderColor: '#1e88e5',
                                            backgroundColor: 'rgba(30, 136, 229, 0.1)',
                                            yAxisID: 'y',
                                            tension: 0.4,
                                            borderWidth: 2,
                                            pointRadius: 3,
                                            pointHoverRadius: 5
                                        },
                                        {
                                            label: '√çndice de Fortaleza',
                                            data: data.strength,
                                            borderColor: '#26a69a',
                                            backgroundColor: 'rgba(38, 166, 154, 0.1)',
                                            yAxisID: 'y1',
                                            tension: 0.4,
                                            borderWidth: 2,
                                            pointRadius: 3,
                                            pointHoverRadius: 5
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    interaction: {
                                        mode: 'index',
                                        intersect: false
                                    },
                                    plugins: {
                                        legend: { 
                                            labels: { 
                                                color: '#e1e4e8', 
                                                font: { size: 12 },
                                                padding: 15
                                            } 
                                        },
                                        title: { 
                                            display: true, 
                                            text: `${country.code} - Tendencias 6 Meses`, 
                                            color: '#e1e4e8', 
                                            font: { size: 14, weight: 'bold' },
                                            padding: { bottom: 20 }
                                        },
                                        tooltip: {
                                            backgroundColor: 'rgba(26, 31, 46, 0.95)',
                                            titleColor: '#e1e4e8',
                                            bodyColor: '#8b949e',
                                            borderColor: '#30363d',
                                            borderWidth: 1
                                        }
                                    },
                                    scales: {
                                        y: { 
                                            type: 'linear', 
                                            position: 'left', 
                                            grid: { color: '#30363d' }, 
                                            ticks: { color: '#8b949e' }, 
                                            title: { 
                                                display: true, 
                                                text: 'Tasa %', 
                                                color: '#8b949e' 
                                            } 
                                        },
                                        y1: { 
                                            type: 'linear', 
                                            position: 'right', 
                                            grid: { display: false }, 
                                            ticks: { color: '#8b949e' }, 
                                            title: { 
                                                display: true, 
                                                text: 'Fortaleza', 
                                                color: '#8b949e' 
                                            } 
                                        },
                                        x: { 
                                            grid: { color: '#30363d' }, 
                                            ticks: { color: '#8b949e' } 
                                        }
                                    }
                                }
                            });
                            console.log(`‚úÖ Chart created for ${country.code}`);
                        } catch (error) {
                            console.error(`Error creating chart for ${country.code}:`, error);
                        }
                    });
                }, 250);
            };

const HeatmapCell = ({ value, type, currency, indicator, lastUpdate }) => {
    const cellRef = React.useRef(null);
    const [showTooltip, setShowTooltip] = React.useState(false);
    const [tooltipPosition, setTooltipPosition] = React.useState({ x: 0, y: 0 });

const updateCellTooltipPos = (e) => {
        const tooltipWidth = 220;
        const tooltipHeight = 55;
        const offset = 14;
        const margin = 10;
        let x = e.clientX;
        let y = e.clientY + offset;
        if (x + tooltipWidth > window.innerWidth - margin) x = window.innerWidth - tooltipWidth - margin;
        if (x < margin) x = margin;
        if (y + tooltipHeight > window.innerHeight - margin) y = e.clientY - tooltipHeight - offset;
        setTooltipPosition({ x, y });
    };

    const handleMouseEnter = (e) => {
        if (!lastUpdate) return;
        updateCellTooltipPos(e);
        setShowTooltip(true);
    };

    const handleMouseMove = (e) => {
        if (showTooltip) updateCellTooltipPos(e);
    };

    const handleMouseLeave = () => {
        setShowTooltip(false);
    };

    const formatDate = (dateString) => {
        if (!dateString) return 'N/D';
        try {
            const date = new Date(dateString);
            const today = new Date();
            const diffTime = Math.abs(today - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Hoy';
            if (diffDays === 1) return 'Ayer';
            if (diffDays <= 7) return `${diffDays}d`;
            if (diffDays <= 30) return `${Math.floor(diffDays / 7)}sem`;
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        } catch {
            return dateString;
        }
    };

    const indicatorNames = {
        'gdp': 'PIB',
        'gdpGrowth': 'Crecimiento PIB',
        'interestRate': 'Tasa de Inter√©s',
        'inflation': 'Inflaci√≥n',
        'unemployment': 'Desempleo',
        'currentAccount': 'Cuenta Corriente',
        'debt': 'Deuda P√∫blica',
        'tradeBalance': 'Balanza Comercial',
        'production': 'Producci√≥n Industrial',
        'retailSales': 'Ventas Minoristas',
        'wageGrowth': 'Crecimiento Salarial',
        'manufacturingPMI': 'PMI Manufacturero',
        'cotPositioning': 'COT Positioning',
        'bond10y': 'Bono 10Y',
        'consumerConfidence': 'Conf. Consumidor',
        'businessConfidence': 'Conf. Empresarial',
        'capitalFlows': 'Flujos de Capital',
        'inflationExpectations': 'Exp. Inflaci√≥n',
    };

    // Crear el contenido del tooltip
    React.useEffect(() => {
        if (showTooltip && lastUpdate) {
            // Crear tooltip en el body
            let tooltip = document.getElementById('global-heatmap-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'global-heatmap-tooltip';
                tooltip.className = 'heatmap-cell-tooltip';
                document.body.appendChild(tooltip);
            }
            
            tooltip.innerHTML = `
                <span class="tooltip-date">üìÖ ${formatDate(lastUpdate)}</span>
                <span class="tooltip-indicator">${currency} - ${indicatorNames[indicator] || indicator}</span>
            `;
            tooltip.style.left = `${tooltipPosition.x}px`;
            tooltip.style.top = `${tooltipPosition.y}px`;
            tooltip.style.transform = 'none';
            tooltip.classList.add('visible');
        } else {
            const tooltip = document.getElementById('global-heatmap-tooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        }
        
        return () => {
            const tooltip = document.getElementById('global-heatmap-tooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        };
    }, [showTooltip, tooltipPosition, lastUpdate, currency, indicator]);

    return (
        <td 
            ref={cellRef}
            style={{ background: getHeatmapColor(value, type) }}
            data-has-date={lastUpdate ? "true" : "false"}
            onMouseEnter={handleMouseEnter}
            onMouseMove={handleMouseMove}
            onMouseLeave={handleMouseLeave}
        >
            {type === 'gdp' ? (
                <>
                    <span className="cell-value">{formatValue(value, 2)}</span>
                    <span className="cell-suffix">T USD</span>
                </>
            ) : type === 'gdpGrowth' || type === 'interestRate' || type === 'inflation' || type === 'unemployment' || type === 'production' || type === 'retailSales' || type === 'wageGrowth' ? (
                <span className="cell-value">{value > 0 && (type === 'production' || type === 'retailSales') ? '+' : ''}{formatValue(value, type === 'interestRate' ? 2 : 1)}%</span>
            ) : type === 'currentAccount' || type === 'debt' ? (
                <span className="cell-value">{value > 0 && type === 'currentAccount' ? '+' : ''}{formatValue(value)}%</span>
            ) : type === 'tradeBalance' ? (
                <span className="cell-value">{value > 0 ? '+' : ''}{(value / 1000).toFixed(1)}B</span>
            ) : type === 'manufacturingPMI' ? (
                <span className="cell-value">{formatValue(value, 1)}</span>
            ) : type === 'cotPositioning' ? (
                value !== null && value !== undefined ? (
                    <span className="cell-value">
                        {value > 0 ? '+' : ''}
                        {(value / 1000).toFixed(1)}K
                    </span>
                ) : (
                    <span className="cell-value" style={{ color: 'var(--text-tertiary)' }}>N/A</span>
                )
) : type === 'bond10y' || type === 'inflationExpectations' ? (
                <span className="cell-value">{formatValue(value, 2)}%</span>
) : type === 'termsOfTrade' ? (
                <span className="cell-value">{formatValue(value, 1)}</span>
            ) : type === 'consumerConfidence' || type === 'businessConfidence' ? (
                <span className="cell-value">{formatValue(value, 1)}</span>
            ) : type === 'capitalFlows' ? (
                value !== null && value !== undefined ? (
                    <span className="cell-value">
                        {value > 0 ? '+' : ''}{(value / 1000).toFixed(1)}B
                    </span>
                ) : (
                    <span className="cell-value" style={{ color: 'var(--text-tertiary)' }}>N/A</span>
                )
            ) : (
                <span className="cell-value">{formatValue(value)}</span>
            )}
        </td>
    );
};
            
const TooltipCell = ({ children, tooltip, title }) => {
    const [showTooltip, setShowTooltip] = React.useState(false);
    const [position, setPosition] = React.useState({ x: 0, y: 0 });

    const updatePosition = (e) => {
        const tooltipWidth = 340;
        const tooltipHeight = 200;
        const offset = 14;
        const margin = 12;
        let x = e.clientX;
        let y = e.clientY + offset;
        if (x + tooltipWidth > window.innerWidth - margin) x = window.innerWidth - tooltipWidth - margin;
        if (x < margin) x = margin;
        if (y + tooltipHeight > window.innerHeight - margin) y = e.clientY - tooltipHeight - offset;
        setPosition({ x, y });
    };

    const handleMouseEnter = (e) => { updatePosition(e); setShowTooltip(true); };
    const handleMouseMove  = (e) => { if (showTooltip) updatePosition(e); };

    return (
        <th className="tooltip-header">
            {children}
            <span
                className="tooltip-icon"
                onMouseEnter={handleMouseEnter}
                onMouseMove={handleMouseMove}
                onMouseLeave={() => setShowTooltip(false)}
            >?</span>
            {showTooltip && (
                <div className="tooltip-box visible" style={{ left: `${position.x}px`, top: `${position.y}px`, transform: 'none' }}>
                    <div className="tooltip-header-title">{title}</div>
                    <div className="tooltip-body">{tooltip}</div>
                </div>
            )}
        </th>
    );
};

const getHeatmapColor = (value, type) => {
    if (value === null || value === undefined) return 'var(--bg-card)';
    let intensity = 0;
    let isPositive = true;

    switch (type) {
        case 'gdp':
            return 'var(--bg-card)';

        case 'gdpGrowth':
            if (value >= 2.5)      { intensity = 1.0; isPositive = true;  }
            else if (value >= 1.5) { intensity = 0.6; isPositive = true;  }
            else if (value >= 0.5) { intensity = 0.4; isPositive = false; }
            else { intensity = Math.min(Math.abs(value - 0.5) / 2, 1); isPositive = false; }
            break;

        case 'interestRate':
            if (value >= 4.0)      { intensity = Math.min((value - 4.0) / 2, 1); isPositive = true;  }
            else if (value >= 2.0) { intensity = 0.3;  isPositive = true;  }
            else if (value >= 0.5) { intensity = 0.5;  isPositive = false; }
            else                   { intensity = 1.0;  isPositive = false; }
            break;

        case 'inflation':
        case 'inflationExpectations':
            if (value >= 1.8 && value <= 2.5) { intensity = 0.8; isPositive = true;  }
            else if (value > 2.5 && value <= 3.5) { intensity = 0.3; isPositive = true;  }
            else if (value > 3.5) { intensity = Math.min((value - 3.5) / 2, 1); isPositive = false; }
            else { intensity = Math.min((1.8 - value) / 1.5, 1); isPositive = false; }
            break;

        case 'unemployment':
            if (value < 4.0)      { intensity = 0.8; isPositive = true;  }
            else if (value < 6.0) { intensity = 0.3; isPositive = true;  }
            else { intensity = Math.min((value - 6.0) / 4, 1); isPositive = false; }
            break;

        case 'currentAccount':
            intensity = Math.min(Math.abs(value) / 15, 1);  // value = % PIB, m√°x ~15%
            isPositive = value > 0;
            break;

        case 'tradeBalance':
            intensity = Math.min(Math.abs(value) / 15000, 1);  // value = millones USD, m√°x ~$15B
            isPositive = value > 0;
            break;

        case 'debt':
            if (value < 60)       { intensity = 0.7; isPositive = true;  }
            else if (value < 90)  { intensity = 0.3; isPositive = true;  }
            else { intensity = Math.min((value - 90) / 100, 1); isPositive = false; }
            break;

        case 'production':
            if (value > 1.5)     { intensity = Math.min(value / 3, 1); isPositive = true;  }
            else if (value > 0)  { intensity = 0.3; isPositive = true;  }
            else { intensity = Math.min(Math.abs(value) / 3, 1); isPositive = false; }
            break;

        case 'retailSales':
            if (value > 0.5)     { intensity = Math.min(value / 1.5, 1); isPositive = true;  }
            else if (value > 0)  { intensity = 0.3; isPositive = true;  }
            else { intensity = Math.min(Math.abs(value) / 1.5, 1); isPositive = false; }
            break;

        case 'wageGrowth':
            if (value >= 2.5 && value <= 4.5)      { intensity = 0.8; isPositive = true;  }
            else if (value > 4.5 && value <= 6.0)  { intensity = 0.4; isPositive = true;  }
            else if (value > 6.0) { intensity = Math.min((value - 6.0) / 3, 1); isPositive = false; }
            else { intensity = Math.min((2.5 - value) / 2, 1); isPositive = false; }
            break;

        case 'manufacturingPMI':
            if (value > 52)       { intensity = Math.min((value - 50) / 10, 1); isPositive = true;  }
            else if (value >= 50) { intensity = 0.3;  isPositive = true;  }
            else if (value >= 48) { intensity = 0.4;  isPositive = false; }
            else { intensity = Math.min((50 - value) / 10, 1); isPositive = false; }
            break;

        case 'cotPositioning':
            if (value === 0)       return 'var(--bg-card)';
            if (value > 20000)     { intensity = 0.8; isPositive = true;  }
            else if (value > 10000){ intensity = 0.7; isPositive = true;  }
            else if (value > 5000) { intensity = 0.5; isPositive = true;  }
            else if (value > 0)    { intensity = 0.3; isPositive = true;  }
            else if (value > -5000){ intensity = 0.3; isPositive = false; }
            else if (value > -10000){ intensity = 0.5; isPositive = false; }
            else if (value > -20000){ intensity = 0.7; isPositive = false; }
            else                   { intensity = 0.8; isPositive = false; }
            break;

        case 'bond10y':
            if (value >= 4.0)      { intensity = Math.min((value - 4.0) / 2, 1); isPositive = true;  }
            else if (value >= 2.5) { intensity = 0.35; isPositive = true;  }
            else if (value >= 1.0) { intensity = 0.4;  isPositive = false; }
            else { intensity = Math.min((1.0 - value) / 1.5, 1); isPositive = false; }
            break;

        case 'consumerConfidence':
        case 'businessConfidence':
            if (value > 105)      { intensity = Math.min((value - 105) / 15, 1); isPositive = true;  }
            else if (value >= 100){ intensity = 0.3;  isPositive = true;  }
            else if (value >= 95) { intensity = 0.3;  isPositive = false; }
            else { intensity = Math.min((95 - value) / 20, 1); isPositive = false; }
            break;

        case 'capitalFlows':
            if (value > 20000)     { intensity = Math.min(value / 100000, 1); isPositive = true;  }
            else if (value > 0)    { intensity = 0.3; isPositive = true;  }
            else if (value > -20000){ intensity = 0.4; isPositive = false; }
            else { intensity = Math.min(Math.abs(value) / 100000, 1); isPositive = false; }
            break;

        case 'termsOfTrade':
            // Index base 100: >103 = favorable, <97 = unfavorable
            if (value >= 110)      { intensity = Math.min((value - 110) / 20, 1); isPositive = true;  }
            else if (value >= 103) { intensity = 0.6; isPositive = true;  }
            else if (value >= 100) { intensity = 0.3; isPositive = true;  }
            else if (value >= 95)  { intensity = 0.4; isPositive = false; }
            else                   { intensity = Math.min((95 - value) / 15, 1); isPositive = false; }
            break;

        default:
            return 'var(--bg-card)';
    }

    // Apply colour tiers
    if (isPositive) {
        if (intensity > 0.7) return '#26a69a';
        if (intensity > 0.4) return '#00897b';
        return '#00695c';
    } else {
        if (intensity > 0.7) return '#ef5350';
        if (intensity > 0.4) return '#e53935';
        return '#c62828';
    }
};

const getSentiment = (strength) => {
    const numStrength = typeof strength === 'object' && strength.score !== undefined 
        ? strength.score 
        : (typeof strength === 'string' ? parseFloat(strength) : strength);
    
    // Umbrales institucionales (distribuci√≥n normal esperada)
    if (numStrength >= 62) return 'alcista';   // Top 30% (~2-3 divisas)
    if (numStrength <= 45) return 'bajista';   // Bottom 30% (~2-3 divisas)
    return 'neutral';                          // Middle 40% (~3-4 divisas)
};

const generateAnalysis = (currency, forexRates, economicData) => {
    if (!economicData[currency]) return 'Cargando datos...';
    const data = economicData[currency];
    const country = countries.find(c => c.code === currency);
    
    // ‚úÖ CORRECCI√ìN: Obtener objeto y extraer score
    const strengthObj = calculateStrength(currency, data, forexRates, economicData);
    const strength = strengthObj.score;
    const sentiment = getSentiment(strength);

    // ‚úÖ Helper function para formatear valores de forma segura
    const fmt = (val, decimals = 1) => {
        if (val === null || val === undefined) return null;
        return val.toFixed(decimals);
    };

    let analysis = [];
    
    // 1. INTRODUCCI√ìN BASADA EN FORTALEZA Y TENDENCIA
    const strengthStr = fmt(strength);
    if (sentiment === 'alcista') {
        analysis.push(`${currency} registra fortaleza fundamental s√≥lida (√≠ndice ${strengthStr}) respaldada por condiciones macroecon√≥micas favorables.`);
    } else if (sentiment === 'bajista') {
        analysis.push(`${currency} muestra debilidad estructural (√≠ndice ${strengthStr}) con m√∫ltiples indicadores bajo presi√≥n.`);
    } else {
        analysis.push(`${currency} mantiene posici√≥n neutral (√≠ndice ${strengthStr}) con factores mixtos que se compensan.`);
    }
    
    // 2. AN√ÅLISIS DE POL√çTICA MONETARIA
    if (country && data.interestRate !== null && data.interestRate !== undefined) {
        const rateStr = fmt(data.interestRate, 2);
        
        if (country.outlook === 'Hawkish') {
            if (data.inflation !== null && data.inflation > 2.5) {
                const inflStr = fmt(data.inflation);
                analysis.push(`${country.centralBank} mantiene postura hawkish con tasa en ${rateStr}% para controlar inflaci√≥n de ${inflStr}%.`);
            } else if (data.inflation !== null) {
                const inflStr = fmt(data.inflation);
                analysis.push(`${country.centralBank} en modo restrictivo (${rateStr}%) a pesar de inflaci√≥n moderada de ${inflStr}%.`);
            } else {
                analysis.push(`${country.centralBank} mantiene postura hawkish con tasa en ${rateStr}%.`);
            }
        } else if (country.outlook === 'Dovish') {
            if (data.gdpGrowth !== null && data.gdpGrowth < 1.0) {
                const gdpStr = fmt(data.gdpGrowth);
                analysis.push(`${country.centralBank} adopta postura dovish (tasa ${rateStr}%) ante desaceleraci√≥n econ√≥mica de ${gdpStr}%.`);
            } else {
                analysis.push(`${country.centralBank} mantiene pol√≠tica acomodaticia con tasa en ${rateStr}% buscando estimular crecimiento.`);
            }
        } else {
            analysis.push(`${country.centralBank} en pausa estrat√©gica (${rateStr}%) evaluando datos antes de pr√≥ximo movimiento.`);
        }
    }
    
    // 3. AN√ÅLISIS DE BALANZA COMERCIAL Y CUENTA CORRIENTE
    if (data.tradeBalance !== null && data.tradeBalance !== undefined) {
        if (data.tradeBalance > 1000) {
            const tbStr = (data.tradeBalance / 1000).toFixed(1);
            analysis.push(`Super√°vit comercial robusto de $${tbStr}B mensuales sostiene demanda estructural de ${currency}.`);
        } else if (data.tradeBalance < -10000) {
            const tbStr = Math.abs(data.tradeBalance / 1000).toFixed(1);
            analysis.push(`D√©ficit comercial significativo de $${tbStr}B mensuales presiona sobre la divisa.`);
        }
    }
    
    if (data.currentAccount !== null && data.currentAccount !== undefined) {
        const caStr = fmt(data.currentAccount);
        if (data.currentAccount > 3) {
            analysis.push(`Cuenta corriente superavitaria (+${caStr}% PIB) refuerza posici√≥n externa.`);
        } else if (data.currentAccount < -3) {
            analysis.push(`D√©ficit en cuenta corriente (${caStr}% PIB) genera vulnerabilidad externa.`);
        }
    }
    
    // 4. AN√ÅLISIS ESPEC√çFICO POR DIVISA
    if (currency === 'USD') {
        if (data.gdpGrowth !== null && data.gdpGrowth !== undefined) {
            const gdpStr = fmt(data.gdpGrowth);
            if (data.gdpGrowth > 2.5) {
                analysis.push(`Econom√≠a estadounidense en expansi√≥n s√≥lida (${gdpStr}%) mantiene atractivo del d√≥lar como activo refugio.`);
            } else {
                analysis.push(`Desaceleraci√≥n econ√≥mica dom√©stica (${gdpStr}%) limita potencial alcista del d√≥lar.`);
            }
        }
    } else if (currency === 'EUR') {
        if (data.debt !== null && data.debt > 90) {
            const debtStr = fmt(data.debt, 0);
            analysis.push(`Carga de deuda elevada (${debtStr}% PIB) en contexto de crecimiento d√©bil limita margen del BCE.`);
        }
    } else if (currency === 'JPY') {
        if (data.debt !== null && data.debt > 200) {
            const debtStr = fmt(data.debt, 0);
            analysis.push(`Deuda p√∫blica extrema (${debtStr}% PIB) pero status de safe haven mantiene demanda en aversi√≥n al riesgo.`);
        }
        if (data.interestRate !== null && data.interestRate < 0.5) {
            analysis.push(`Pol√≠tica ultra-acomodaticia del BoJ mantiene diferencial negativo frente a otras divisas.`);
        }
    } else if (currency === 'GBP') {
        if (data.inflation !== null && data.inflation > 3.0) {
            const inflStr = fmt(data.inflation);
            analysis.push(`Inflaci√≥n persistente (${inflStr}%) fuerza al BoE a mantener pol√≠tica restrictiva.`);
        }
    } else if (currency === 'CHF') {
        if (data.inflation !== null && data.inflation < 1.5 && data.debt !== null && data.debt < 50) {
            const inflStr = fmt(data.inflation);
            const debtStr = fmt(data.debt, 0);
            analysis.push(`Estabilidad de precios (${inflStr}%) y deuda baja (${debtStr}% PIB) sustentan fortaleza del franco.`);
        }
    } else if (currency === 'AUD' || currency === 'NZD' || currency === 'CAD') {
        if (data.production !== null && data.production < 0) {
            const prodStr = fmt(data.production);
            analysis.push(`Debilidad en sector industrial (${prodStr}%) refleja desaf√≠os en econom√≠a dependiente de commodities.`);
        } else if (data.tradeBalance !== null && data.tradeBalance > 1000) {
            analysis.push(`Exportaciones de materias primas sostienen super√°vit comercial y demanda de ${currency}.`);
        }
    }
    
    // 5. AN√ÅLISIS DE CRECIMIENTO Y DESEMPLEO
    if (data.gdpGrowth !== null && data.gdpGrowth !== undefined && 
        data.unemployment !== null && data.unemployment !== undefined) {
        const gdpStr = fmt(data.gdpGrowth);
        const unempStr = fmt(data.unemployment);
        
        if (data.gdpGrowth > 2.5 && data.unemployment < 4.0) {
            analysis.push(`Combinaci√≥n de crecimiento robusto (${gdpStr}%) y pleno empleo (${unempStr}%) caracteriza entorno s√≥lido.`);
        } else if (data.gdpGrowth < 1.0 && data.unemployment > 6.0) {
            analysis.push(`Estancamiento con crecimiento d√©bil (${gdpStr}%) y desempleo elevado (${unempStr}%) complica panorama.`);
        } else if (data.gdpGrowth < 0) {
            analysis.push(`Contracci√≥n econ√≥mica (${gdpStr}%) eleva riesgos de recesi√≥n y presi√≥n sobre la divisa.`);
        }
    }
    
    // 6. AN√ÅLISIS DE CONSUMO Y MOMENTUM (NUEVOS INDICADORES)
    if (data.retailSales !== null && data.retailSales !== undefined && 
        data.wageGrowth !== null && data.wageGrowth !== undefined) {
        const rsStr = fmt(data.retailSales);
        const wgStr = fmt(data.wageGrowth);
        
        if (data.retailSales > 0.5 && data.wageGrowth > 3.0) {
            analysis.push(`Consumo dom√©stico robusto con ventas minoristas +${rsStr}% y salarios creciendo ${wgStr}% anual sostiene demanda agregada.`);
        } else if (data.retailSales < -0.3) {
            analysis.push(`Debilidad en consumo con ventas minoristas ${rsStr}% se√±ala desaceleraci√≥n en demanda dom√©stica.`);
        }
    }

    // 7. AN√ÅLISIS DE ACTIVIDAD MANUFACTURERA
    if (data.manufacturingPMI !== null && data.manufacturingPMI !== undefined) {
        const pmiStr = fmt(data.manufacturingPMI, 1);
        
        if (data.manufacturingPMI > 55) {
            analysis.push(`Sector manufacturero en fuerte expansi√≥n (PMI ${pmiStr}) impulsa crecimiento econ√≥mico.`);
        } else if (data.manufacturingPMI > 50) {
            analysis.push(`Manufactura en expansi√≥n moderada (PMI ${pmiStr}) mantiene momentum positivo.`);
        } else if (data.manufacturingPMI < 45) {
            analysis.push(`Sector manufacturero en contracci√≥n aguda (PMI ${pmiStr}) presagia debilidad econ√≥mica.`);
        } else {
            analysis.push(`Manufactura en contracci√≥n (PMI ${pmiStr}) reduce perspectivas de crecimiento.`);
        }
    }

// 8. AN√ÅLISIS DE POSICIONAMIENTO ESPECULATIVO (COT)
if (data.cotPositioning !== null && data.cotPositioning !== undefined) {
    const cotK = (data.cotPositioning / 1000).toFixed(1);
    
    if (data.cotPositioning > 30000) {
        analysis.push(`Posicionamiento especulativo extremadamente alcista (+${cotK}K contratos netos) sugiere saturaci√≥n del mercado y riesgo elevado de toma de ganancias.`);
    } else if (data.cotPositioning > 15000) {
        analysis.push(`Fuerte posicionamiento alcista de traders especulativos (+${cotK}K contratos) respalda momentum alcista, aunque con posible resistencia cerca.`);
    } else if (data.cotPositioning > 5000) {
        analysis.push(`Posicionamiento moderadamente alcista (+${cotK}K contratos) refleja confianza del mercado y sostiene tendencia alcista.`);
    } else if (data.cotPositioning > 0) {
        analysis.push(`Leve sesgo alcista en posicionamiento especulativo (+${cotK}K contratos) indica cautela pero con tendencia positiva.`);
    } else if (data.cotPositioning > -5000) {
        analysis.push(`Posicionamiento ligeramente bajista (${cotK}K contratos) refleja cautela y presi√≥n vendedora moderada.`);
    } else if (data.cotPositioning > -15000) {
        analysis.push(`Sentimiento bajista entre especuladores (${cotK}K contratos netos) amplifica presi√≥n vendedora y debilita soporte t√©cnico.`);
    } else if (data.cotPositioning > -30000) {
        analysis.push(`Fuerte posicionamiento bajista (${cotK}K contratos) se√±ala convicci√≥n vendedora y riesgo de continuidad bajista.`);
    } else {
        analysis.push(`Posicionamiento bajista extremo (${cotK}K contratos) sugiere posible capitulaci√≥n; podr√≠a catalizar rebote t√©cnico si fundamentos cambian.`);
    }
}

    // 8B. AN√ÅLISIS DE BONOS Y FLUJOS (NUEVOS INDICADORES)
    if (data.bond10y !== null && data.bond10y !== undefined) {
        const b10y = fmt(data.bond10y, 2);
        if (data.bond10y >= 4.0) {
            analysis.push(`Yield del bono soberano a 10 a√±os en ${b10y}% atrae flujos de carry trade internacionales.`);
        } else if (data.bond10y < 1.0) {
            analysis.push(`Yield a 10 a√±os en niveles bajos (${b10y}%) reduce atractivo para inversores de renta fija extranjeros.`);
        }
    }
    
    if (data.capitalFlows !== null && data.capitalFlows !== undefined) {
        const flowsB = (data.capitalFlows / 1000).toFixed(1);
        if (data.capitalFlows > 20000) {
            analysis.push(`Flujos netos de capital positivos (+${flowsB}B) reflejan demanda estructural de inversores extranjeros por activos en ${currency}.`);
        } else if (data.capitalFlows < -20000) {
            analysis.push(`Salida neta de capitales (${flowsB}B) genera presi√≥n vendedora estructural sobre ${currency}.`);
        }
    }
    
    // 8C. AN√ÅLISIS DE CONFIANZA Y EXPECTATIVAS
    if (data.consumerConfidence !== null && data.consumerConfidence !== undefined) {
        const ccStr = fmt(data.consumerConfidence, 1);
        if (data.consumerConfidence > 108) {
            analysis.push(`Confianza del consumidor en zona de optimismo (√≠ndice ${ccStr}) anticipa expansi√≥n del gasto privado y sostiene perspectivas de crecimiento.`);
        } else if (data.consumerConfidence > 100) {
            analysis.push(`Confianza del consumidor positiva (√≠ndice ${ccStr}) se√±ala disposici√≥n al gasto en el corto plazo.`);
        } else if (data.consumerConfidence < 92) {
            analysis.push(`Confianza del consumidor deteriorada (√≠ndice ${ccStr}) anticipa contracci√≥n del consumo privado y presiona el crecimiento a la baja.`);
        } else if (data.consumerConfidence < 100) {
            analysis.push(`Confianza del consumidor en territorio pesimista (√≠ndice ${ccStr}) refleja cautela en el gasto dom√©stico.`);
        }
    }

    if (data.businessConfidence !== null && data.businessConfidence !== undefined) {
        const bcStr = fmt(data.businessConfidence, 1);
        const isNetBalance = (currency === 'NZD');
        const bcHigh  = isNetBalance ? 30 : 105;
        const bcLow   = isNetBalance ? -10 : 95;
        const bcLabel = isNetBalance ? 'balance neto' : '√≠ndice';
        if (data.businessConfidence > bcHigh) {
            analysis.push(`Confianza empresarial elevada (${bcLabel} ${bcStr}) anticipa expansi√≥n de inversi√≥n y contrataciones en los pr√≥ximos trimestres.`);
        } else if (data.businessConfidence < bcLow) {
            analysis.push(`Confianza empresarial deteriorada (${bcLabel} ${bcStr}) se√±ala reducci√≥n esperada de inversi√≥n y posibles recortes de empleo.`);
        }
    }

    if (data.inflationExpectations !== null && data.inflationExpectations !== undefined) {
        const ieStr = fmt(data.inflationExpectations, 1);
        if (data.inflationExpectations > 3.0) {
            analysis.push(`Expectativas de inflaci√≥n desancladas (${ieStr}%) presionan al banco central hacia una postura m√°s restrictiva para preservar credibilidad.`);
        } else if (data.inflationExpectations >= 1.8 && data.inflationExpectations <= 2.5) {
            analysis.push(`Expectativas de inflaci√≥n bien ancladas (${ieStr}%) refuerzan credibilidad del banco central y reducen necesidad de ajustes adicionales.`);
        } else if (data.inflationExpectations < 1.5) {
            analysis.push(`Expectativas de inflaci√≥n por debajo del objetivo (${ieStr}%) aumentan presi√≥n deflacionaria y limitan margen de maniobra del banco central.`);
        }
    }

    // 9. CONCLUSI√ìN PROSPECTIVA
    if (sentiment === 'alcista') {
        analysis.push(`Perspectivas favorables mientras fundamentos econ√≥micos se mantengan s√≥lidos y pol√≠tica monetaria evite giros abruptos.`);
    } else if (sentiment === 'bajista') {
        analysis.push(`Riesgos a la baja prevalecen en ausencia de catalizadores positivos que reviertan deterioro fundamental.`);
    } else {
        analysis.push(`Evoluci√≥n depender√° de pr√≥ximos datos econ√≥micos y se√±ales de bancos centrales sobre direcci√≥n de pol√≠tica monetaria.`);
    }
    
    return analysis.join(' ');
};

const getSortedCountries = () => {
    return [...countries].sort((a, b) => {
        const dataA = economicData[a.code] || {};
        const dataB = economicData[b.code] || {};
        
        // Primero: Ordenar por strength score
        const strengthObjA = calculateStrength(a.code, dataA, forexRates, economicData);
        const strengthObjB = calculateStrength(b.code, dataB, forexRates, economicData);
        
        const scoreA = strengthObjA.score || 50;
        const scoreB = strengthObjB.score || 50;
        
        // ‚úÖ CR√çTICO: Mayor score primero (descendente)
        if (Math.abs(scoreA - scoreB) > 0.1) {
            return scoreB - scoreA;
        }
        
        // Desempate: Contar celdas verdes
        const indicators = [
            'gdpGrowth', 'interestRate', 'inflation', 'unemployment',
            'currentAccount', 'debt', 'tradeBalance', 'production',
            'retailSales', 'wageGrowth', 'manufacturingPMI', 'cotPositioning',
            'bond10y', 'consumerConfidence', 'businessConfidence',
            'capitalFlows', 'inflationExpectations'
        ];
        
        let greenCellsA = 0;
        let greenCellsB = 0;
        
        indicators.forEach(indicator => {
            const valueA = dataA[indicator];
            const valueB = dataB[indicator];
            
            if (valueA !== null && valueA !== undefined && !isNaN(valueA)) {
                const colorA = getHeatmapColor(valueA, indicator);
                if (colorA.includes('#26a69a') || colorA.includes('#00897b') || colorA.includes('#00695c')) {
                    greenCellsA++;
                }
            }
            
            if (valueB !== null && valueB !== undefined && !isNaN(valueB)) {
                const colorB = getHeatmapColor(valueB, indicator);
                if (colorB.includes('#26a69a') || colorB.includes('#00897b') || colorB.includes('#00695c')) {
                    greenCellsB++;
                }
            }
        });
        
        // ‚úÖ M√°s celdas verdes primero
        return greenCellsB - greenCellsA;
    });
};

const hasCOTData = () => {
    const currencies = ['EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'NZD'];
    const cotAvailable = currencies.filter(curr => {
        const data = economicData[curr];
        return data && data.cotPositioning !== null && data.cotPositioning !== undefined;
    });
    return cotAvailable.length >= 4; // At least 4 currencies have COT data
};
            
            const formatValue = (value, decimals = 1) => {
                if (value === null || value === undefined) return 'N/D';
                return value.toFixed(decimals);
            };
            
            useEffect(() => {
                const loadInitialData = async () => {
                    setIsLoading(true);
                    try {
                        setDataLoadingStatus({ status: 'Cargando tipos de cambio...', progress: 10 });
                        const rates = await fetchForexRates();
                        setForexRates(rates);
                        setLastUpdate(new Date());

                        const loadedData = await loadAllEconomicData(setEconomicData, setDataLoadingStatus);
                        
                        setDataLoadingStatus({ status: 'Cargando calendario econ√≥mico...', progress: 92 });
                        const calendarResult = await fetchEconomicCalendar();
                        setEconomicCalendar(calendarResult);

                        const historical = await generateHistoricalData(loadedData, setDataLoadingStatus);
                        setHistoricalData(historical);

                        setDataLoadingStatus({ status: 'Generando recomendaciones de pares...', progress: 98 });
                        const pairRecommendations = generateForexPairRecommendations(loadedData, rates);
setDynamicAlerts(pairRecommendations);

                        setDataLoadingStatus({ status: 'Completado', progress: 100 });
                        setIsLoading(false);
                    } catch (error) {
                        console.error('Error loading initial data:', error);
                        setIsLoading(false);
                    }
                };

                loadInitialData();

                const ratesInterval = setInterval(async () => {
                    const rates = await fetchForexRates();
                    setForexRates(rates);
                    setLastUpdate(new Date());
                }, 60000);

                return () => clearInterval(ratesInterval);
            }, []);

            useEffect(() => {
                if (activeTab === 'trends' && Object.keys(historicalData).length > 0) {
                    const timer = setTimeout(() => {
                        createCharts();
                    }, 200);
                    return () => clearTimeout(timer);
                }
                return () => {
                    Object.values(chartRefs.current).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    chartRefs.current = {};
                };
            }, [activeTab, historicalData]);

const DataHealthCheck = ({ economicData }) => {
    const [health, setHealth] = useState(null);
    
    useEffect(() => {
        if (Object.keys(economicData).length > 0) {
            const healthStatus = checkDataHealth(economicData);
            setHealth(healthStatus);
        }
    }, [economicData]);
    
    if (!health) return null;
    
    // No mostrar si todo est√° bien
    if (health.healthy && health.warnings.length === 0) return null;
    
    return (
        <div style={{ marginBottom: '1.5rem' }}>
            {health.issues.length > 0 && (
                <div className="alert-card alert-warning" style={{ marginBottom: '1rem' }}>
                    <div className="alert-icon" style={{ 
                        background: 'rgba(239, 83, 80, 0.3)',
                        color: 'var(--red-strong)'
                    }}>
                        ‚ö†Ô∏è
                    </div>
                    <div className="alert-content">
                        <h3>Problemas de Calidad de Datos Detectados</h3>
                        <ul style={{ 
                            marginTop: '0.75rem', 
                            paddingLeft: '1.5rem',
                            fontSize: '0.875rem',
                            lineHeight: '1.8'
                        }}>
                            {health.issues.map((issue, i) => (
                                <li key={i}>{issue}</li>
                            ))}
                        </ul>
                        <p style={{ 
                            marginTop: '0.75rem',
                            fontSize: '0.8125rem',
                            color: 'var(--text-secondary)'
                        }}>
                            Los datos pueden estar desactualizados o incompletos. 
                            Considera refrescar el cach√© o esperar a la pr√≥xima actualizaci√≥n autom√°tica.
                        </p>
                    </div>
                </div>
            )}
            
            {health.warnings.length > 0 && (
                <div className="alert-card alert-info" style={{ marginBottom: '1rem' }}>
                    <div className="alert-icon" style={{ 
                        background: 'rgba(255, 111, 0, 0.3)',
                        color: 'var(--orange)'
                    }}>
                        ‚ÑπÔ∏è
                    </div>
                    <div className="alert-content">
                        <h3>Avisos de Calidad de Datos</h3>
                        <ul style={{ 
                            marginTop: '0.75rem', 
                            paddingLeft: '1.5rem',
                            fontSize: '0.875rem',
                            lineHeight: '1.8'
                        }}>
                            {health.warnings.map((warning, i) => (
                                <li key={i}>{warning}</li>
                            ))}
                        </ul>
                    </div>
                </div>
            )}
        </div>
    );
};
            
            if (isLoading) {
                return (
                    <div className="app-container">
                        <div className="header">
                            <div className="header-content">
                                <div>
                                    <div className="brand-title">An√°lisis Fundamental Forex</div>
                                    <div className="brand-subtitle">Dashboard Profesional</div>
                                </div>
                                <div className="header-info">
                                    <div className="info-item">
                                        <div className="status-loading"></div>
                                        <span>Cargando Datos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="content">
                            <div className="loading-container">
                                <div className="loading-spinner"></div>
                                <div className="loading-text">{dataLoadingStatus.status}</div>
                                <div className="loading-progress">
                                    <div className="loading-progress-bar" style={{ width: `${dataLoadingStatus.progress}%` }}></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="header-content">
                            <div>
                                <div className="brand-title">An√°lisis Fundamental Forex</div>
                                <div className="brand-subtitle">Dashboard Profesional</div>
                            </div>
<div className="page-nav-links">
                                <a href="about.html">Acerca de</a>
                                <a href="terms.html">T√©rminos</a>
                                <a href="privacy.html">Privacidad</a>
                                <a href="contact.html">Contacto</a>
                            </div>
<div className="header-info">
    <div className="info-item">
        <div className="status-live"></div>
        <span>Datos en Vivo</span>
    </div>
{lastUpdate && (
    <div className="info-item">
        <span>FX Rates: {lastUpdate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
    </div>
)}
{Object.keys(economicData).length > 0 && (
    <div className="info-item">
        <span>Datos econ√≥micos: {getCacheAge(economicData)}</span>
        {isCacheStale(economicData) && (
            <span style={{ 
                marginLeft: '0.5rem', 
                color: 'var(--orange)',
                fontSize: '1rem'
            }}>‚ö†Ô∏è</span>
        )}
    </div>
)}
{hasCOTData() ? (
    <div className="info-item">
        <div className="status-live"></div>
        <span>COT Disponible</span>
        {(() => {
            // Mostrar fecha del √∫ltimo reporte COT
            const currencies = ['EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'NZD'];
                        for (const curr of currencies) {
                                const data = economicData[curr];
                                if (data?.cotPositioning !== null && data?.cotPositioning !== undefined) {
                                    if (data.cotPositioningDate || data.lastUpdate) {
                                        const cotDate = new Date(data.cotPositioningDate || data.lastUpdate);
                        const daysAgo = Math.floor((Date.now() - cotDate.getTime()) / (24 * 60 * 60 * 1000));
                        return (
                            <span style={{ 
                                marginLeft: '0.5rem', 
                                fontSize: '0.75rem',
                                color: 'var(--text-tertiary)'
                            }}>
                                ({daysAgo === 0 ? 'Hoy' : daysAgo === 1 ? 'Ayer' : `${daysAgo}d`})
                            </span>
                        );
                    }
                    break;
                }
            }
            return null;
        })()}
    </div>
) : (
    <div className="info-item">
        <div style={{
            width: '8px',
            height: '8px',
            background: 'var(--text-tertiary)',
            borderRadius: '50%',
            opacity: 0.5
        }}></div>
        <span style={{ color: 'var(--text-tertiary)' }}>
            COT: Pr√≥x. Viernes
            {(() => {
                // Calcular d√≠as hasta el pr√≥ximo viernes
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0 = domingo, 5 = viernes
                let daysUntilFriday;
                
                if (dayOfWeek === 5) {
                    daysUntilFriday = 0;
                } else if (dayOfWeek < 5) {
                    daysUntilFriday = 5 - dayOfWeek;
                } else {
                    daysUntilFriday = 7 - dayOfWeek + 5;
                }
                
                if (daysUntilFriday === 0) return ' (hoy)';
                if (daysUntilFriday === 1) return ' (ma√±ana)';
                return ` (${daysUntilFriday}d)`;
            })()}
        </span>
    </div>
)}
</div>
                        </div>
                    </div>

                    <div className="nav-tabs">
                        <button className={`nav-tab ${activeTab === 'overview' ? 'active' : ''}`} onClick={() => setActiveTab('overview')}>Resumen de Divisas</button>
                        <button className={`nav-tab ${activeTab === 'heatmap' ? 'active' : ''}`} onClick={() => setActiveTab('heatmap')}>Mapa de Calor</button>
                        <button className={`nav-tab ${activeTab === 'trends' ? 'active' : ''}`} onClick={() => setActiveTab('trends')}>Tendencias Hist√≥ricas</button>
                        <button className={`nav-tab ${activeTab === 'calendar' ? 'active' : ''}`} onClick={() => setActiveTab('calendar')}>Calendario Econ√≥mico</button>
                        <button className={`nav-tab ${activeTab === 'alerts' ? 'active' : ''}`} onClick={() => setActiveTab('alerts')}>Mejores Pares</button>
                    </div>

                    <div className="content">
{activeTab === 'overview' && (
    <>
        <DataHealthCheck economicData={economicData} />
        
        <div className="section-header">
            <div className="section-title">Resumen de Divisas y An√°lisis Fundamental</div>
            <div className="section-meta">Ordenadas por fortaleza fundamental ‚Ä¢ Actualizado {lastUpdate ? lastUpdate.toLocaleDateString('es-ES') : ''}</div>
        </div>
        
        {Object.keys(economicData).length === 0 ? (
            <div style={{ textAlign: 'center', padding: '4rem', color: 'var(--text-secondary)' }}>
                Cargando datos econ√≥micos...
            </div>
        ) : (
            <div className="currency-grid">
                {getSortedCountries().map(country => {
                    const data = economicData[country.code] || {};
                    const strengthObj = calculateStrength(country.code, data, forexRates, economicData);
                    const strength = strengthObj.score;
                    const sentiment = getSentiment(strength);
                    const rate = country.code === 'USD' ? 1 : (forexRates[country.code] || 1);

                    return (
                        <div key={country.code} className="currency-card">
                            <div className="card-header">
                                <div className="card-title-section">
                                    <span className="card-flag flag-emoji">{country.flag}</span>
                                    <div>
                                        <div className="card-currency-code">{country.code}</div>
                                        <div className="card-currency-name">{country.currency}</div>
                                    </div>
                                </div>
                                <div className="card-strength">
                                    <div className="strength-score" style={{ 
                                        color: sentiment === 'alcista' ? 'var(--green-strong)' : 
                                               sentiment === 'bajista' ? 'var(--red-strong)' : 
                                               'var(--neutral)' 
                                    }}>
                                        {strength}
                                    </div>
                                    <div className="strength-label">Fortaleza</div>
                                </div>
                            </div>
                            <div className="card-body">
                                <div className="central-bank">
                                    <div className="bank-label">Banco Central</div>
                                    <div className="bank-name">{country.centralBank}</div>
                                    <div className="bank-info">
                                        <div className="bank-info-item">
                                            <div className="bank-info-label">Tasa</div>
                                            <div className="bank-info-value">{data.interestRate?.toFixed(2)}%</div>
                                        </div>
                                        <div className="bank-info-item">
                                            <div className="bank-info-label">Pr√≥xima Reuni√≥n</div>
                                            <div className="bank-info-value">{country.nextMeeting}</div>
                                        </div>
                                        <div className="bank-info-item">
                                            <div className="bank-info-label">Perspectiva</div>
                                            <div className="bank-info-value">{country.outlook}</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="metrics-grid">
                                    <div className="metric">
                                        <div className="metric-label">Crecimiento PIB</div>
                                        <div className="metric-value" style={{ 
                                            color: data.gdpGrowth !== null && data.gdpGrowth > 1.8 ? 'var(--green-strong)' : 
                                                   data.gdpGrowth !== null && data.gdpGrowth < 1.0 ? 'var(--red-strong)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {formatValue(data.gdpGrowth)}%
                                        </div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-label">Inflaci√≥n</div>
                                        <div className="metric-value" style={{ 
                                            color: data.inflation !== null && data.inflation >= 1.8 && data.inflation <= 2.5 ? 'var(--green-strong)' : 
                                                   data.inflation !== null && data.inflation > 3.5 ? 'var(--red-strong)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {formatValue(data.inflation)}%
                                        </div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-label">Desempleo</div>
                                        <div className="metric-value" style={{ 
                                            color: data.unemployment !== null && data.unemployment < 3.5 ? 'var(--green-strong)' : 
                                                   data.unemployment !== null && data.unemployment > 6 ? 'var(--red-strong)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {formatValue(data.unemployment)}%
                                        </div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-label">Cuenta Corriente</div>
                                        <div className="metric-value metric-value-small" style={{ 
                                            color: data.currentAccount !== null && data.currentAccount > 2 ? 'var(--green-strong)' : 
                                                   data.currentAccount !== null && data.currentAccount < -3 ? 'var(--red-strong)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {data.currentAccount !== null && data.currentAccount !== undefined 
                                                ? `${data.currentAccount > 0 ? '+' : ''}${formatValue(data.currentAccount)}%`
                                                : 'N/D'}
                                        </div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-label">Balanza Comercial</div>
                                        <div className="metric-value metric-value-small" style={{ 
                                            color: data.tradeBalance !== null && data.tradeBalance > 1000 ? 'var(--green-strong)' : 
                                                   data.tradeBalance !== null && data.tradeBalance < -10000 ? 'var(--red-strong)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {data.tradeBalance !== null && data.tradeBalance !== undefined 
                                                ? `${data.tradeBalance > 0 ? '+' : ''}${(data.tradeBalance / 1000).toFixed(1)}B`
                                                : 'N/D'}
                                        </div>
                                    </div>
                                    
                                    <div className="metric">
                                        <div className="metric-label">Ventas Minoristas</div>
                                        <div className="metric-value metric-value-small" style={{ 
                                            color: data.retailSales !== null && data.retailSales > 0.5 ? 'var(--green-strong)' : 
                                                   data.retailSales !== null && data.retailSales < -0.5 ? 'var(--red-strong)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {data.retailSales !== null && data.retailSales !== undefined 
                                                ? `${data.retailSales > 0 ? '+' : ''}${formatValue(data.retailSales)}%`
                                                : 'N/D'}
                                        </div>
                                    </div>

                                    <div className="metric">
                                        <div className="metric-label">Crecimiento Salarial</div>
                                        <div className="metric-value metric-value-small" style={{ 
                                            color: data.wageGrowth !== null && data.wageGrowth >= 2.5 && data.wageGrowth <= 4.5 ? 'var(--green-strong)' : 
                                                   data.wageGrowth !== null && data.wageGrowth > 5.5 ? 'var(--orange)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {formatValue(data.wageGrowth)}%
                                        </div>
                                    </div>

                                    <div className="metric">
                                        <div className="metric-label">PMI Manufacturero</div>
                                        <div className="metric-value metric-value-small" style={{ 
                                            color: data.manufacturingPMI !== null && data.manufacturingPMI > 50 ? 'var(--green-strong)' : 
                                                   data.manufacturingPMI !== null && data.manufacturingPMI < 50 ? 'var(--red-strong)' : 
                                                   'var(--text-primary)' 
                                        }}>
                                            {formatValue(data.manufacturingPMI, 1)}
                                        </div>
                                    </div>

                                    <div className="metric">
                                        <div className="metric-label">COT Positioning</div>
                                        <div className="metric-value metric-value-small" style={{ 
                                            color: data.cotPositioning !== null && data.cotPositioning > 10000 ? 'var(--green-strong)' : 
                                                   data.cotPositioning !== null && data.cotPositioning < -10000 ? 'var(--red-strong)' : 
                                                   data.cotPositioning !== null ? 'var(--text-primary)' :
                                                   'var(--text-tertiary)'
                                        }}>
                                            {data.cotPositioning !== null && data.cotPositioning !== undefined 
                                                ? `${data.cotPositioning > 0 ? '+' : ''}${(data.cotPositioning / 1000).toFixed(1)}K`
                                                : 'N/A'}
                                        </div>
                                    </div>
<div className="metric">
    <div className="metric-label">Bono 10Y</div>
    <div className="metric-value metric-value-small" style={{
        color: data.bond10y !== null && data.bond10y > 4.0 ? 'var(--green-strong)' :
               data.bond10y !== null && data.bond10y < 1.5 ? 'var(--red-strong)' :
               'var(--text-primary)'
    }}>
        {data.bond10y !== null && data.bond10y !== undefined
            ? `${formatValue(data.bond10y, 2)}%` : 'N/D'}
    </div>
</div>

<div className="metric">
    <div className="metric-label">Conf. Consumidor</div>
    <div className="metric-value metric-value-small" style={{
        color: data.consumerConfidence !== null && data.consumerConfidence > 100 ? 'var(--green-strong)' :
               data.consumerConfidence !== null && data.consumerConfidence < 95 ? 'var(--red-strong)' :
               'var(--text-primary)'
    }}>
        {formatValue(data.consumerConfidence, 1)}
    </div>
</div>

<div className="metric">
    <div className="metric-label">Conf. Empresarial</div>
    <div className="metric-value metric-value-small" style={{
        color: data.businessConfidence !== null && data.businessConfidence > 100 ? 'var(--green-strong)' :
               data.businessConfidence !== null && data.businessConfidence < 95 ? 'var(--red-strong)' :
               'var(--text-primary)'
    }}>
        {formatValue(data.businessConfidence, 1)}
    </div>
</div>

<div className="metric">
    <div className="metric-label">Flujos Capital</div>
    <div className="metric-value metric-value-small" style={{
        color: data.capitalFlows !== null && data.capitalFlows > 5000 ? 'var(--green-strong)' :
               data.capitalFlows !== null && data.capitalFlows < -5000 ? 'var(--red-strong)' :
               'var(--text-primary)'
    }}>
        {data.capitalFlows !== null && data.capitalFlows !== undefined
            ? `${data.capitalFlows > 0 ? '+' : ''}${(data.capitalFlows / 1000).toFixed(1)}B`
            : 'N/D'}
    </div>
</div>

<div className="metric">
    <div className="metric-label">Exp. Inflaci√≥n</div>
    <div className="metric-value metric-value-small" style={{
        color: data.inflationExpectations !== null && data.inflationExpectations >= 1.8 && data.inflationExpectations <= 2.5
            ? 'var(--green-strong)'
            : data.inflationExpectations !== null && data.inflationExpectations > 3.5
            ? 'var(--red-strong)' : 'var(--text-primary)'
    }}>
        {data.inflationExpectations !== null && data.inflationExpectations !== undefined
            ? `${formatValue(data.inflationExpectations, 1)}%` : 'N/D'}
    </div>
</div>

<div className="metric">
    <div className="metric-label">T√©rminos Intercambio</div>
    <div className="metric-value metric-value-small" style={{
        color: data.termsOfTrade !== null && data.termsOfTrade >= 103 ? 'var(--green-strong)' :
               data.termsOfTrade !== null && data.termsOfTrade < 97  ? 'var(--red-strong)' :
               'var(--text-primary)'
    }}>
        {data.termsOfTrade !== null && data.termsOfTrade !== undefined
            ? formatValue(data.termsOfTrade, 1) : 'N/D'}
    </div>
</div>
                                </div>

                                <div className="analysis-section">
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem' }}>
                                        <div className="analysis-title">An√°lisis Fundamental</div>
                                        <div className={`sentiment-badge sentiment-${sentiment}`}>
                                            <div className="sentiment-indicator" style={{ background: sentiment === 'alcista' ? 'var(--green-strong)' : sentiment === 'bajista' ? 'var(--red-strong)' : 'var(--neutral)' }}></div>
                                            {sentiment}
                                        </div>
                                    </div>
                                    <div className="analysis-text">{generateAnalysis(country.code, forexRates, economicData)}</div>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        )}
    </>
)}
                        {activeTab === 'heatmap' && (
    <div>
        <DataHealthCheck economicData={economicData} />
        
        <div className="section-header">
                                    <div className="section-title">Mapa de Calor de Indicadores Econ√≥micos</div>
                                </div>
                                <div className="heatmap-container">
                                    <table className="heatmap-table">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <TooltipCell title="S√≠ntesis General" tooltip="Evaluaci√≥n global de la fortaleza fundamental de la divisa.">
                                                    General<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>S√≠ntesis</span>
                                                </TooltipCell>
                                                <TooltipCell title="PIB Total" tooltip={indicatorTooltips.gdp}>
                                                    PIB<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>Trillones USD</span>
                                                </TooltipCell>
                                                <TooltipCell title="Crecimiento PIB" tooltip={indicatorTooltips.gdpGrowth}>
                                                    Crecimiento PIB<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>% Anual</span>
                                                </TooltipCell>
                                                <TooltipCell title="Tasa de Inter√©s" tooltip={indicatorTooltips.interestRate}>
                                                    Tasa de Inter√©s<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>%</span>
                                                </TooltipCell>
                                                <TooltipCell title="Inflaci√≥n" tooltip={indicatorTooltips.inflation}>
                                                    Inflaci√≥n<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>IPC %</span>
                                                </TooltipCell>
                                                <TooltipCell title="Desempleo" tooltip={indicatorTooltips.unemployment}>
                                                    Desempleo<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>%</span>
                                                </TooltipCell>
                                                <TooltipCell title="Cuenta Corriente" tooltip={indicatorTooltips.currentAccount}>
                                                    Cuenta Corriente<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>% del PIB</span>
                                                </TooltipCell>
                                                <TooltipCell title="Deuda P√∫blica" tooltip={indicatorTooltips.debt}>
                                                    Deuda P√∫blica<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>% del PIB</span>
                                                </TooltipCell>
                                                <TooltipCell title="Balanza Comercial" tooltip={indicatorTooltips.tradeBalance}>
                                                    Balanza Comercial<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>Miles Millones USD</span>
                                                </TooltipCell>
                                                <TooltipCell title="Producci√≥n Industrial" tooltip={indicatorTooltips.production}>
                                                    Prod. Industrial<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>% MoM / QoQ</span>
                                                </TooltipCell>
                                                <TooltipCell title="Ventas Minoristas" tooltip={indicatorTooltips.retailSales}>
    Ventas Minoristas<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>% MoM</span>
</TooltipCell>
<TooltipCell title="Crecimiento Salarial" tooltip={indicatorTooltips.wageGrowth}>
    Crecimiento Salarial<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>% YoY</span>
</TooltipCell>
<TooltipCell title="PMI Manufacturero" tooltip={indicatorTooltips.manufacturingPMI}>
    PMI Manufacturero<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>√çndice</span>
</TooltipCell>
<TooltipCell title="Posicionamiento COT" tooltip={indicatorTooltips.cotPositioning}>
    COT Positioning<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>Net Contratos</span>
</TooltipCell>
<TooltipCell title="Bono 10Y" tooltip={indicatorTooltips.bond10y}>
    Bono 10Y<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>Yield %</span>
</TooltipCell>
<TooltipCell title="Conf. Consumidor" tooltip={indicatorTooltips.consumerConfidence}>
    Conf. Consumidor<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>√çndice</span>
</TooltipCell>
<TooltipCell title="Conf. Empresarial" tooltip={indicatorTooltips.businessConfidence}>
    Conf. Empresarial<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>√çndice</span>
</TooltipCell>
<TooltipCell title="Flujos de Capital" tooltip={indicatorTooltips.capitalFlows}>
    Flujos Capital<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>MM USD</span>
</TooltipCell>
<TooltipCell title="Expectativas Inflaci√≥n" tooltip={indicatorTooltips.inflationExpectations}>
    Exp. Inflaci√≥n<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>%</span>
</TooltipCell>
<TooltipCell title="T√©rminos de Intercambio" tooltip={indicatorTooltips.termsOfTrade}>
    T√©rminos de Intercambio<br/><span style={{fontSize: '0.6rem', fontWeight: 400, color: 'var(--text-tertiary)'}}>√çndice base 100</span>
</TooltipCell>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getSortedCountries().map(country => {
                                                const data = economicData[country.code] || {};
                                                const strengthObj = calculateStrength(country.code, data, forexRates, economicData);  // ‚úÖ
const strength = strengthObj.score;  // ‚úÖ
const sentiment = getSentiment(strength);
                                                const overallColor = sentiment === 'alcista' ? 'var(--green-strong)' : sentiment === 'bajista' ? 'var(--red-strong)' : 'var(--neutral)';
                                                
                                                return (
                                                    <tr key={country.code}>
                                                        <td>
                                                            <div className="country-cell">
                                                                <span className="country-flag flag-emoji">{country.flag}</span>
                                                                <div className="country-info">
                                                                    <div className="country-name">{country.name}</div>
                                                                    <div className="country-currency">{country.code}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td style={{ background: 'var(--bg-card)' }}>
                                                            <div className="overall-cell">
                                                                <div className="overall-indicator" style={{ background: overallColor }}></div>
                                                                <span className="overall-label" style={{ color: overallColor }}>{sentiment}</span>
                                                            </div>
                                                        </td>
<HeatmapCell value={data.gdp} type="gdp" currency={country.code} indicator="gdp" lastUpdate={data.gdpDate} />
<HeatmapCell value={data.gdpGrowth} type="gdpGrowth" currency={country.code} indicator="gdpGrowth" lastUpdate={data.gdpGrowthDate} />
<HeatmapCell value={data.interestRate} type="interestRate" currency={country.code} indicator="interestRate" lastUpdate={data.interestRateDate} />
<HeatmapCell value={data.inflation} type="inflation" currency={country.code} indicator="inflation" lastUpdate={data.inflationDate} />
<HeatmapCell value={data.unemployment} type="unemployment" currency={country.code} indicator="unemployment" lastUpdate={data.unemploymentDate} />
<HeatmapCell value={data.currentAccount} type="currentAccount" currency={country.code} indicator="currentAccount" lastUpdate={data.currentAccountDate} />
<HeatmapCell value={data.debt} type="debt" currency={country.code} indicator="debt" lastUpdate={data.debtDate} />
<HeatmapCell value={data.tradeBalance} type="tradeBalance" currency={country.code} indicator="tradeBalance" lastUpdate={data.tradeBalanceDate} />
<HeatmapCell value={data.production} type="production" currency={country.code} indicator="production" lastUpdate={data.productionDate} />
<HeatmapCell value={data.retailSales} type="retailSales" currency={country.code} indicator="retailSales" lastUpdate={data.retailSalesDate} />
<HeatmapCell value={data.wageGrowth} type="wageGrowth" currency={country.code} indicator="wageGrowth" lastUpdate={data.wageGrowthDate} />
<HeatmapCell value={data.manufacturingPMI} type="manufacturingPMI" currency={country.code} indicator="manufacturingPMI" lastUpdate={data.manufacturingPMIDate} />
<HeatmapCell value={data.cotPositioning} type="cotPositioning" currency={country.code} indicator="cotPositioning" lastUpdate={data.cotPositioningDate} />
<HeatmapCell value={data.bond10y} type="bond10y" currency={country.code} indicator="bond10y" lastUpdate={data.bond10yDate} />
<HeatmapCell value={data.consumerConfidence} type="consumerConfidence" currency={country.code} indicator="consumerConfidence" lastUpdate={data.consumerConfidenceDate} />
<HeatmapCell value={data.businessConfidence} type="businessConfidence" currency={country.code} indicator="businessConfidence" lastUpdate={data.businessConfidenceDate} />
<HeatmapCell value={data.capitalFlows} type="capitalFlows" currency={country.code} indicator="capitalFlows" lastUpdate={data.capitalFlowsDate} />
<HeatmapCell value={data.inflationExpectations} type="inflationExpectations" currency={country.code} indicator="inflationExpectations" lastUpdate={data.inflationExpectationsDate} />
<HeatmapCell value={data.termsOfTrade} type="termsOfTrade" currency={country.code} indicator="termsOfTrade" lastUpdate={data.termsOfTradeDate} />
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'trends' && (
    <div>
        <DataHealthCheck economicData={economicData} />
        
        <div className="section-header">
                                    <div className="section-title">Tendencias Hist√≥ricas y An√°lisis de Datos</div>
                                </div>

                                <div style={{
                                    background: 'rgba(255, 111, 0, 0.08)',
                                    border: '1px solid rgba(255, 111, 0, 0.3)',
                                    borderRadius: '6px',
                                    padding: '0.875rem 1.25rem',
                                    marginBottom: '1.5rem',
                                    fontSize: '0.8125rem',
                                    color: 'var(--text-secondary)',
                                    lineHeight: '1.6'
                                }}>
                                    <strong style={{ color: 'var(--orange)' }}>‚ÑπÔ∏è Nota metodol√≥gica:</strong>{' '}
                                    La l√≠nea <strong>Tasa de Inter√©s</strong> refleja datos reales almacenados.
                                    El <strong>√çndice de Fortaleza hist√≥rico</strong> es una estimaci√≥n algor√≠tmica
                                    basada en el score actual con variaci√≥n simulada ‚Äî no representa datos hist√≥ricos reales.
                                    Para an√°lisis retrospectivo preciso, consulte las fuentes primarias (FRED, Trading Economics).
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(500px, 100%), 1fr))', gap: '1.5rem' }}>
                                    {countries.map(country => (
                                        <div key={country.code} className="chart-container">
                                            <div className="chart-wrapper">
                                                <canvas id={`chart-${country.code}`}></canvas>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

{activeTab === 'calendar' && (
                            <div>
                                <div className="section-header">
                                    <div className="section-title">Calendario Econ√≥mico</div>
                                    <div className="section-meta">
                                        {economicCalendar.source && economicCalendar.source !== 'fallback-generator'
                                            ? `Fuente: Trading Economics ‚Ä¢ Actualizado ${economicCalendar.lastUpdate || ''}`
                                            : 'Calendario estimado (scraping en proceso)'}
                                        {economicCalendar.impactCounts && economicCalendar.impactCounts.high > 0 && (
                                            <span style={{ marginLeft: '1rem' }}>
                                                üî¥ {economicCalendar.impactCounts.high} alto
                                                {economicCalendar.impactCounts.medium > 0 && ` ¬∑ üü† ${economicCalendar.impactCounts.medium} medio`}
                                            </span>
                                        )}
                                    </div>
                                </div>

                                {/* Filter bar */}
                                {(() => {
    const events = (economicCalendar.events || []);
    const filtered = calFilter === 'all'
        ? events
        : events.filter(e => e.impact === calFilter);

    return (
        <>
                                            <div style={{
                                                display: 'flex',
                                                gap: '0.5rem',
                                                marginBottom: '1rem',
                                                flexWrap: 'wrap'
                                            }}>
                                                {['all', 'high', 'medium', 'low'].map(f => (
                                                    <button
                                                        key={f}
                                                        onClick={() => setCalFilter(f)}
                                                        style={{
                                                            padding: '0.375rem 0.875rem',
                                                            borderRadius: '4px',
                                                            border: '1px solid var(--border)',
                                                            background: calFilter === f ? 'var(--blue)' : 'var(--bg-card)',
                                                            color: calFilter === f ? 'white' : 'var(--text-secondary)',
                                                            cursor: 'pointer',
                                                            fontSize: '0.8125rem',
                                                            fontWeight: 500,
                                                            transition: 'all 0.15s'
                                                        }}
                                                    >
                                                        {f === 'all'    ? 'Todos'       :
                                                         f === 'high'   ? 'üî¥ Alto'     :
                                                         f === 'medium' ? 'üü† Medio'    : '‚ö™ Bajo'}
                                                    </button>
                                                ))}
                                                <span style={{
                                                    marginLeft: 'auto',
                                                    fontSize: '0.75rem',
                                                    color: 'var(--text-tertiary)',
                                                    alignSelf: 'center'
                                                }}>
                                                    {filtered.length} eventos
                                                </span>
                                            </div>

                                            {filtered.length === 0 ? (
                                                <div style={{
                                                    textAlign: 'center',
                                                    padding: '3rem',
                                                    color: 'var(--text-secondary)',
                                                    background: 'var(--bg-secondary)',
                                                    borderRadius: '6px',
                                                    border: '1px solid var(--border)'
                                                }}>
                                                    {(economicCalendar.events || []).length === 0
                                                        ? 'Cargando calendario... El scraping se ejecuta a las 00:00, 08:00 y 16:00 UTC.'
                                                        : 'No hay eventos con ese filtro de impacto.'}
                                                </div>
                                            ) : (
                                                <div className="calendar-container">
                                                    {filtered.map((event, index) => {
                                                        const isToday = event.dateISO === new Date().toISOString().split('T')[0];
                                                        const hasActual = event.actual && event.actual !== '';
                                                        return (
                                                            <div key={index} className="calendar-event" style={{
                                                                borderLeft: isToday ? '3px solid var(--blue)' : 'none',
                                                                opacity: hasActual ? 0.75 : 1,
                                                            }}>
                                                                <div className="event-time">
                                                                    <div style={{ fontWeight: 600, fontSize: '0.875rem', color: isToday ? 'var(--blue)' : 'inherit' }}>
                                                                        {event.date}
                                                                    </div>
                                                                    <div>{event.time}</div>
                                                                </div>
                                                                <div className="event-details">
                                                                    <div className="event-title">{event.event}</div>
                                                                    <div className="event-country">
                                                                        <span className="flag-emoji">{event.flag}</span> {event.country || event.currency}
                                                                    </div>
                                                                    {(event.actual || event.forecast || event.previous) && (
                                                                        <div style={{
                                                                            display: 'flex',
                                                                            gap: '0.75rem',
                                                                            marginTop: '0.25rem',
                                                                            fontSize: '0.75rem',
                                                                            color: 'var(--text-tertiary)'
                                                                        }}>
                                                                            {event.actual   && <span>Real: <strong style={{ color: 'var(--green-strong)' }}>{event.actual}</strong></span>}
                                                                            {event.forecast && <span>Est: <strong style={{ color: 'var(--text-secondary)' }}>{event.forecast}</strong></span>}
                                                                            {event.previous && <span>Ant: {event.previous}</span>}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                <div className={`event-impact impact-${event.impact}`}>
                                                                    {event.impact === 'high'   ? 'Alto Impacto' :
                                                                     event.impact === 'medium' ? 'Medio' : 'Bajo'}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </>
                                    );
                                })()}
                            </div>
                        )}

{activeTab === 'alerts' && (
    <div>
        <div className="section-header">
            <div className="section-title">Mejores Pares de Divisas - An√°lisis Fundamental</div>
            <div className="section-meta">Basado en diferenciales de fortaleza fundamental</div>
        </div>
        
        <div style={{ 
    display: 'grid', 
    gridTemplateColumns: 'repeat(auto-fit, minmax(min(400px, 100%), 1fr))', 
    gap: '1.5rem' 
}}>
            {dynamicAlerts.map((rec, index) => (
                <div key={index} className="currency-card" style={{
                    borderLeft: `4px solid ${rec.type === 'long' ? 'var(--green-strong)' : 'var(--red-strong)'}`
                }}>
                    <div className="card-header" style={{ 
                        background: rec.type === 'long' ? 'rgba(38, 166, 154, 0.1)' : 'rgba(239, 83, 80, 0.1)' 
                    }}>
                        <div style={{ flex: 1 }}>
                            <div style={{ 
                                fontSize: '1.5rem', 
                                fontWeight: 700, 
                                marginBottom: '0.5rem',
                                color: 'var(--text-primary)'
                            }}>
                                {rec.pair}
                            </div>
                            <div style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '1rem' 
                            }}>
                                <span className={`sentiment-badge sentiment-${rec.type === 'long' ? 'alcista' : 'bajista'}`}>
                                    {rec.direction} - {rec.actionText}
                                </span>
                                <span style={{ 
                                    fontSize: '0.875rem', 
                                    color: 'var(--text-secondary)' 
                                }}>
                                    Confianza: {rec.confidence}
                                </span>
                            </div>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            <div style={{ 
                                fontSize: '2rem', 
                                fontWeight: 700,
                                color: rec.type === 'long' ? 'var(--green-strong)' : 'var(--red-strong)'
                            }}>
                                {rec.spread.toFixed(1)}
                            </div>
                            <div style={{ 
                                fontSize: '0.75rem', 
                                color: 'var(--text-tertiary)' 
                            }}>
                                Diferencial
                            </div>
                        </div>
                    </div>
                    
                    <div className="card-body">
                        {/* Fortalezas */}
                        <div style={{ marginBottom: '1.5rem' }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '0.75rem' 
                            }}>
                                <div style={{ 
                                    fontSize: '0.75rem', 
                                    fontWeight: 600, 
                                    color: 'var(--text-tertiary)',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.05em'
                                }}>
                                    Fortaleza: {rec.strongCurrency}
                                </div>
                                <div style={{ 
                                    fontSize: '1rem', 
                                    fontWeight: 700,
                                    color: 'var(--green-strong)'
                                }}>
                                    {rec.strength.toFixed(1)}
                                </div>
                            </div>
                            <div style={{ 
                                background: 'var(--bg-elevated)', 
                                padding: '0.75rem', 
                                borderRadius: '4px',
                                border: '1px solid var(--border)'
                            }}>
                                {rec.strongReasons.length > 0 ? (
                                    rec.strongReasons.map((reason, i) => (
                                        <div key={i} style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between',
                                            fontSize: '0.8125rem',
                                            padding: '0.25rem 0',
                                            color: 'var(--text-secondary)'
                                        }}>
                                            <span>‚Ä¢ {reason.factor}</span>
                                            <span style={{ 
                                                color: 'var(--green-strong)',
                                                fontWeight: 600 
                                            }}>
                                                +{reason.impact}
                                            </span>
                                        </div>
                                    ))
                                ) : (
                                    <div style={{ 
                                        fontSize: '0.8125rem',
                                        color: 'var(--text-tertiary)',
                                        fontStyle: 'italic'
                                    }}>
                                        Datos insuficientes
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Debilidades */}
                        <div style={{ marginBottom: '1.5rem' }}>
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                marginBottom: '0.75rem' 
                            }}>
                                <div style={{ 
                                    fontSize: '0.75rem', 
                                    fontWeight: 600, 
                                    color: 'var(--text-tertiary)',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.05em'
                                }}>
                                    Debilidad: {rec.weakCurrency}
                                </div>
                                <div style={{ 
                                    fontSize: '1rem', 
                                    fontWeight: 700,
                                    color: 'var(--red-strong)'
                                }}>
                                    {rec.weakness.toFixed(1)}
                                </div>
                            </div>
                            <div style={{ 
                                background: 'var(--bg-elevated)', 
                                padding: '0.75rem', 
                                borderRadius: '4px',
                                border: '1px solid var(--border)'
                            }}>
                                {rec.weakReasons.length > 0 ? (
                                    rec.weakReasons.map((reason, i) => (
                                        <div key={i} style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between',
                                            fontSize: '0.8125rem',
                                            padding: '0.25rem 0',
                                            color: 'var(--text-secondary)'
                                        }}>
                                            <span>‚Ä¢ {reason.factor}</span>
                                            <span style={{ 
                                                color: 'var(--red-strong)',
                                                fontWeight: 600 
                                            }}>
                                                {reason.impact}
                                            </span>
                                        </div>
                                    ))
                                ) : (
                                    <div style={{ 
                                        fontSize: '0.8125rem',
                                        color: 'var(--text-tertiary)',
                                        fontStyle: 'italic'
                                    }}>
                                        Datos insuficientes
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* An√°lisis */}
                        <div style={{ 
                            background: 'var(--bg-card)', 
                            padding: '1rem', 
                            borderRadius: '4px',
                            borderLeft: `3px solid ${rec.type === 'long' ? 'var(--green-strong)' : 'var(--red-strong)'}`,
                            fontSize: '0.875rem',
                            lineHeight: '1.6',
                            color: 'var(--text-secondary)'
                        }}>
                            <strong style={{ color: 'var(--text-primary)' }}>An√°lisis:</strong> 
                            {rec.type === 'long' ? (
                                <span> {rec.strongCurrency} muestra fundamentos superiores con un √≠ndice de fortaleza de {rec.strength.toFixed(1)} puntos, superando a {rec.weakCurrency} ({rec.weakness.toFixed(1)}) por un diferencial de {rec.spread.toFixed(1)} puntos. Este diferencial sugiere una oportunidad de compra (LONG) en {rec.pair}.</span>
                            ) : (
                                <span> {rec.weakCurrency} registra debilidad fundamental con {rec.weakness.toFixed(1)} puntos frente a la fortaleza de {rec.strongCurrency} ({rec.strength.toFixed(1)}), generando un diferencial de {rec.spread.toFixed(1)} puntos. Esto indica una oportunidad de venta (SHORT) en {rec.pair}.</span>
                            )}
                        </div>

                        {/* Data Quality Indicator */}
                        <div style={{ 
                            marginTop: '1rem',
                            fontSize: '0.75rem',
                            color: 'var(--text-tertiary)',
                            textAlign: 'center'
                        }}>
                            Calidad de datos: {(rec.dataQuality * 100).toFixed(0)}%
                        </div>
                    </div>
                </div>
            ))}
        </div>

        {/* Disclaimer */}
        <div style={{ 
            marginTop: '2rem',
            background: 'var(--bg-card)',
            border: '1px solid var(--border)',
            borderRadius: '6px',
            padding: '1.25rem',
            fontSize: '0.8125rem',
            lineHeight: '1.6',
            color: 'var(--text-secondary)'
        }}>
            <strong style={{ color: 'var(--text-primary)' }}>‚ö†Ô∏è Aviso Importante:</strong> Estas recomendaciones est√°n basadas exclusivamente en an√°lisis fundamental y no constituyen asesoramiento financiero. El trading de divisas conlleva riesgos significativos. Considere an√°lisis t√©cnico, gesti√≥n de riesgo y consulte con un asesor financiero antes de operar.
        </div>
    </div>
)}

<div className="footer">
    <div style={{ fontWeight: 600, marginBottom: '0.5rem' }}>
        DASHBOARD DE AN√ÅLISIS FUNDAMENTAL FOREX ‚Äî DATA-DRIVEN
    </div>
    <div style={{ marginBottom: '1rem' }}>
        Metodolog√≠a: Modelo cuantitativo basado en datos econ√≥micos reales ‚Ä¢ 20 indicadores ponderados en 6 tiers<br/>
        Balance Externo &amp; Safe Haven (27%) ‚Ä¢ Tasas &amp; Carry (26%) ‚Ä¢ Crecimiento &amp; Empleo (20%) ‚Ä¢ Consumo &amp; Salarios (9%) ‚Ä¢ Sentimiento de Mercado (15%) ‚Ä¢ FX Momentum (7%)<br/>
        Datos actualizados diariamente desde Trading Economics, Frankfurter/ECB y CFTC
    </div>

    <div style={{
        background: 'var(--bg-card)',
        padding: '1rem',
        borderRadius: '6px',
        border: '1px solid var(--border)',
        marginTop: '1rem',
        fontSize: '0.8125rem',
        lineHeight: '1.6'
    }}>
        <strong>Aviso Legal:</strong><br/>
        Este dashboard es una herramienta de an√°lisis cuantitativo con fines informativos y educativos.
        Los scores de fortaleza, rankings y recomendaciones de pares son c√°lculos basados en datos
        macroecon√≥micos p√∫blicos y no constituyen asesoramiento financiero ni se√±ales de trading.
        El trading de divisas (forex) conlleva riesgos significativos de p√©rdida de capital.
        Consulte con un asesor financiero certificado antes de tomar decisiones de inversi√≥n.
    </div>

    <div style={{ textAlign: 'center', marginTop: '1.5rem', paddingTop: '1.5rem', borderTop: '1px solid var(--border)' }}>
        <button onClick={() => window.clearForexCache && window.clearForexCache()} style={{
            padding: '10px 20px', background: 'var(--blue)', color: 'white', border: 'none',
            borderRadius: '6px', cursor: 'pointer', fontSize: '0.875rem', fontWeight: 600
        }}>
            Limpiar Cach√© y Recargar Datos
        </button>
        <div style={{ marginTop: '1rem', fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>
            ¬© {new Date().getFullYear()} Santiago Pl√° ¬∑ Global Investing. Todos los derechos reservados.
        </div>
        <div style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: 'var(--text-tertiary)' }}>
            Dashboard v4.9.6
        </div>
    </div>
</div>
                    </div>
                </div>
            );
        };
// Error Boundary para capturar crashes
class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
    }

    static getDerivedStateFromError(error) {
        return { hasError: true };
    }

    componentDidCatch(error, errorInfo) {
        console.error('üí• Dashboard crashed:', error, errorInfo);
        this.setState({ error, errorInfo });
        
        // Intentar limpiar cach√© corrupto
        try {
            CacheManager.clearAll();
            console.log('üßπ Cache cleared after crash');
        } catch (e) {
            console.error('Failed to clear cache:', e);
        }
    }

    render() {
        if (this.state.hasError) {
            return (
                <div className="app-container">
                    <div className="header">
                        <div className="header-content">
                            <div>
                                <div className="brand-title">An√°lisis Fundamental Forex</div>
                                <div className="brand-subtitle">Error del Sistema</div>
                            </div>
                        </div>
                    </div>
                    <div className="content">
                        <div className="alert-card alert-warning" style={{ maxWidth: '800px', margin: '2rem auto' }}>
                            <div className="alert-icon" style={{ 
                                background: 'rgba(239, 83, 80, 0.3)',
                                color: 'var(--red-strong)',
                                fontSize: '2rem'
                            }}>
                                üí•
                            </div>
                            <div className="alert-content">
                                <h3>El Dashboard ha Encontrado un Error</h3>
                                <p style={{ marginTop: '1rem', lineHeight: '1.7' }}>
                                    El sistema ha detectado un error cr√≠tico. Se ha limpiado el cach√© autom√°ticamente.
                                </p>
                                <p style={{ marginTop: '0.5rem', fontSize: '0.875rem', color: 'var(--text-secondary)' }}>
                                    <strong>Error:</strong> {this.state.error && this.state.error.toString()}
                                </p>
                                <button 
                                    onClick={() => window.location.reload()}
                                    style={{
                                        marginTop: '1.5rem',
                                        padding: '12px 24px',
                                        background: 'var(--blue)',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '0.875rem',
                                        fontWeight: 600
                                    }}
                                >
                                    Recargar Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        return this.props.children;
    }
}

ReactDOM.render(
    <ErrorBoundary>
        <ForexDashboard />
    </ErrorBoundary>,
    document.getElementById('root')
);
</script>
</body>
</html>
