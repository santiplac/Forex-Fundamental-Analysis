name: Update COT Data (Fixed - Actual Column)
on:
  schedule:
    - cron: '0 20 * * 5'  # Fridays at 8:00 PM UTC
  workflow_dispatch:

jobs:
  update-cot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml --break-system-packages
      
      - name: Create cot-data directory
        run: mkdir -p cot-data
      
      - name: Fetch COT data (Actual column)
        run: |
          python3 << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          import time

          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          }

          COT_URLS = {
              'EUR': 'https://www.investing.com/economic-calendar/cftc-eur-speculative-positions-1611',
              'GBP': 'https://www.investing.com/economic-calendar/cftc-gbp-speculative-positions-1612',
              'JPY': 'https://www.investing.com/economic-calendar/cftc-jpy-speculative-positions-1614',
              'AUD': 'https://www.investing.com/economic-calendar/cftc-aud-speculative-positions-1615',
              'CAD': 'https://www.investing.com/economic-calendar/cftc-cad-speculative-positions-1613',
              'CHF': 'https://www.investing.com/economic-calendar/cftc-chf-speculative-positions-1617',
              'NZD': 'https://www.investing.com/economic-calendar/cftc-nzd-speculative-positions-1616'
          }

          def clean_number(text):
              if not text or text.strip() == '':
                  return None
              text = text.strip()
              match = re.search(r'([+-]?\d+\.?\d*)\s*K', text, re.IGNORECASE)
              if match:
                  value = float(match.group(1))
                  return int(value * 1000)
              match = re.search(r'([+-]?\d+\.?\d*)', text)
              if match:
                  try:
                      return int(float(match.group(1)))
                  except:
                      pass
              return None

          def fetch_cot_from_investing(currency, url):
              print(f"\nFETCHING {currency}...")
              try:
                  response = requests.get(url, headers=HEADERS, timeout=20)
                  if not response.ok:
                      print(f"  HTTP {response.status_code}")
                      return None
                  
                  soup = BeautifulSoup(response.content, 'lxml')
                  
                  # METHOD 1: Find "Actual" in dt/dd pairs
                  dts = soup.find_all('dt')
                  dds = soup.find_all('dd')
                  for i, dt in enumerate(dts):
                      if 'actual' in dt.get_text(strip=True).lower():
                          if i < len(dds):
                              dd_text = dds[i].get_text(strip=True)
                              net_position = clean_number(dd_text)
                              if net_position is not None:
                                  print(f"  âœ… {net_position:+,} contracts (dt/dd)")
                                  return net_position
                  
                  # METHOD 2: Find elements with "actual" class/context
                  containers = soup.find_all(['div', 'span', 'td'])
                  for container in containers:
                      text = container.get_text(strip=True)
                      if re.search(r'[+-]?\d+\.?\d*K', text, re.IGNORECASE):
                          net_position = clean_number(text)
                          if net_position and -300000 <= net_position <= 300000:
                              parent_text = container.parent.get_text(strip=True).lower() if container.parent else ''
                              if 'actual' in parent_text:
                                  print(f"  âœ… {net_position:+,} contracts (context)")
                                  return net_position
                  
                  # METHOD 3: All K values as candidates
                  all_elements = soup.find_all(text=re.compile(r'[+-]?\d+\.?\d*K', re.IGNORECASE))
                  candidates = []
                  for element in all_elements:
                      net_position = clean_number(element.strip())
                      if net_position and -300000 <= net_position <= 300000:
                          candidates.append(net_position)
                  
                  if candidates:
                      print(f"  âœ… {candidates[0]:+,} contracts (first match)")
                      return candidates[0]
                  
                  print(f"  âŒ No data found")
                  return None
              except Exception as e:
                  print(f"  âŒ Error: {e}")
                  return None

          # MAIN
          print("="*60)
          print("COT DATA FETCHER - FIXED VERSION")
          print("="*60)

          cot_data = {}
          for currency, url in COT_URLS.items():
              net_position = fetch_cot_from_investing(currency, url)
              if net_position is not None:
                  cot_data[currency] = {
                      'netPosition': net_position,
                      'source': 'Investing.com',
                      'reportDate': str(date.today())
                  }
              time.sleep(2)

          print("\n" + "="*60)
          print("SAVING RESULTS")
          print("="*60)

          import os
          os.makedirs('cot-data', exist_ok=True)

          for currency, data in cot_data.items():
              with open(f'cot-data/{currency}.json', 'w') as f:
                  json.dump(data, f, indent=2)
              print(f"{currency}: {data['netPosition']:+,} contracts")

          if cot_data:
              print(f"\nâœ… Successfully saved {len(cot_data)} currencies")
          else:
              print("\nâš ï¸ No COT data obtained")
          EOFPYTHON
      
      - name: Display COT summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         COT POSITIONING SUMMARY                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          for currency in EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f "cot-data/$currency.json" ]; then
              echo "[$currency]"
              python3 -c "
          import json
          with open('cot-data/$currency.json') as f:
              data = json.load(f)
              print(f\"  Net Position: {data['netPosition']:+,} contracts\")
              print(f\"  Source: {data['source']}\")
              print(f\"  Report Date: {data['reportDate']}\")
          "
              echo ""
            else
              echo "[$currency] - No data available"
              echo ""
            fi
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add cot-data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š COT update $(date +'%Y-%m-%d') - Fixed Actual column extraction"
            git pull --rebase origin main || true
            git push
          fi
