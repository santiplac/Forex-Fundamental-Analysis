name: Update Extended Data (Bonds + Sentiment + Flows) - FIXED
on:
  schedule:
    - cron: '30 6 * * *'  # Daily at 6:30 AM UTC (runs AFTER economic data at 6:00)
  workflow_dispatch:

jobs:
  update-extended-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests beautifulsoup4 lxml --break-system-packages

      - name: Create directory
        run: mkdir -p extended-data

      - name: Scrape extended indicators
        run: |
          python3 << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json, re, os, time
          from datetime import date, datetime

          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          }

          CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']

          COUNTRY_NAMES = {
              'USD': ['United States'],
              'EUR': ['Euro Area'],
              'GBP': ['United Kingdom'],
              'JPY': ['Japan'],
              'CAD': ['Canada'],
              'AUD': ['Australia'],
              'CHF': ['Switzerland'],
              'NZD': ['New Zealand']
          }

          TE_URLS = {
              'bond10y':              'https://tradingeconomics.com/country-list/government-bond-yield',
              'consumerConfidence':   'https://tradingeconomics.com/country-list/consumer-confidence',
              'businessConfidence':   'https://tradingeconomics.com/country-list/business-confidence',
              'capitalFlows':         'https://tradingeconomics.com/country-list/capital-flows',
              'fdi':                  'https://tradingeconomics.com/country-list/foreign-direct-investment',
              'inflationExpectations':'https://tradingeconomics.com/country-list/inflation-expectations',
          }

          def clean_num(text):
              if not text: return None
              text = str(text).strip().replace(',','').replace('%','')
              m = re.search(r'(-?\d+\.?\d*)', text)
              return float(m.group(1)) if m else None

          def parse_te_date(date_text):
              if not date_text: return str(date.today())
              date_text = date_text.strip()
              try:
                  if re.search(r'[A-Za-z]{3}\s*[/\s]\s*\d{2,4}', date_text):
                      m = re.search(r'([A-Za-z]{3})\s*[/\s]\s*(\d{2,4})', date_text)
                      if m:
                          yr = m.group(2)
                          if len(yr) == 2: yr = '20' + yr
                          dt = datetime.strptime(f"{m.group(1)} {yr}", '%b %Y')
                          return dt.strftime('%Y-%m-15')
                  if re.search(r'Q\d[/\s]\d{4}', date_text):
                      m = re.search(r'Q(\d)[/\s](\d{4})', date_text)
                      if m:
                          month = (int(m.group(1)) - 1) * 3 + 2
                          return f"{m.group(2)}-{month:02d}-15"
              except: pass
              return str(date.today())

          def normalize_confidence(value, currency, indicator):
              """
              Normalize confidence indices to a comparable base-100 scale (100 = neutral).

              Scale mapping:
                EUR: European Commission -100/+100 ‚Üí add 100 (0 becomes 100)
                JPY: Cabinet Office ~35-50 range ‚Üí mapped to 85-115
                NZD: ANZ Business Outlook 0-100 ‚Üí already percentile-like,
                     remap so 0=50 (neutral), 100=150, -100=50 (index already 0-100
                     but neutral is ~0 for net balance). ANZ reports net % balance
                     (-100 to +100), same convention as EUR ‚Äî so add 100.
                GBP: CBI/GfK -100/+100 ‚Üí add 100
                Others: Base 100 scale (100 = neutral), pass through unchanged.
              """
              if value is None:
                  return None

              # European Commission scale: -100/+100 ‚Üí shift to 0/200 (100 = neutral)
              if currency == 'EUR' and indicator in ['consumerConfidence', 'businessConfidence']:
                  return round(value + 100, 2)

              # Japan Cabinet Office: typical range 35-50 ‚Üí map to 85-115
              if currency == 'JPY' and indicator == 'consumerConfidence':
                  normalized = ((value - 40) / 10) * 15 + 100
                  return round(normalized, 2)

              # ‚îÄ‚îÄ FIX 1: NZD Business Confidence (ANZ Business Outlook) ‚îÄ‚îÄ
              # ANZ reports net balance % (-100 to +100), same sign convention as EUR.
              # A reading of +64 means 64% more optimistic than pessimistic.
              # Shift to base-100 so scoring functions work correctly.
              if currency == 'NZD' and indicator == 'businessConfidence':
                  return round(value + 100, 2)    # e.g. +64.1 ‚Üí 164.1

              # GBP uses CBI Industrial Trends / GfK: net balance -100/+100 ‚Üí shift
              if currency == 'GBP' and indicator in ['consumerConfidence', 'businessConfidence']:
                  return round(value + 100, 2)    # e.g. -19 ‚Üí 81

              return value

          def scrape_te_table(url, label):
              print(f"\n{'='*50}\nSCRAPING: {label}\n{'='*50}")
              data, dates = {}, {}
              try:
                  r = requests.get(url, headers=HEADERS, timeout=20)
                  if r.status_code == 429:
                      print(f"  ‚ö†Ô∏è Rate limited by TE, waiting 30s...")
                      time.sleep(30)
                      r = requests.get(url, headers=HEADERS, timeout=20)
                  r.raise_for_status()

                  soup = BeautifulSoup(r.content, 'lxml')
                  table = soup.find('table', {'class': 'table'})
                  if not table:
                      print("  ‚ùå No table found"); return data, dates

                  headers_row = [h.get_text(strip=True).lower() for h in table.find_all('th')]
                  actual_idx = headers_row.index('actual') if 'actual' in headers_row else 1
                  date_idx   = headers_row.index('reference') if 'reference' in headers_row else None

                  for row in table.find_all('tr')[1:]:
                      cols = row.find_all('td')
                      if len(cols) < 2: continue
                      ctry = cols[0].get_text(strip=True)
                      for code, names in COUNTRY_NAMES.items():
                          if any(n.lower() in ctry.lower() for n in names):
                              val = clean_num(cols[actual_idx].get_text(strip=True))
                              dt  = parse_te_date(cols[date_idx].get_text(strip=True)) if date_idx and len(cols) > date_idx else str(date.today())
                              if val is not None:
                                  if label in ['consumerConfidence', 'businessConfidence']:
                                      val = normalize_confidence(val, code, label)
                                  data[code] = round(val, 4)
                                  dates[code] = dt
                                  print(f"  ‚úì {code}: {val} ({dt})")
                              break
              except Exception as e:
                  print(f"  ‚ùå {e}")
              return data, dates

          # ‚îÄ‚îÄ FIX 2: Bond yields ‚Äî TE live-price widget (no class="table") ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          #
          # PROBLEM: The TE /country-list/government-bond-yield page does NOT render
          # a <table class="table"> for the bond section when scraped server-side.
          # Instead, bond yields appear in a plain <table> inside a widget block
          # whose rows look like:
          #
          #   <td><a href="/united-states/...">United States</a></td>
          #   <td>4.1120</td>   ‚Üê Actual yield %
          #   <td>0.008</td>    ‚Üê Change
          #   <td>0.01%</td>    ‚Üê % Change
          #
          # The scraper must scan ALL tables, not just class="table", and apply a
          # sanity filter (0 < value < 20) to identify yield values.
          #
          # ALSO: worldgovernmentbonds.com fails silently in CI (dynamic JS content),
          # so TE is now the ONLY source.  The country-page fallback below handles
          # any individual currency that the widget table misses.

          def scrape_bonds_from_te(soup):
              """
              Extract bond yields from the TE bond page.
              TE renders the bond table as a plain <table> (no class="table") with
              columns: Country | Actual | Chg | %Chg
              """
              data, dates = {}, {}

              # Map of currency ‚Üí all possible country strings that TE might use
              BOND_NAMES = {
                  'USD': ['United States'],
                  'EUR': ['Germany'],        # EUR proxy = German 10Y Bund
                  'GBP': ['United Kingdom'],
                  'JPY': ['Japan'],
                  'CAD': ['Canada'],
                  'AUD': ['Australia'],
                  'CHF': ['Switzerland'],
                  'NZD': ['New Zealand'],
              }

              for table in soup.find_all('table'):
                  rows = table.find_all('tr')
                  for row in rows:
                      cols = row.find_all('td')
                      if len(cols) < 2:
                          continue
                      ctry_text = cols[0].get_text(strip=True)

                      for code, names in BOND_NAMES.items():
                          if code in data:
                              continue
                          if any(n.lower() in ctry_text.lower() for n in names):
                              # Try columns 1, 2, 3 for the actual yield value
                              for idx in [1, 2, 3]:
                                  if idx >= len(cols):
                                      continue
                                  val = clean_num(cols[idx].get_text(strip=True))
                                  if val is not None and 0 < val < 20:
                                      data[code] = round(val, 3)
                                      dates[code] = str(date.today())
                                      print(f"  ‚úì {code}: {val}% (TE widget table)")
                                      break
              return data, dates

          def scrape_bond_country_page_fallback(code):
              """
              If the main TE page misses a currency, fetch its individual country page.
              e.g. https://tradingeconomics.com/germany/government-bond-yield
              Returns (value, date_str) or (None, None).
              """
              COUNTRY_SLUGS = {
                  'USD': 'united-states',
                  'EUR': 'germany',          # EUR proxy = Bund
                  'GBP': 'united-kingdom',
                  'JPY': 'japan',
                  'CAD': 'canada',
                  'AUD': 'australia',
                  'CHF': 'switzerland',
                  'NZD': 'new-zealand',
              }
              slug = COUNTRY_SLUGS.get(code)
              if not slug:
                  return None, None

              url = f'https://tradingeconomics.com/{slug}/government-bond-yield'
              try:
                  r = requests.get(url, headers=HEADERS, timeout=15)
                  r.raise_for_status()
                  soup = BeautifulSoup(r.content, 'lxml')

                  # Look for the current value in the page header / card area
                  # TE country pages show the latest value in a <span> or <div>
                  # with class containing "symbol-last" or similar, or in a table.
                  for table in soup.find_all('table'):
                      for row in table.find_all('tr'):
                          cols = row.find_all('td')
                          for col in cols:
                              val = clean_num(col.get_text(strip=True))
                              if val is not None and 0 < val < 20:
                                  print(f"  ‚úì {code}: {val}% (country page fallback)")
                                  return round(val, 3), str(date.today())
              except Exception as e:
                  print(f"  ‚ùå Country page fallback for {code}: {e}")
              return None, None

          def scrape_bonds():
              """
              Primary bond scraping from TE /country-list/government-bond-yield.
              Falls back to individual country pages for any missing currencies.
              """
              print(f"\n{'='*50}\nBOND YIELDS: TradingEconomics (Fixed)\n{'='*50}")
              data, dates = {}, {}

              try:
                  r = requests.get(TE_URLS['bond10y'], headers=HEADERS, timeout=20)
                  if r.status_code == 429:
                      print(f"  ‚ö†Ô∏è Rate limited, waiting 30s...")
                      time.sleep(30)
                      r = requests.get(TE_URLS['bond10y'], headers=HEADERS, timeout=20)
                  r.raise_for_status()

                  soup = BeautifulSoup(r.content, 'lxml')

                  # Step 1: Try standard class="table" parser (works if TE renders it)
                  std_table = soup.find('table', {'class': 'table'})
                  if std_table:
                      print("  Found class='table' ‚Äî trying standard parser...")
                      headers_row = [h.get_text(strip=True).lower() for h in std_table.find_all('th')]
                      actual_idx = headers_row.index('actual') if 'actual' in headers_row else 1
                      date_idx   = headers_row.index('reference') if 'reference' in headers_row else None

                      BOND_NAMES = {
                          'USD': ['United States'],
                          'EUR': ['Germany'],
                          'GBP': ['United Kingdom'],
                          'JPY': ['Japan'],
                          'CAD': ['Canada'],
                          'AUD': ['Australia'],
                          'CHF': ['Switzerland'],
                          'NZD': ['New Zealand'],
                      }
                      for row in std_table.find_all('tr')[1:]:
                          cols = row.find_all('td')
                          if len(cols) < 2: continue
                          ctry = cols[0].get_text(strip=True)
                          for code, names in BOND_NAMES.items():
                              if any(n.lower() in ctry.lower() for n in names):
                                  val = clean_num(cols[actual_idx].get_text(strip=True))
                                  dt  = parse_te_date(cols[date_idx].get_text(strip=True)) if date_idx and len(cols) > date_idx else str(date.today())
                                  if val is not None and 0 < val < 20:
                                      data[code] = round(val, 3)
                                      dates[code] = dt
                                      print(f"  ‚úì {code}: {val}% (standard table)")
                                  break

                  # Step 2: If class="table" missing or incomplete, scan ALL tables
                  missing = [c for c in CURRENCIES if c not in data]
                  if missing:
                      print(f"  Scanning all tables for: {', '.join(missing)}")
                      widget_data, widget_dates = scrape_bonds_from_te(soup)
                      for code in missing:
                          if code in widget_data:
                              data[code]  = widget_data[code]
                              dates[code] = widget_dates[code]

              except Exception as e:
                  print(f"  ‚ùå TE bond page error: {e}")

              # Step 3: Country-page fallback for still-missing currencies
              still_missing = [c for c in CURRENCIES if c not in data]
              if still_missing:
                  print(f"\n  Country-page fallback for: {', '.join(still_missing)}")
                  for code in still_missing:
                      val, dt = scrape_bond_country_page_fallback(code)
                      if val is not None:
                          data[code]  = val
                          dates[code] = dt
                      time.sleep(1)

              return data, dates

          # ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          all_data  = {c: {} for c in CURRENCIES}
          all_dates = {c: {} for c in CURRENCIES}

          # 1. Bond yields (fixed scraper)
          bond_data, bond_dates = scrape_bonds()
          for c in CURRENCIES:
              all_data[c]['bond10y']  = bond_data.get(c)
              all_dates[c]['bond10y'] = bond_dates.get(c, str(date.today()))
          time.sleep(2)

          # 2-6. Remaining indicators
          for key, url in {k: v for k, v in TE_URLS.items() if k != 'bond10y'}.items():
              d, dt = scrape_te_table(url, key)
              for c in CURRENCIES:
                  all_data[c][key]  = d.get(c)
                  all_dates[c][key] = dt.get(c, str(date.today()))
              time.sleep(2)

          # Save
          for curr in CURRENCIES:
              pkg = {
                  'lastUpdate': str(date.today()),
                  'source': 'TradingEconomics (bonds fixed + NZD/GBP confidence normalized)',
                  'data':   all_data[curr],
                  'dates':  all_dates[curr]
              }
              with open(f'extended-data/{curr}.json', 'w') as f:
                  json.dump(pkg, f, indent=2)
              available = [k for k, v in all_data[curr].items() if v is not None]
              print(f"{'‚úÖ' if len(available) >= 4 else '‚ö†Ô∏è '} {curr}: {', '.join(available) or 'NO DATA'}")

          print("\n‚úÖ COMPLETE")
          EOFPYTHON

      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add extended-data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "üìä Extended data $(date +'%Y-%m-%d') ‚Äî bonds fixed + NZD/GBP confidence"
            git pull --rebase origin main || true
            git push
          fi
