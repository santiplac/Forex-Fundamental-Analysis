name: Update Interest Rates (Hybrid - Ultra Reliable)
on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8:00 AM UTC
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 --break-system-packages
      
      - name: Create rates directory
        run: mkdir -p rates
      
      - name: Fetch all rates
        run: |
          cat > fetch_rates.py << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          
          HEADERS = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
          
          def clean_rate(text):
              """Extract numeric rate from text"""
              match = re.search(r'(-?\d+\.?\d*)', str(text).replace(',', '.'))
              return match.group(1) if match else None
          
          def get_fred_rate(series_id, currency):
              """Fetch from FRED API"""
              try:
                  url = f"https://api.stlouisfed.org/fred/series/observations"
                  params = {
                      'series_id': series_id,
                      'api_key': '5e0ae2ba29361b8ddb614fd5f92c0a51',
                      'file_type': 'json',
                      'limit': 10,
                      'sort_order': 'desc'
                  }
                  r = requests.get(url, params=params, timeout=10)
                  data = r.json()
                  
                  for obs in data.get('observations', []):
                      val = obs.get('value')
                      if val and val not in ['.', 'null', None]:
                          print(f"âœ“ {currency}: {val}% (FRED-{series_id})")
                          return val, 'FRED'
              except Exception as e:
                  print(f"âš ï¸  {currency} FRED failed: {e}")
              return None, None
          
          def get_trading_economics_rate(currency):
              """Scrape from Trading Economics"""
              try:
                  url = "https://tradingeconomics.com/country-list/interest-rate"
                  r = requests.get(url, headers=HEADERS, timeout=10)
                  soup = BeautifulSoup(r.content, 'html.parser')
                  
                  country_map = {
                      'USD': 'United States',
                      'EUR': 'Euro Area',
                      'GBP': 'United Kingdom',
                      'JPY': 'Japan',
                      'CAD': 'Canada',
                      'AUD': 'Australia',
                      'CHF': 'Switzerland',
                      'NZD': 'New Zealand'
                  }
                  
                  country = country_map.get(currency)
                  if not country:
                      return None, None
                  
                  table = soup.find('table', {'class': 'table'})
                  if table:
                      for row in table.find_all('tr')[1:]:
                          cols = row.find_all('td')
                          if len(cols) >= 2:
                              if country in cols[0].get_text(strip=True):
                                  rate = clean_rate(cols[1].get_text(strip=True))
                                  if rate:
                                      print(f"âœ“ {currency}: {rate}% (TradingEconomics)")
                                      return rate, 'TradingEconomics'
              except Exception as e:
                  print(f"âš ï¸  {currency} TradingEconomics failed: {e}")
              return None, None
          
          def get_bank_of_canada():
              """Direct API from Bank of Canada"""
              try:
                  url = "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1"
                  r = requests.get(url, timeout=10)
                  data = r.json()
                  rate = data['observations'][0]['V39079']['v']
                  print(f"âœ“ CAD: {rate}% (BankOfCanada)")
                  return rate, 'BankOfCanada'
              except Exception as e:
                  print(f"âš ï¸  CAD BankOfCanada failed: {e}")
              return None, None
          
          def fetch_currency(currency, fred_series):
              """Fetch rate for a currency from multiple sources"""
              
              # Special case for CAD - try official API first
              if currency == 'CAD':
                  rate, source = get_bank_of_canada()
                  if rate:
                      return rate, source
              
              # Try FRED first
              rate, source = get_fred_rate(fred_series, currency)
              if rate:
                  return rate, source
              
              # Fallback to Trading Economics
              rate, source = get_trading_economics_rate(currency)
              if rate:
                  return rate, source
              
              # Last resort: check if previous value exists
              try:
                  with open(f'rates/{currency}.json', 'r') as f:
                      old_data = json.load(f)
                      old_rate = old_data['observations'][0]['value']
                      print(f"âš ï¸  {currency}: Using last known value: {old_rate}%")
                      return old_rate, 'LastKnown'
              except:
                  pass
              
              return None, None
          
          # Configuration for all currencies
          currencies = {
              'USD': 'DFF',
              'EUR': 'ECBDFR',
              'GBP': 'IUDSOIA',
              'JPY': 'IRSTCI01JPM156N',
              'CAD': 'IRSTCI01CAM156N',
              'AUD': 'IRSTCI01AUM156N',
              'CHF': 'IRSTCI01CHM156N',
              'NZD': 'IRSTCI01NZM156N'
          }
          
          print("=" * 70)
          print("FETCHING INTEREST RATES FROM MULTIPLE SOURCES")
          print("=" * 70)
          print()
          
          results = {}
          failed = []
          
          for currency, fred_series in currencies.items():
              print(f"\nğŸ” Fetching {currency}...")
              rate, source = fetch_currency(currency, fred_series)
              
              if rate:
                  results[currency] = {'value': rate, 'source': source}
              else:
                  failed.append(currency)
                  print(f"âŒ {currency}: ALL SOURCES FAILED")
          
          print()
          print("=" * 70)
          print("SAVING RESULTS")
          print("=" * 70)
          
          today = str(date.today())
          
          for currency, data in results.items():
              rate_data = {
                  'observations': [{
                      'value': data['value'],
                      'date': today,
                      'source': data['source']
                  }]
              }
              
              with open(f'rates/{currency}.json', 'w') as f:
                  json.dump(rate_data, f, indent=2)
              
              print(f"ğŸ’¾ {currency}: {data['value']}% from {data['source']}")
          
          print()
          print("=" * 70)
          print("VALIDATION")
          print("=" * 70)
          
          if failed:
              print(f"\nâŒ FAILED CURRENCIES: {', '.join(failed)}")
              print("\nWorkflow will FAIL to prevent saving incomplete data")
              exit(1)
          else:
              print("\nâœ… ALL 8 CURRENCIES FETCHED SUCCESSFULLY!")
              print("\nFinal Rates:")
              for curr in ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']:
                  if curr in results:
                      print(f"  {curr}: {results[curr]['value']}% ({results[curr]['source']})")
          
          EOFPYTHON
          
          python fetch_rates.py
      
      - name: Display formatted results
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           FINAL RATES (HYBRID METHOD)          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f "rates/$currency.json" ]; then
              echo "[$currency]"
              python3 -c "
          import json
          with open('rates/$currency.json') as f:
              data = json.load(f)
              obs = data['observations'][0]
              print(f\"  Rate: {obs['value']}%\")
              print(f\"  Date: {obs['date']}\")
              print(f\"  Source: {obs['source']}\")
          "
              echo ""
            fi
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ”„ Auto-update rates $(date +'%Y-%m-%d %H:%M UTC') - Hybrid sources" && git push)
