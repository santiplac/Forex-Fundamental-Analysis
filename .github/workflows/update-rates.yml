name: Update Interest Rates
on:
  schedule:
    - cron: '0 8 * * *'  # Todos los dÃ­as a las 8:00 AM UTC
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Create rates directory
        run: mkdir -p rates
      
      - name: Install jq for JSON processing
        run: sudo apt-get install -y jq
      
      # USD - Federal Reserve (FRED mejorado)
      - name: Fetch USD rate
        run: |
          # Intenta FRED con serie actualizada
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=FEDFUNDS&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          
          # Fallback: Trading Economics
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // "4.50"')
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/USD.json
      
      # EUR - European Central Bank
      - name: Fetch EUR rate
        run: |
          # ECB Statistical Data Warehouse
          RATE=$(curl -s "https://data.ecb.europa.eu/data-detail-api/FM.M.U2.EUR.4F.KR.MRR_FR.LEV" | jq -r '.dataSets[0].series."0:0:0:0:0:0:0".observations | to_entries | last | .value[0] // empty')
          
          # Fallback 1: FRED
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBDFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          fi
          
          # Fallback 2: Hardcoded current rate
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE="3.00"
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/EUR.json
      
      # GBP - Bank of England
      - name: Fetch GBP rate
        run: |
          # Bank of England API
          RATE=$(curl -s "https://www.bankofengland.co.uk/boeapps/database/fromshowcolumns.asp?Travel=NIxAZxSUx&FromSeries=1&ToSeries=50&DAT=RNG&FD=1&FM=Jan&FY=2024&TD=31&TM=Dec&TY=2026&FNY=Y&CSVF=TT&html.x=66&html.y=26&SeriesCodes=IUDBEDR&UsingCodes=Y&Filter=N&title=IUDBEDR&VPD=Y" | tail -n 1 | cut -d',' -f2 | tr -d ' ')
          
          # Fallback: FRED
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=BOERUKM&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // "4.75"')
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/GBP.json
      
      # JPY - Bank of Japan
      - name: Fetch JPY rate
        run: |
          # FRED actualizado
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=BOJIR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          
          # Fallback
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE="0.50"
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/JPY.json
      
      # AUD - Reserve Bank of Australia
      - name: Fetch AUD rate
        run: |
          # RBA RSS Feed parsing
          RATE=$(curl -s "https://www.rba.gov.au/rss/rss-cb-data.xml" | grep -oP '(?<=<description>).*?(?=</description>)' | grep "Cash Rate Target" | head -1 | grep -oP '\d+\.\d+' || echo "4.35")
          
          # Fallback: FRED
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=RBATCTR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // "4.35"')
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/AUD.json
      
      # CAD - Bank of Canada
      - name: Fetch CAD rate
        run: |
          # Bank of Canada Valet API
          RATE=$(curl -s "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1" | jq -r '.observations[0].V39079.v // empty')
          
          # Fallback: FRED
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=INTDSRCAM193N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // "3.25"')
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CAD.json
      
      # CHF - Swiss National Bank
      - name: Fetch CHF rate
        run: |
          # SNB Data Portal
          RATE=$(curl -s "https://data.snb.ch/api/cube/zirepo/data/csv/en?startPeriod=2024" | tail -n 1 | cut -d',' -f2 || echo "1.00")
          
          # Fallback
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE="1.00"
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CHF.json
      
      # NZD - Reserve Bank of New Zealand
      - name: Fetch NZD rate
        run: |
          # RBNZ via FRED
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=NZOCRS&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          
          # Fallback
          if [ -z "$RATE" ] || [ "$RATE" = "null" ]; then
            RATE="4.25"
          fi
          
          echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/NZD.json
      
      - name: Validate all rates
        run: |
          for file in rates/*.json; do
            echo "Validating $file"
            cat "$file"
            jq empty "$file" || echo "Invalid JSON in $file"
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update rates $(date +'%Y-%m-%d %H:%M UTC')" && git push)
