name: Update Interest Rates
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet
      
      - name: Create rates directory
        run: mkdir -p rates
      
      # USD - Federal Reserve
      - name: Fetch USD rate
        run: |
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          DATE=$(date +%Y-%m-%d)
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$DATE\"}]}" > rates/USD.json
          else
            echo "USD fetch failed, keeping existing file"
          fi
      
      # EUR - ECB
      - name: Fetch EUR rate
        run: |
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBMRRFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          DATE=$(date +%Y-%m-%d)
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$DATE\"}]}" > rates/EUR.json
          else
            echo "EUR fetch failed, keeping existing file"
          fi
      
      # GBP - Bank of England (scraping oficial)
      - name: Fetch GBP rate
        run: |
          # Try FRED first
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          
          # Validate date is recent
          if [ -n "$RATE" ] && [ "$RATE" != "null" ]; then
            RATE_DATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].date // "2000-01-01"')
            YEAR=$(echo $RATE_DATE | cut -d'-' -f1)
            
            if [ "$YEAR" -ge 2025 ]; then
              echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$RATE_DATE\"}]}" > rates/GBP.json
              echo "GBP: $RATE% from $RATE_DATE"
            else
              echo "GBP data too old, trying Bank of England scrape..."
              # Try scraping BoE website
              BoE_RATE=$(curl -s "https://www.bankofengland.co.uk/boeapps/database/Bank-Rate.asp" | grep -oP 'Rate is \K[\d.]+' | head -1 || echo "")
              
              if [ -n "$BoE_RATE" ]; then
                echo "{\"observations\":[{\"value\":\"$BoE_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/GBP.json
                echo "GBP from BoE scrape: $BoE_RATE%"
              else
                echo "GBP all sources failed, keeping existing file"
              fi
            fi
          else
            echo "GBP fetch failed, keeping existing file"
          fi
      
      # JPY - Bank of Japan (multi-source)
      - name: Fetch JPY rate
        run: |
          # Try Trading Economics scrape
          JPY_RATE=$(curl -s "https://tradingeconomics.com/japan/interest-rate" | grep -oP 'actual">\K[\d.]+' | head -1 || echo "")
          
          if [ -n "$JPY_RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$JPY_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/JPY.json
            echo "JPY from Trading Economics: $JPY_RATE%"
          else
            echo "JPY fetch failed, keeping existing file"
          fi
      
      # AUD - Reserve Bank of Australia RSS
      - name: Fetch AUD rate
        run: |
          AUD_RATE=$(curl -s "https://www.rba.gov.au/statistics/cash-rate/" | grep -oP 'Current cash rate target: \K[\d.]+' || echo "")
          
          if [ -n "$AUD_RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$AUD_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/AUD.json
            echo "AUD from RBA: $AUD_RATE%"
          else
            echo "AUD fetch failed, keeping existing file"
          fi
      
      # CAD - Bank of Canada Valet API
      - name: Fetch CAD rate
        run: |
          CAD_RATE=$(curl -s "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1" | jq -r '.observations[0].V39079.v // empty')
          
          if [ -n "$CAD_RATE" ] && [ "$CAD_RATE" != "null" ]; then
            echo "{\"observations\":[{\"value\":\"$CAD_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CAD.json
            echo "CAD from BoC: $CAD_RATE%"
          else
            echo "CAD fetch failed, keeping existing file"
          fi
      
      # CHF - Swiss National Bank
      - name: Fetch CHF rate
        run: |
          CHF_RATE=$(curl -s "https://data.snb.ch/en/topics/zirepo#!/cube/zirepo?fromDate=2024-01-01&toDate=$(date +%Y-%m-%d)" | grep -oP '"value":\K[\d.]+' | tail -1 || echo "")
          
          if [ -n "$CHF_RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$CHF_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CHF.json
            echo "CHF from SNB: $CHF_RATE%"
          else
            echo "CHF fetch failed, keeping existing file"
          fi
      
      # NZD - Reserve Bank of New Zealand
      - name: Fetch NZD rate
        run: |
          NZD_RATE=$(curl -s "https://www.rbnz.govt.nz/hub/news?type=ocr" | grep -oP 'OCR.*?(\d+\.\d+)%' | grep -oP '\d+\.\d+' | head -1 || echo "")
          
          if [ -n "$NZD_RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$NZD_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/NZD.json
            echo "NZD from RBNZ: $NZD_RATE%"
          else
            echo "NZD fetch failed, keeping existing file"
          fi
      
      - name: Display final rates
        run: |
          echo "=== FINAL RATES ==="
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f rates/$currency.json ]; then
              echo "=== $currency ==="
              jq -r '.observations[0] | "Value: \(.value)% | Date: \(.date)"' rates/$currency.json
            fi
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update rates $(date +'%Y-%m-%d %H:%M UTC')" && git push)
