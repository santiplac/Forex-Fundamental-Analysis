name: Update Interest Rates (Web Scraping - 100% Reliable)
on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8:00 AM UTC
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml --break-system-packages
      
      - name: Create rates directory
        run: mkdir -p rates
      
      - name: Fetch all rates with Python scraper
        run: |
          cat > fetch_rates.py << 'PYTHON_SCRIPT'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          import time
          
          # Headers to avoid blocking
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }
          
          def clean_rate(rate_str):
              """Extract numeric rate from string"""
              if not rate_str:
                  return None
              # Remove %, spaces, and extract number
              match = re.search(r'(-?\d+\.?\d*)', str(rate_str).replace(',', '.'))
              if match:
                  return match.group(1)
              return None
          
          def fetch_from_trading_economics():
              """Fetch rates from Trading Economics"""
              print("ğŸ“Š Fetching from Trading Economics...")
              url = "https://tradingeconomics.com/country-list/interest-rate"
              
              try:
                  response = requests.get(url, headers=HEADERS, timeout=10)
                  soup = BeautifulSoup(response.content, 'html.parser')
                  
                  rates = {}
                  table = soup.find('table', {'class': 'table'})
                  
                  if table:
                      rows = table.find_all('tr')[1:]  # Skip header
                      
                      country_map = {
                          'United States': 'USD',
                          'Euro Area': 'EUR',
                          'United Kingdom': 'GBP',
                          'Japan': 'JPY',
                          'Canada': 'CAD',
                          'Australia': 'AUD',
                          'Switzerland': 'CHF',
                          'New Zealand': 'NZD'
                      }
                      
                      for row in rows:
                          cols = row.find_all('td')
                          if len(cols) >= 2:
                              country = cols[0].get_text(strip=True)
                              rate = clean_rate(cols[1].get_text(strip=True))
                              
                              if country in country_map and rate:
                                  currency = country_map[country]
                                  rates[currency] = {
                                      'value': rate,
                                      'source': 'TradingEconomics'
                                  }
                                  print(f"  âœ“ {currency}: {rate}%")
                  
                  return rates
              except Exception as e:
                  print(f"  âŒ Trading Economics failed: {e}")
                  return {}
          
          def fetch_from_myfxbook():
              """Fetch rates from MyFxBook"""
              print("ğŸ“Š Fetching from MyFxBook...")
              url = "https://www.myfxbook.com/forex-economic-calendar/interest-rates"
              
              try:
                  response = requests.get(url, headers=HEADERS, timeout=10)
                  soup = BeautifulSoup(response.content, 'html.parser')
                  
                  rates = {}
                  # MyFxBook has a specific structure - adapt as needed
                  # This is a template that may need adjustment
                  
                  return rates
              except Exception as e:
                  print(f"  âŒ MyFxBook failed: {e}")
                  return {}
          
          def fetch_from_global_rates():
              """Fetch from global-rates.com"""
              print("ğŸ“Š Fetching from Global-Rates.com...")
              
              currency_urls = {
                  'USD': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-america/fed-interest-rate.aspx',
                  'EUR': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-europe/ecb-interest-rate.aspx',
                  'GBP': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-england/boe-interest-rate.aspx',
                  'JPY': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-japan/boj-interest-rate.aspx',
                  'CHF': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-switzerland/snb-interest-rate.aspx',
                  'CAD': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-canada/boc-interest-rate.aspx',
                  'AUD': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-australia/rba-interest-rate.aspx',
                  'NZD': 'https://www.global-rates.com/en/interest-rates/central-banks/central-bank-new-zealand/rbnz-interest-rate.aspx'
              }
              
              rates = {}
              for currency, url in currency_urls.items():
                  try:
                      response = requests.get(url, headers=HEADERS, timeout=10)
                      soup = BeautifulSoup(response.content, 'html.parser')
                      
                      # Look for the rate in common patterns
                      rate_elem = soup.find('td', string=re.compile(r'Current interest rate'))
                      if rate_elem:
                          rate_value = rate_elem.find_next_sibling('td')
                          if rate_value:
                              rate = clean_rate(rate_value.get_text(strip=True))
                              if rate:
                                  rates[currency] = {
                                      'value': rate,
                                      'source': 'GlobalRates'
                                  }
                                  print(f"  âœ“ {currency}: {rate}%")
                      
                      time.sleep(0.5)  # Be polite
                  except Exception as e:
                      print(f"  âš ï¸  {currency} failed from GlobalRates: {e}")
              
              return rates
          
          def fetch_from_fred():
              """Fetch from FRED API"""
              print("ğŸ“Š Fetching from FRED...")
              
              API_KEY = "5e0ae2ba29361b8ddb614fd5f92c0a51"
              
              series_map = {
                  'USD': 'DFF',
                  'EUR': 'ECBDFR',
                  'GBP': 'IUDSOIA',
                  'JPY': 'IRSTCI01JPM156N',
                  'CAD': 'IRSTCI01CAM156N',
                  'AUD': 'IRSTCI01AUM156N',
                  'CHF': 'IRSTCI01CHM156N',
                  'NZD': 'IRSTCI01NZM156N'
              }
              
              rates = {}
              for currency, series_id in series_map.items():
                  try:
                      url = f"https://api.stlouisfed.org/fred/series/observations?series_id={series_id}&api_key={API_KEY}&file_type=json&limit=10&sort_order=desc"
                      response = requests.get(url, timeout=10)
                      data = response.json()
                      
                      # Find first non-null value
                      for obs in data.get('observations', []):
                          value = obs.get('value')
                          if value and value != '.' and value != 'null':
                              rates[currency] = {
                                  'value': value,
                                  'source': 'FRED'
                              }
                              print(f"  âœ“ {currency}: {value}%")
                              break
                  except Exception as e:
                      print(f"  âš ï¸  {currency} failed from FRED: {e}")
              
              return rates
          
          def fetch_from_central_banks():
              """Fetch directly from central bank websites"""
              print("ğŸ“Š Fetching from Central Banks...")
              
              rates = {}
              
              # Bank of Canada (official API)
              try:
                  url = "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1"
                  response = requests.get(url, timeout=10)
                  data = response.json()
                  rate = data['observations'][0]['V39079']['v']
                  rates['CAD'] = {'value': rate, 'source': 'BankOfCanada'}
                  print(f"  âœ“ CAD: {rate}%")
              except Exception as e:
                  print(f"  âš ï¸  CAD failed from BoC: {e}")
              
              # Add more central banks as needed
              
              return rates
          
          def merge_rates(*sources):
              """Merge rates from multiple sources, prioritizing first sources"""
              merged = {}
              
              for source_rates in sources:
                  for currency, data in source_rates.items():
                      if currency not in merged:
                          merged[currency] = data
              
              return merged
          
          def save_rates(rates):
              """Save rates to JSON files"""
              today = str(date.today())
              
              for currency, data in rates.items():
                  rate_data = {
                      'observations': [{
                          'value': data['value'],
                          'date': today,
                          'source': data['source']
                      }]
                  }
                  
                  filename = f'rates/{currency}.json'
                  with open(filename, 'w') as f:
                      json.dump(rate_data, f, indent=2)
                  
                  print(f"ğŸ’¾ Saved {currency}: {data['value']}% from {data['source']}")
          
          # Main execution
          print("=" * 60)
          print("Starting rate fetch from multiple sources...")
          print("=" * 60)
          print()
          
          # Fetch from multiple sources in priority order
          trading_economics_rates = fetch_from_trading_economics()
          print()
          
          global_rates = fetch_from_global_rates()
          print()
          
          fred_rates = fetch_from_fred()
          print()
          
          central_bank_rates = fetch_from_central_banks()
          print()
          
          # Merge all rates (first source wins)
          final_rates = merge_rates(
              trading_economics_rates,
              central_bank_rates,
              global_rates,
              fred_rates
          )
          
          print()
          print("=" * 60)
          print("FINAL RATES:")
          print("=" * 60)
          
          # Save to files
          save_rates(final_rates)
          
          # Validation
          print()
          print("=" * 60)
          print("VALIDATION:")
          print("=" * 60)
          required = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']
          missing = [curr for curr in required if curr not in final_rates]
          
          if missing:
              print(f"âŒ MISSING CURRENCIES: {missing}")
              exit(1)
          else:
              print("âœ… All currencies fetched successfully!")
              for curr in required:
                  print(f"  {curr}: {final_rates[curr]['value']}% ({final_rates[curr]['source']})")
          
          PYTHON_SCRIPT
          
          python fetch_rates.py
      
      - name: Display final rates
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         FINAL RATES (WEB SCRAPING)             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f rates/$currency.json ]; then
              echo ""
              echo "[$currency]"
              cat rates/$currency.json | python3 -c "import sys, json; data = json.load(sys.stdin); print(f\"  Rate: {data['observations'][0]['value']}%\n  Date: {data['observations'][0]['date']}\n  Source: {data['observations'][0]['source']}\")"
            fi
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ”„ Auto-update rates $(date +'%Y-%m-%d %H:%M UTC') - Web scraping" && git push)
